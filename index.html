<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¥æ®¿è©¦ç…‰ v4.5.4 - å†’éšªæ¨¡å¼ç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap');
        
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #f5e6c8; /* [å¯ä¿®æ”¹] èƒŒæ™¯åº•è‰² */
            /* èƒŒæ™¯ç´‹ç† */
            background-image: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M11 18c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm48 25c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm-43-7c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm63 31c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM34 90c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm56-76c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM12 86c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm28-65c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm23-11c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-6 60c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm29 22c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zM32 63c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm57-13c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-9-21c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM60 91c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM35 41c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM12 60c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2z' fill='%23e6c677' fill-opacity='0.2' fill-rule='evenodd'/%3E%3C/svg%3E");
        }

        /* 3D å¡ç‰‡ç¿»è½‰æ•ˆæœ (èˆŠæœ‰) èˆ‡ æ€ªç‰©å¡ç‰Œç‰¹æ•ˆ (æ–°å¢) */
        .pyramid-card { perspective: 1000px; width: 100%; height: 100%; }
        .card-inner { position: relative; width: 100%; height: 100%; transition: transform 0.6s; transform-style: preserve-3d; }
        .card-front, .card-back { position: absolute; width: 100%; height: 100%; -webkit-backface-visibility: hidden; backface-visibility: hidden; display: flex; align-items: center; justify-content: center; border-radius: 0.5rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .card-back { transform: rotateY(180deg); }
        .flipped .card-inner { transform: rotateY(180deg); }

        /* [æ–°å¢] æ€ªç‰©å¡ç‰Œèˆå°èˆ‡ç‰¹æ•ˆ */
        .monster-stage { pointer-events: none; } /* è®“é»æ“Šç©¿é€ï¼Œä¸å½±éŸ¿ä¸‹æ–¹é‡‘å­—å¡” */
        .monster-slot { border: 2px dashed rgba(217, 119, 6, 0.3); background-color: rgba(255,255,255,0.1); border-radius: 0.5rem; }
        /* [æ–°å¢] æ€ªç‰©è¡€æ¢æ¨£å¼ */
        .monster-hp-wrap {
            position: absolute; bottom: 4px; left: 4px; right: 4px;
            height: 14px; background-color: rgba(0, 0, 0, 0.7);
            border-radius: 99px; overflow: hidden; border: 1px solid rgba(255, 255, 255, 0.5);
            z-index: 10; display: flex; align-items: center; justify-content: center;
        }
        .monster-hp-fill {
            position: absolute; top: 0; left: 0; height: 100%;
            background: linear-gradient(90deg, #ef4444, #dc2626); /* ç´…è‰²æ¼¸å±¤ */
            transition: width 0.3s ease; z-index: 1;
        }
        .monster-hp-text {
            position: relative; z-index: 2; font-size: 10px; font-weight: 900;
            color: #fff; text-shadow: 0 1px 2px rgba(0,0,0,1); font-family: 'Courier New', monospace;
            line-height: 1; letter-spacing: 0.5px;
        }
        /* æ€ªç‰©å¡ç‰‡æœ¬é«”è¨­å®š */
        .monster-card-wrapper { perspective: 1000px; position: absolute; transition: all 1.5s cubic-bezier(0.25, 1, 0.5, 1); z-index: 30; pointer-events: auto; cursor: pointer; }
        .monster-card-inner { position: relative; width: 100%; height: 100%; text-align: center; transition: transform 0.8s; transform-style: preserve-3d; }
        .monster-face { position: absolute; width: 100%; height: 100%; -webkit-backface-visibility: hidden; backface-visibility: hidden; border-radius: 0.5rem; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3); overflow: hidden; border: 2px solid #fff; }
        .monster-face-front { background-color: #1a202c; transform: rotateY(180deg); } /* æ­£é¢(æ€ªç‰©åœ–) */
        .monster-face-back { background-color: #78350f; transform: rotateY(0deg); } /* èƒŒé¢(å¡èƒŒ) */
        
        /* ç‹€æ…‹ï¼šå·²ç¿»é–‹ (é¡¯ç¤ºæ€ªç‰©) */
        .monster-card-wrapper.is-flipped .monster-card-inner { transform: rotateY(180deg); }
        
        /* ç‹€æ…‹ï¼šå·²ç§»å‹•åˆ°å³å´ (æˆ°é¬¥ä½) - [v4.3.3] ä¿®æ­£å®šä½èˆ‡é™°å½± */
        .monster-card-wrapper.is-in-battle { 
            top: 0.5rem !important; 
            left: calc(100% - 6rem - 0.5rem) !important; /* æ‰‹æ©Ÿç‰ˆï¼šé å³å®šä½ */
            transform: scale(1.05); 
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.5);
        }
        @media (min-width: 768px) {
            .monster-card-wrapper.is-in-battle {
                left: calc(100% - 7rem - 0.5rem) !important; /* é›»è…¦ç‰ˆï¼šé å³å®šä½ (å¡å¯¬7rem) */
            }
        }

        /* [å·²ä¿®æ”¹ v4.4] å‹•ç•«ï¼šæ”»æ“Šè¡åˆº - çªç ´é‚Šç•Œç‰ˆ */
        .monster-attacking { 
            /* æ™‚é–“å»¶é•·è‡³ 1.5s ä»¥ä¾¿å±•ç¤ºå®Œæ•´å‹•ä½œ */
            animation: attack-sequence 1.5s ease-in-out forwards; 
            z-index: 100; /* è¨­å®šæ¥µé«˜å±¤ç´šï¼Œç¢ºä¿é£›å‡ºæ¡†æ¡†æ™‚åœ¨æœ€ä¸Šå±¤ */
            position: relative; 
        }
        
        @keyframes attack-sequence { 
            0% { transform: translateX(0) scale(1); box-shadow: none; } 
            
            /* 30% é€€å¾Œï¼šå¤§å¹…å‘å·¦ç§»å‹•åˆ°æˆ°é¬¥å€å¤– (è² å€¼åŠ å¤§)ï¼Œç¸®å°è“„åŠ› */
            30% { transform: translateX(-150%) scale(0.9) rotate(-10deg); } 
            
            /* 50% è¡æ“Šï¼šå¤§å¹…å‘å³è¡åˆº (ç©¿éæˆ°é¬¥å€)ï¼Œæ”¾å¤§ä¸¦ç™¼å…‰ */
            50% { 
                transform: translateX(120%) scale(1.3) rotate(5deg); 
                box-shadow: 0 0 40px rgba(255, 0, 0, 1), 0 0 20px rgba(255, 100, 100, 0.9); 
                border-color: #ff3333 !important; 
            } 
            
            /* 80% åœé “ï¼šå±•ç¤ºæ”»æ“Šå§¿æ…‹ */
            80% { 
                transform: translateX(120%) scale(1.3) rotate(5deg); 
                box-shadow: 0 0 30px rgba(255, 0, 0, 0.9); 
            } 
            
            /* 100% è¿”å›ï¼šè¿…é€Ÿå›åˆ°åŸé» */
            100% { transform: translateX(0) scale(1); box-shadow: none; } 
        }

        .monster-damaged { animation: damage-flash 0.5s ease-in-out; }
        @keyframes damage-flash { 0%, 100% { filter: none; transform: scale(1.05); } 10%, 30%, 50%, 70%, 90% { transform: scale(1.05) translate(-2px, 0); } 20%, 40%, 60%, 80% { transform: scale(1.05) translate(2px, 0); } 50% { filter: sepia(1) saturate(5) hue-rotate(-50deg) brightness(1.2); } }
        
        /* éª°å­å‹•ç•« */
        .dice { transition: transform 0.5s ease-out; }
        .dice.rolling { animation: diceRoll 0.5s ease-in-out; }
        @keyframes diceRoll { 0%{transform:rotateX(0) rotateY(0) rotateZ(0)} 50%{transform:rotateX(720deg) rotateY(360deg) rotateZ(180deg)} 100%{transform:rotateX(0) rotateY(0) rotateZ(0)} }
        
        /* ç©å®¶ç•¶å‰ç‹€æ…‹èˆ‡å¡ç‰‡ç©ºä½ */
        .card-placeholder { border: 2px dashed #d4a85a; border-radius: 0.5rem; background-color: rgba(255,255,255,0.2); }
        .player-card { transition: all 0.3s ease; }
        .player-card:hover { transform: translateY(-3px); }
        .current-player { box-shadow: 0 0 0 4px rgba(245, 158, 11, 0.5); border-color: #d97706; }
        
        /* äº’å‹•ç‹€æ…‹æ¨£å¼ */
        .selected-for-action { box-shadow: 0 0 15px 5px rgba(34, 197, 94, 0.7); border: 2px solid #16a34a; transform: scale(1.02); }
        .selected-card-ring { box-shadow: 0 0 0 4px #ef4444; transform: scale(1.05); z-index: 10; }
        
       /* v3.4.0 æ™‚ä¹‹æ²™ç‰¹æ•ˆ */
        .frozen-mode { filter: grayscale(100%) contrast(0.8); pointer-events: none; transition: filter 0.5s; }
        .frozen-timer-overlay {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            font-size: 3rem; font-weight: 900; color: #3b82f6; /* è—è‰²ç²—é«” */
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.8), 2px 2px 0 #1e3a8a;
            z-index: 50; white-space: nowrap; pointer-events: none;
            animation: pulse-blue 1s infinite;
        }
        .frozen-icon { font-size: 4rem; display: block; margin-bottom: -1rem; filter: drop-shadow(0 0 10px #60a5fa); }
        @keyframes pulse-blue { 0%, 100% { transform: translate(-50%, -50%) scale(1); opacity: 1; } 50% { transform: translate(-50%, -50%) scale(1.1); opacity: 0.8; } }

        /* å€’æ•¸è¨ˆæ™‚ç·Šæ€¥ç‹€æ…‹å‹•ç•« (æ¼‚æµ® + æ”¾å¤§) */
        @keyframes urgentFloat { 0%, 100% { transform: translateY(0) scale(1.2); } 50% { transform: translateY(-5px) scale(1.3); } }
        .timer-urgent { animation: urgentFloat 1s ease-in-out infinite; color: #dc2626 !important; text-shadow: 2px 2px 0px #fff; }

        .edit-name-icon { cursor: pointer; user-select: none; margin-left: 8px; display: inline-block; opacity: 0.5; transition: opacity 0.2s; }
        .edit-name-icon:hover { opacity: 1; }
        
        .clickable-dice { cursor: pointer; transition: background-color 0.2s; }
        .clickable-dice:hover { background-color: #fceecb; transform: scale(1.05); }
        
        /* è¨Šæ¯çª—å¼·èª¿æ¨£å¼ */
        .message-highlight { color: #b45309; font-weight: 800; }
        
        /* Modal èƒŒæ™¯æ¨¡ç³Š */
        .modal-backdrop { background-color: rgba(0, 0, 0, 0.6); backdrop-filter: blur(4px); z-index: 50; }
        
        /* v3.0 æ–°å¢æ¨£å¼ */
        .role-card { transition: all 0.3s ease; cursor: pointer; border: 3px solid transparent; }
        .role-card:hover { transform: translateY(-5px); border-color: #d97706; background-color: #fffbeb; }
        
        /* å¹³æ¿å„ªåŒ–ä½ˆå±€ */
        .tablet-layout { display: flex; flex-direction: column; gap: 1rem; }
        @media (min-width: 1024px) {
            .tablet-layout { flex-direction: row; align-items: flex-start; }
            .tablet-left { width: 45%; flex-shrink: 0; }
            .tablet-right { width: 55%; flex-grow: 1; }
        }

        /* è¼¸å…¥æ¸¸æ¨™æ¨¡æ“¬ */
        .cursor-control-btn { touch-action: manipulation; }
        .cursor-control-btn:active { background-color: #d97706; transform: scale(0.95); }

        /* éš±è—åŸç”Ÿéµç›¤ä½†ä¿ç•™æ¸¸æ¨™ (é€é readonly é…åˆ JS) */
        .formula-input-readonly { caret-color: #d97706; cursor: text; }
        
        /* v3.2.9 æ–°å¢ï¼šè‡ªå‹•æ“²éª°é–‹é—œæ¨£å¼ */
        .switch { position: relative; display: inline-block; width: 50px; height: 26px; vertical-align: middle; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #d97706; }
        input:focus + .slider { box-shadow: 0 0 1px #d97706; }
        input:checked + .slider:before { transform: translateX(24px); }
        /* --- v4.0.1 æ–°å¢æ¨£å¼: å†’éšªå¤§å»³èˆ‡ç®¡ç†å“¡ --- */
        .lobby-card { background: rgba(255, 255, 255, 0.95); border-radius: 1.5rem; box-shadow: 0 10px 25px rgba(180, 83, 9, 0.2); border: 4px solid #d97706; transition: transform 0.3s; }
        .lobby-card:hover { transform: translateY(-5px); }
        .admin-gear { position: fixed; top: 1rem; right: 1rem; font-size: 1.5rem; cursor: pointer; z-index: 60; background: rgba(255,255,255,0.8); padding: 0.5rem; border-radius: 50%; border: 2px solid #b45309; transition: all 0.3s; }
        .admin-gear:hover { transform: rotate(90deg) scale(1.1); background: #fff; }
        .room-item { background: white; border: 2px solid #fcd34d; border-radius: 1rem; padding: 1rem; transition: all 0.2s; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        .room-item:hover { border-color: #d97706; background: #fffbeb; transform: translateX(5px); }
        /* éš±è—ä¸æƒ³é¡¯ç¤ºçš„å…ƒç´ ä½†ä¿ç•™é‚è¼¯ */
        .hidden-logic { display: none !important; }
        /* ç™»å…¥éå ´ */
        .fade-in { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
/* --- v3.2.0 é“å…·ç³»çµ±æ¨£å¼ --- */
        .item-slot { position: relative; cursor: pointer; transition: all 0.2s; }
        .item-slot:hover { transform: scale(1.1); }
        .item-icon { font-size: 2rem; filter: drop-shadow(0 2px 2px rgba(0,0,0,0.2)); }
        .item-count { position: absolute; bottom: -5px; right: -5px; background: #dc2626; color: white; font-size: 0.7rem; font-weight: bold; width: 1.2rem; height: 1.2rem; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 2px solid white; }
        .item-active { animation: pulse-gold 1.5s infinite; filter: drop-shadow(0 0 5px #fbbf24); }
        @keyframes pulse-gold { 0% { transform: scale(1); } 50% { transform: scale(1.1); filter: drop-shadow(0 0 10px #fbbf24); } 100% { transform: scale(1); } }
        /* è€å¸«ç™¼æ”¾é“å…·æŒ‰éˆ• */
        .grant-btn { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 0.5rem; border-radius: 0.5rem; border: 2px solid #e5e7eb; transition: all 0.2s; }
        .grant-btn:hover { background-color: #fffbeb; border-color: #d97706; transform: translateY(-2px); }
        .grant-btn:active { transform: scale(0.95); }
        /* å­¸ç”Ÿçµ„åˆ¥æŒ‰éˆ• */
        .team-btn { transition: all 0.2s; }
        .team-btn.selected { ring: 4px; ring-color: #d97706; transform: scale(1.05); background-color: #fffbeb; }

        /* v3.0.5 æ–°å¢ï¼šæŒ‰éˆ•é–å®šç‹€æ…‹ */
        .btn-disabled { background-color: #9ca3af !important; background-image: none !important; cursor: not-allowed; transform: none !important; box-shadow: none !important; opacity: 0.7; }
        
        /* v3.0.5 æ–°å¢ï¼šåŠ å¤§é‡‘å­—å¡”æ•¸å­—èˆ‡é‚Šæ¡† */
        .pyramid-num-lg { font-size: 2.5rem; line-height: 1; } 
        @media (min-width: 768px) { .pyramid-num-lg { font-size: 3.5rem; } }

        /* v3.0.8 æ–°å¢æ¨£å¼ */
        /* 1. æ¨¡æ“¬è¼¸å…¥æ¡†èˆ‡æ¸¸æ¨™ */
        .fake-input-container {
            min-height: 3.5rem;
            display: flex; align-items: center; justify-content: center;
            background-color: #f8fafc; border: 2px solid #c7d2fe; border-radius: 0.5rem;
            font-size: 1.5rem; font-weight: 700; letter-spacing: 0.1em;
            overflow-x: auto; white-space: nowrap; cursor: text;
        }
        .cursor-blink {
            display: inline-block; width: 2px; height: 1.5em; background-color: #d97706;
            margin: 0 2px; vertical-align: middle;
            animation: blink-animation 1s step-end infinite;
        }
        @keyframes blink-animation { 0%, 100% { opacity: 1; } 50% { opacity: 0; } }

        /* 2. æ”¾å¤§ç‰Œåº«å‰©é¤˜é¡¯ç¤º */
        .deck-count-box { font-size: 1.1rem; padding: 0.5rem; }
        .deck-count-num { font-size: 1.5rem; font-weight: 900; margin-left: 4px; }

       /* 3. è€å¸«ä»‹é¢æ“´å…… (ä¸‰æ¬„ä½ˆå±€) */
        /* [v4.1.4] åŠ å…¥ min-height è®“ä¸»æ§è€…å¯ä»¥çœ‹åˆ°æ›´é•·çš„åå–® */
        .teacher-panel-grid { display: grid; gap: 1rem; height: 100%; min-height: 240px; /* [å¯ä¿®æ”¹] èª¿æ•´æ­¤æ•¸å€¼å¯æ‹‰é•·åˆ—è¡¨é«˜åº¦ */ }
        @media (min-width: 1024px) {
            /* [å¯ä¿®æ”¹] åœ¨å¤§è¢å¹•ä¸‹ï¼Œå·¦é‚Š(æ§åˆ¶å°) 2frï¼Œå³é‚Š(å†’éšªå°éšŠ) 3fr -> è‹¥è¦æ›´å¯¬å¯æ”¹ç‚º 1.5fr 3.5fr */
            .teacher-panel-grid { grid-template-columns: 2fr 3fr; }
        }
        
        /* [æ–°å¢] å†’éšªå°éšŠåˆ—è¡¨å®¹å™¨æ¨£å¼ - æ§åˆ¶é¡¯ç¤ºé«˜åº¦ */
        /* height: 200px å¤§ç´„æ˜¯å¯ä»¥é¡¯ç¤º 3 äººçš„é«˜åº¦ï¼Œè¶…éæœƒå‡ºç¾å·è»¸ */
        .squad-board-container { 
            height: 170px; 
            overflow-y: auto;
            overflow-x: hidden; /* [v4.1.4] å¼·åˆ¶éš±è—æ©«å‘æ²è»¸ */
            background-color: rgba(255, 255, 255, 0.5); 
            border-radius: 0.75rem;
            border: 1px solid #fcd34d;
        }

        /* 4. å°çµ„è©³æƒ… Modal */
        .team-detail-row { display: flex; justify-content: space-between; border-bottom: 1px solid #eee; padding: 8px 0; }
        
        /* 5. å­¸ç”Ÿåˆ†æ•¸é¢æ¿ */
        .student-score-pill { background: #fffbeb; border: 2px solid #fcd34d; color: #92400e; padding: 4px 12px; border-radius: 999px; font-weight: bold; font-size: 0.9rem; display: inline-flex; items-center; gap: 4px; box-shadow: 0 2px 0 rgba(217,119,6,0.2); }
		/* v4.1.8 ç®¡ç†å“¡åˆ†é æ¨£å¼ */
        .admin-tab-btn { padding: 0.5rem 1rem; font-weight: bold; color: #64748b; border-bottom: 3px solid transparent; transition: all 0.3s; }
        .admin-tab-btn:hover { color: #d97706; background-color: #fffbeb; border-radius: 0.5rem 0.5rem 0 0; }
        .admin-tab-active { color: #b45309; border-bottom-color: #b45309; }
        .admin-tab-content { display: none; animation: fadeIn 0.3s ease-out; }
        .admin-tab-content.active { display: block; }
		/* v3.0.9 æ–°å¢ï¼šé€šé—œç•«é¢èˆ‡æ’è¡Œæ¦œ */
        .game-over-modal-content {
            background: linear-gradient(135deg, #fffbeb 0%, #fff7ed 100%);
            border: 4px solid #b45309;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        @keyframes popIn { 0% { opacity: 0; transform: scale(0.8); } 100% { opacity: 1; transform: scale(1); } }
        
        .rank-badge { display: inline-flex; width: 2rem; height: 2rem; align-items: center; justify-content: center; border-radius: 50%; font-weight: 900; margin-right: 0.5rem; flex-shrink: 0; }
        .rank-1 { background: #fcd34d; color: #78350f; border: 2px solid #b45309; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        .rank-2 { background: #e2e8f0; color: #475569; border: 2px solid #94a3b8; }
        .rank-3 { background: #ffedd5; color: #9a3412; border: 2px solid #c2410c; }
        .rank-other { background: #f3f4f6; color: #6b7280; font-size: 0.8rem; width: 1.5rem; height: 1.5rem; }
        
        .confetti-piece { position: absolute; width: 10px; height: 10px; background-color: #ffd700; animation: confetti-fall 3s linear infinite; }
        @keyframes confetti-fall { 0% { transform: translateY(-100%) rotate(0deg); opacity: 1; } 100% { transform: translateY(100vh) rotate(720deg); opacity: 0; } }
/* æ€ªç‰©å—æ“Šéœ‡å‹•å‹•ç•« */
        @keyframes shake {
            0%, 100% { transform: translate(0, 0) rotate(0deg); }
            10%, 30%, 50%, 70%, 90% { transform: translate(-5px, 0) rotate(-5deg); }
            20%, 40%, 60%, 80% { transform: translate(5px, 0) rotate(5deg); }
        }
        .animate-shake {
            animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both;
        }
</style>    
	<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
</head>
<body class="min-h-screen pb-12 text-slate-800">
    <div class="container mx-auto px-4 py-8 max-w-7xl">
        <div class="text-center mb-6 relative">
            <h1 class="text-3xl md:text-5xl font-black text-amber-800 mb-2 drop-shadow-sm tracking-wide">ğŸº ç¥æ®¿è©¦ç…‰ v4.5.4 - å†’éšªæ¨¡å¼ç‰ˆ</h1>
            <p class="text-lg text-amber-700 font-medium">é€£ç·šç‰ˆ - å¤åŸƒåŠæ•¸å­¸è©¦ç…‰</p>
            <div id="connection-status" class="absolute top-0 right-0 text-xs font-mono text-gray-400">é€£ç·šä¸­...</div>
        </div>
        
        <div id="admin-gear-btn" class="admin-gear shadow-lg" onclick="app.openAdminAuth()" title="ç®¡ç†å“¡è¨­å®š">âš™ï¸</div>

        <div id="page-lobby" class="max-w-6xl mx-auto fade-in">
            <div class="grid md:grid-cols-12 gap-6">
                <div class="md:col-span-4 space-y-6">
                    <div class="lobby-card p-6 text-center relative overflow-hidden">
                        <div id="auth-panel-logged-in" class="hidden flex-col items-center animate-[fadeIn_0.5s_ease-out]">
                             <img id="user-avatar" src="" class="w-24 h-24 rounded-full border-4 border-amber-400 shadow-lg mb-4 object-cover" alt="Avatar">
                             <div class="text-sm text-gray-500 font-bold mb-1">æ­¡è¿å›ä¾†</div>
                             <div id="auth-name-display-area" class="flex items-center justify-center gap-2 mb-4 w-full">
                                 <h2 id="user-display-name" class="text-2xl font-black text-amber-900 truncate max-w-[200px]">å†’éšªè€…</h2>
                                 <button onclick="app.toggleEditName()" class="text-gray-400 hover:text-amber-600 p-1 rounded-full transition-colors" title="ä¿®æ”¹åç¨±">âœï¸</button>
                             </div>

                             <div id="auth-name-edit-area" class="hidden flex-col items-center gap-2 mb-4 w-full animate-[fadeIn_0.2s_ease-out]">
                                 <input type="text" id="edit-auth-name-input" class="w-full p-2 border-2 border-amber-300 rounded-lg text-center font-bold text-amber-900 placeholder-amber-200 focus:outline-none focus:border-amber-500" placeholder="è¼¸å…¥æ–°æš±ç¨±">
                                 <div class="flex gap-2 w-full justify-center">
                                      <button onclick="app.saveAuthName()" class="bg-green-500 text-white px-4 py-1 rounded-lg text-sm font-bold shadow hover:bg-green-600 active:scale-95 transition-transform">å„²å­˜</button>
                                      <button onclick="app.toggleEditName()" class="bg-gray-300 text-gray-700 px-4 py-1 rounded-lg text-sm font-bold hover:bg-gray-400 active:scale-95 transition-transform">å–æ¶ˆ</button>
                                 </div>
                             </div>
                             
                             <div class="bg-amber-50 rounded-xl p-3 mb-4 border border-amber-200 w-full">
                                 <div class="text-xs text-amber-600 font-bold mb-1">é›²ç«¯æ­·å²æœ€é«˜åˆ†</div>
                                 <div class="text-3xl font-black text-amber-700 flex justify-center items-center gap-2">
                                     <span>ğŸ†</span>
                                     <span id="lobby-high-score-auth">0</span>
                                 </div>
                             </div>
                             
                             <button onclick="app.logout()" class="text-sm text-red-500 font-bold hover:text-red-700 hover:bg-red-50 px-4 py-2 rounded-full transition-colors mb-4">ç™»å‡º Google å¸³è™Ÿ</button>
                        </div>

                        <div id="auth-panel-guest" class="flex flex-col items-center">
                            <div class="text-6xl mb-4">ğŸ¤ </div>
                            <h2 class="text-2xl font-black text-amber-900 mb-2">å†’éšªè€…è³‡æ–™</h2>
                            <p class="text-xs text-gray-500 mb-4">ç™»å…¥ Google ä»¥æ°¸ä¹…ä¿å­˜æˆ°ç¸¾</p>
                            
                            <button onclick="app.loginGoogle()" class="w-full bg-white border border-gray-300 text-gray-700 font-bold py-3 rounded-xl shadow-sm hover:bg-gray-50 hover:shadow-md transition-all active:scale-95 flex items-center justify-center gap-3 mb-4 group">
                                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" class="w-6 h-6" alt="G">
                                <span class="group-hover:text-blue-600 transition-colors">ä½¿ç”¨ Google ç™»å…¥</span>
                            </button>

                            <div class="relative w-full text-center border-t border-gray-200 my-2">
                                <span class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-white px-2 text-xs text-gray-400 font-bold">æˆ– åŒ¿åéŠç©</span>
                            </div>

                            <div class="w-full mt-4">
                                <label class="block text-amber-800 font-bold mb-2 text-left ml-1 text-sm">ä½ çš„æš±ç¨±</label>
                                <input type="text" id="lobby-player-name" class="w-full p-3 border-2 border-amber-300 rounded-xl text-center text-xl font-bold placeholder-amber-200 focus:outline-none focus:border-amber-500 transition-colors" placeholder="è¼¸å…¥æš±ç¨±...">
                            </div>

                            <div class="bg-amber-50 rounded-xl p-2 mt-4 border border-amber-200 w-full">
                                 <div class="text-xs text-amber-600 font-bold">æœ¬æ©Ÿç´€éŒ„ (æœªåŒæ­¥)</div>
                                 <div class="text-xl font-black text-amber-700" id="lobby-high-score">0</div>
                            </div>
                        </div>

                        <hr class="border-amber-200 my-4">
                        
                        <button onclick="app.createRoom()" class="w-full bg-gradient-to-r from-amber-600 to-amber-800 text-white font-bold py-4 rounded-xl shadow-lg transition-transform active:scale-95 text-xl mb-2 flex items-center justify-center gap-2">
                            <span>ğŸ°</span> å»ºç«‹æ–°æˆ¿é–“
                        </button>
                        <p class="text-xs text-gray-400">å»ºç«‹å¾Œå°‡è‡ªå‹•æˆç‚ºæˆ¿ä¸»</p>
                    </div>
                </div>

                <div class="md:col-span-8">
                    <div class="lobby-card p-6 min-h-[500px] flex flex-col">
                        <div class="flex justify-between items-center mb-6 border-b border-amber-200 pb-4">
                            <h2 class="text-2xl font-black text-amber-900">ğŸ—ºï¸ å†’éšªå¤§å»³</h2>
                            <button onclick="app.refreshLobby()" class="text-amber-600 font-bold hover:text-amber-800 text-sm">ğŸ”„ é‡æ–°æ•´ç†</button>
                        </div>
                        
                        <div id="lobby-room-list" class="space-y-3 flex-1 overflow-y-auto pr-2">
                            <div class="text-center text-gray-400 py-10">
                                <div class="text-4xl mb-2">ğŸƒ</div>
                                <p>ç›®å‰æ²’æœ‰æ´»èºçš„å†’éšª...</p>
                                <p class="text-sm mt-2">ä½ å¯ä»¥å»ºç«‹ä¸€å€‹ï¼</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="admin-auth-modal" class="fixed inset-0 z-[70] hidden flex items-center justify-center modal-backdrop">
            <div class="bg-white rounded-2xl p-6 max-w-sm w-full mx-4 shadow-2xl border-4 border-slate-600 animate-[fadeIn_0.3s_ease-out]">
                <h3 class="text-xl font-black text-slate-800 mb-4 text-center">ğŸ›¡ï¸ ç®¡ç†å“¡é©—è­‰</h3>
                <input type="password" id="admin-password-input" class="w-full p-3 border-2 border-slate-300 rounded-xl text-center text-lg mb-4" placeholder="è«‹è¼¸å…¥é€šè¡Œå¯†ç¢¼">
                <div class="flex gap-2">
                    <button onclick="app.el('admin-auth-modal').classList.add('hidden')" class="flex-1 py-2 rounded-lg font-bold text-gray-500 hover:bg-gray-100">å–æ¶ˆ</button>
                    <button onclick="app.verifyAdmin()" class="flex-1 bg-slate-800 text-white py-2 rounded-lg font-bold shadow hover:bg-slate-900">ç¢ºèª</button>
                </div>
            </div>
        </div>

        <di<div id="admin-settings-modal" class="fixed inset-0 z-[70] hidden flex items-center justify-center modal-backdrop">
             <div class="bg-white rounded-2xl p-6 max-w-5xl w-full mx-4 shadow-2xl border-4 border-b-8 border-slate-700 animate-[fadeIn_0.3s_ease-out] max-h-[90vh] overflow-y-auto flex flex-col">
                <div class="flex justify-between items-center mb-4 border-b pb-2">
                    <h3 class="text-2xl font-black text-slate-900">âš™ï¸ å…¨åŸŸéŠæˆ²è¨­å®š</h3>
                    <div class="flex items-center gap-3">
                        <button onclick="app.logoutAdmin()" class="bg-slate-200 text-slate-600 px-3 py-1 rounded-lg text-sm font-bold hover:bg-red-100 hover:text-red-600 transition-colors">ğŸ”’ ç™»å‡º</button>
                        <button onclick="app.el('admin-settings-modal').classList.add('hidden')" class="text-gray-400 hover:text-gray-600 font-bold text-xl px-2">âœ•</button>
                    </div>
                </div>

                <div class="flex border-b border-slate-200 mb-4">
                    <button onclick="app.switchAdminTab('flow')" id="tab-btn-flow" class="admin-tab-btn admin-tab-active flex-1">ğŸ® éŠæˆ²æµç¨‹</button>
                    <button onclick="app.switchAdminTab('items')" id="tab-btn-items" class="admin-tab-btn flex-1">ğŸ é“å…·ç™¼æ”¾</button>
                    <button onclick="app.switchAdminTab('monsters')" id="tab-btn-monsters" class="admin-tab-btn flex-1">ğŸ‘¹ æ€ªç‰©è¨­å®š</button>
                </div>
                
                <div class="space-y-6 flex-1 overflow-y-auto pr-1 custom-scrollbar">
                    
                    <div id="tab-content-flow" class="admin-tab-content active space-y-4">
                        <div class="bg-slate-50 p-4 rounded-xl border border-slate-200">
                            <h4 class="font-bold text-slate-800 mb-3 flex items-center gap-2">ğŸ² è‡ªå‹•æ“²éª°ç³»çµ±</h4>
                            <div class="flex items-center justify-between">
                                <span class="text-sm text-gray-600">é è¨­é–‹å•Ÿè‡ªå‹•æ“²éª° (å„æˆ¿ä¸»å¯æ‰‹å‹•é—œé–‰)</span>
                                <label class="switch">
                                    <input type="checkbox" id="admin-auto-roll" checked>
                                    <span class="slider"></span>
                                </label>
                            </div>
                        </div>

                        <div class="bg-amber-50 p-4 rounded-xl border border-amber-200">
                            <h4 class="font-bold text-amber-800 mb-3 flex items-center gap-2">â™¾ï¸ ç„¡ç›¡æˆ°é¬¥æ¨¡å¼ (v4.1.8)</h4>
                            <div class="flex items-center justify-between">
                                <div>
                                    <div class="text-sm text-amber-900 font-bold">é–‹å•Ÿå¾ªç’°ç‰Œåº«</div>
                                    <div class="text-xs text-amber-700">ç‰Œåº«ç”¨ç›¡æ™‚è‡ªå‹•æ´—ç‰Œé‡è£œï¼ŒéŠæˆ²æ°¸ä¸çµæŸï¼Œé©åˆæ‰“ç‹æˆ°ã€‚</div>
                                </div>
                                <label class="switch">
                                    <input type="checkbox" id="admin-endless-mode">
                                    <span class="slider"></span>
                                </label>
                            </div>
                        </div>

                        <div class="bg-blue-50 p-4 rounded-xl border border-blue-200">
                            <h4 class="font-bold text-blue-800 mb-3 flex items-center gap-2">â±ï¸ æ™‚é–“æ§åˆ¶è¨­å®š</h4>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-xs font-bold text-gray-500 mb-1">åŸºç¤å€’æ•¸ (ç§’)</label>
                                    <input type="number" id="admin-timer-base" value="120" class="w-full border-2 border-blue-300 rounded-lg p-2 text-center font-bold text-blue-900">
                                </div>
                                <div>
                                    <label class="block text-xs font-bold text-gray-500 mb-1">ç­”å°é‡ç½® (ç§’)</label>
                                    <input type="number" id="admin-timer-reset" value="45" class="w-full border-2 border-blue-300 rounded-lg p-2 text-center font-bold text-blue-900">
                                </div>
                            </div>
                        </div>

                        <div class="bg-red-50 p-4 rounded-xl border border-red-200">
                             <h4 class="font-bold text-red-800 mb-3">ğŸ—‘ï¸ æ•¸æ“šæ¸…ç†</h4>
                             <div class="flex items-center justify-between mb-2">
                                <span class="text-sm text-gray-600">é–’ç½® 60 åˆ†é˜è‡ªå‹•æ¸…ç©º</span>
                                 <label class="switch">
                                    <input type="checkbox" checked disabled>
                                    <span class="slider"></span>
                                </label>
                             </div>
                             <button onclick="app.clearAllRooms()" class="w-full border-2 border-red-300 text-red-600 font-bold py-2 rounded-lg hover:bg-red-100 transition-colors">âš ï¸ å¼·åˆ¶æ¸…ç©ºæ‰€æœ‰æˆ¿é–“æ•¸æ“š</button>
                        </div>
                    </div>

                    <div id="tab-content-items" class="admin-tab-content space-y-4">
                        <div class="bg-slate-50 p-4 rounded-xl border border-slate-200">
                            <h4 class="font-bold text-slate-800 mb-3 flex items-center gap-2">ğŸ è‡ªå‹•é“å…·åˆ†é…æ’ç¨‹ (GM)</h4>
                            
                            <div class="flex justify-between items-center mb-4 bg-white p-2 rounded-lg border">
                                <span class="text-sm font-bold text-slate-700">å•Ÿç”¨è‡ªå‹•ç™¼æ”¾</span>
                                <label class="switch">
                                    <input type="checkbox" id="admin-ag-enable">
                                    <span class="slider"></span>
                                </label>
                            </div>

                            <div class="grid grid-cols-3 gap-2 mb-4">
                                 <div>
                                    <label class="block text-xs font-bold text-gray-500 mb-1">é–“éš”å›åˆ</label>
                                    <input type="number" id="admin-ag-interval" value="3" class="w-full border-2 border-slate-300 rounded-lg p-2 text-center font-bold">
                                </div>
                                <div>
                                    <label class="block text-xs font-bold text-gray-500 mb-1">çµ¦å€’æ•¸å¹¾å?</label>
                                    <input type="number" id="admin-ag-target" value="2" class="w-full border-2 border-slate-300 rounded-lg p-2 text-center font-bold">
                                </div>
                                <div>
                                    <label class="block text-xs font-bold text-gray-500 mb-1">æ¯äººå¹¾å€‹?</label>
                                    <input type="number" id="admin-ag-count" value="1" class="w-full border-2 border-slate-300 rounded-lg p-2 text-center font-bold">
                                </div>
                            </div>

                            <div>
                                <label class="block text-base font-bold text-gray-600 mb-2">å…è¨±ç™¼æ”¾çš„é“å…· (GMæŒ‡å®š)</label>
                                <div class="grid grid-cols-2 gap-3 text-lg text-slate-800 bg-white p-3 rounded-xl border-2 border-slate-200">
                                    <label class="flex items-center gap-3 cursor-pointer hover:bg-amber-50 p-2 rounded-lg transition-colors select-none border border-transparent hover:border-amber-200"><input type="checkbox" class="admin-ag-item-check w-6 h-6 accent-amber-600" value="hint" checked> <span>ğŸ“œ æç¤º</span></label>
                                    <label class="flex items-center gap-3 cursor-pointer hover:bg-amber-50 p-2 rounded-lg transition-colors select-none border border-transparent hover:border-amber-200"><input type="checkbox" class="admin-ag-item-check w-6 h-6 accent-amber-600" value="double" checked> <span>ğŸ¦‚ è–ç”²èŸ²</span></label>
                                    <label class="flex items-center gap-3 cursor-pointer hover:bg-amber-50 p-2 rounded-lg transition-colors select-none border border-transparent hover:border-amber-200"><input type="checkbox" class="admin-ag-item-check w-6 h-6 accent-amber-600" value="nile" checked> <span>ğŸŒŠ å°¼ç¾…æ²³</span></label>
                                    <label class="flex items-center gap-3 cursor-pointer hover:bg-amber-50 p-2 rounded-lg transition-colors select-none border border-transparent hover:border-amber-200"><input type="checkbox" class="admin-ag-item-check w-6 h-6 accent-amber-600" value="horus"> <span>ğŸ‘ï¸ è·é­¯æ–¯</span></label>
                                    <label class="flex items-center gap-3 cursor-pointer hover:bg-amber-50 p-2 rounded-lg transition-colors select-none border border-transparent hover:border-amber-200"><input type="checkbox" class="admin-ag-item-check w-6 h-6 accent-amber-600" value="time"> <span>â³ æ™‚ä¹‹æ²™</span></label>
                                    <label class="flex items-center gap-3 cursor-pointer hover:bg-amber-50 p-2 rounded-lg transition-colors select-none border border-transparent hover:border-amber-200"><input type="checkbox" class="admin-ag-item-check w-6 h-6 accent-amber-600" value="seal"> <span>ğŸ”’ å°å°</span></label>
                                    <label class="flex items-center gap-3 cursor-pointer hover:bg-amber-50 p-2 rounded-lg transition-colors select-none border border-transparent hover:border-amber-200"><input type="checkbox" class="admin-ag-item-check w-6 h-6 accent-amber-600" value="anubis"> <span>âš–ï¸ é˜¿åŠªæ¯”æ–¯</span></label>
                                    <label class="flex items-center gap-3 cursor-pointer hover:bg-amber-50 p-2 rounded-lg transition-colors select-none border border-transparent hover:border-amber-200"><input type="checkbox" class="admin-ag-item-check w-6 h-6 accent-amber-600" value="shard" checked> <span>ğŸ•’ ç¢ç‰‡</span></label>
                                    <label class="flex items-center gap-3 cursor-pointer hover:bg-amber-50 p-2 rounded-lg transition-colors select-none border border-transparent hover:border-amber-200"><input type="checkbox" class="admin-ag-item-check w-6 h-6 accent-amber-600" value="mummy"> <span>ğŸ‘» æœ¨ä¹ƒä¼Š</span></label>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
<div id="tab-content-monsters" class="admin-tab-content space-y-4">
                        
                        <div id="monster-list-view" class="block animate-[fadeIn_0.3s_ease-out]">
                            <div class="flex justify-between items-center mb-4">
                                <h4 class="font-bold text-stone-800 flex items-center gap-2 text-xl">ğŸ‘¹ æ€ªç‰©åœ–é‘‘ç¸½è¡¨</h4>
                                <button onclick="app.addNewMonster()" class="bg-green-600 text-white px-4 py-2 rounded-lg font-bold shadow hover:bg-green-700 active:scale-95 transition-transform flex items-center gap-2">
                                    <span>â•</span> æ–°å¢æ€ªç‰©
                                </button>
                            </div>
                            
                            <div class="bg-stone-100 rounded-xl border border-stone-300 overflow-hidden">
                                <div class="grid grid-cols-12 gap-2 bg-stone-200 p-3 font-bold text-stone-700 text-sm border-b border-stone-300 items-center text-center">
                                    <div class="col-span-1">é è¦½</div>
                                    <div class="col-span-1">åºè™Ÿ</div>
                                    <div class="col-span-3 text-left pl-2">åç¨± (é»æ“Šç·¨è¼¯)</div>
                                    <div class="col-span-1">å¡èƒŒ</div>
                                    <div class="col-span-1">HP</div>
                                    <div class="col-span-1">ATK</div>
                                    <div class="col-span-1">é‡‘å¹£</div>
                                    <div class="col-span-3">æ“ä½œ</div>
                                </div>
                                <div id="monster-list-container" class="max-h-[400px] overflow-y-auto custom-scrollbar bg-white">
                                    </div>
                            </div>
                            <div class="text-xs text-gray-500 mt-2 text-right">ğŸ’¡ æç¤ºï¼šç›´æ¥ä¿®æ”¹æ•¸å€¼å¾Œï¼Œè¨˜å¾—æŒ‰ä¸‹æœ€ä¸‹æ–¹çš„ã€Œå„²å­˜å…¨åŸŸè¨­å®šã€æ‰æœƒç”Ÿæ•ˆã€‚</div>
                        </div>

                        <div id="monster-editor-view" class="hidden animate-[fadeIn_0.3s_ease-out]">
                            <div class="flex justify-between items-center mb-4 bg-stone-100 p-3 rounded-xl border border-stone-200">
                                <button onclick="app.switchMonsterView('list')" class="bg-gray-500 text-white px-4 py-2 rounded-lg font-bold hover:bg-gray-600 active:scale-95 transition-transform flex items-center gap-2">
                                    <span>ğŸ”™</span> è¿”å›åˆ—è¡¨
                                </button>
                                <h4 class="font-bold text-stone-800 text-lg">ğŸ“ ç·¨è¼¯æ€ªç‰©è©³ç´°åƒæ•¸</h4>
                                <button onclick="app.deleteCurrentMonster()" class="bg-red-100 text-red-600 border border-red-300 px-4 py-2 rounded-lg font-bold hover:bg-red-200 active:scale-95 transition-transform">
                                    ğŸ—‘ï¸ åˆªé™¤æ­¤æ€ª
                                </button>
                            </div>

                            <div class="bg-stone-50 p-4 rounded-xl border border-stone-300">
                                <input type="hidden" id="edit-monster-index"> <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                    <div class="space-y-2">
                                        <div>
                                            <label class="block text-xs font-bold text-gray-500 mb-1">æ€ªç‰©åç¨±</label>
                                           <input type="text" id="edit-monster-name" class="w-full border-2 border-stone-300 rounded-lg p-2 font-bold text-stone-900">
                                        </div>
                                        
                                        <div>
                                            <label class="block text-xs font-bold text-gray-500 mb-1">å¡ç‰Œå¼·åº¦ (èƒŒå¡æ¨£å¼)</label>
                                            <select id="edit-monster-cardback" class="w-full border-2 border-blue-300 rounded-lg p-2 font-bold text-blue-900 bg-blue-50">
                                                <option value="1">Lv.1 é»ƒåœŸ</option>
                                                <option value="2">Lv.2 é‹…éŠ…</option>
                                                <option value="3">Lv.3 ç™½éŠ€</option>
                                                <option value="4">Lv.4 é»ƒé‡‘</option>
                                                <option value="5">Lv.5 ç™½é‡‘</option>
                                                <option value="6">Lv.6 é»‘é‡‘</option>
                                                <option value="7">Lv.7 è—é‡‘</option>
                                            </select>
                                        </div>

                                        <div class="grid grid-cols-3 gap-2">
                                            <div>
                                                <label class="block text-xs font-bold text-gray-500 mb-1">HP</label>
                                                <input type="number" id="edit-monster-hp" class="w-full border-2 border-red-300 rounded-lg p-2 text-center font-bold text-red-700">
                                            </div>
                                            <div>
                                                <label class="block text-xs font-bold text-gray-500 mb-1">ATK</label>
                                                <input type="number" id="edit-monster-atk" class="w-full border-2 border-orange-300 rounded-lg p-2 text-center font-bold text-orange-700">
                                            </div>
                                            <div>
                                                <label class="block text-xs font-bold text-gray-500 mb-1">æ‰è½é‡‘å¹£</label>
                                                <input type="number" id="edit-monster-gold" class="w-full border-2 border-yellow-300 rounded-lg p-2 text-center font-bold text-yellow-700">
                                            </div>
                                        </div>
                                        
                                        <div class="bg-white p-3 rounded-lg border border-stone-200 space-y-3 shadow-sm">
                                            <div class="text-xs font-bold text-stone-500 border-b pb-1 mb-1">âš”ï¸ æ”»æ“Šèˆ‡è¡Œç‚ºæ¨¡å¼</div>
                                            
                                            <div class="flex justify-between items-center">
                                                <span class="text-xs font-bold text-stone-700">æ¨¡å¼1ï¼šè¢«å‹•åæ“Š (è¶…æ™‚/æœªè§£å®Œ)</span>
                                                <label class="switch scale-75"><input type="checkbox" id="edit-monster-mode-1"><span class="slider"></span></label>
                                            </div>
                                            <div class="flex justify-between items-center">
                                                <span class="text-xs font-bold text-stone-700">æ¨¡å¼2ï¼šä¸»å‹•æ”»æ“Š (æ™‚é–“åˆ°å…¨é«”)</span>
                                                <label class="switch scale-75"><input type="checkbox" id="edit-monster-mode-2"><span class="slider"></span></label>
                                            </div>
                                            <div class="flex justify-between items-center">
                                                <span class="text-xs font-bold text-stone-700">æ¨¡å¼3ï¼šæ‡²ç½°æ”»æ“Š (ç­”éŒ¯å–®é«”)</span>
                                                <label class="switch scale-75"><input type="checkbox" id="edit-monster-mode-3"><span class="slider"></span></label>
                                            </div>
                                            <div class="flex items-center gap-2 mt-1 border-t pt-2 border-stone-100">
                                                <span class="text-xs font-bold text-stone-700 whitespace-nowrap">æ¨¡å¼4ï¼šæ¯Nå›åˆå…¨é«”</span>
                                                <input type="number" id="edit-monster-mode-4-val" placeholder="0é—œé–‰" class="w-20 border rounded px-2 py-1 text-center text-sm font-bold bg-gray-50">
                                            </div>
                                            <div class="flex items-center gap-2 mt-1">
                                                <span class="text-xs font-bold text-stone-700 whitespace-nowrap">æ¨¡å¼5ï¼šæ³•å‰‡æ”»æ“Š(ç¦)</span>
                                                <select id="edit-monster-mode-5-op" class="w-full border rounded px-2 py-1 text-sm font-bold bg-white">
                                                    <option value="">ç„¡ (ä¸å•Ÿç”¨)</option>
                                                    <option value="+">ç¦ç”¨æ³•å‰‡ (+)</option>
                                                    <option value="-">ç¦ç”¨æ³•å‰‡ (-)</option>
                                                    <option value="Ã—">ç¦ç”¨æ³•å‰‡ (Ã—)</option>
                                                    <option value="Ã·">ç¦ç”¨æ³•å‰‡ (Ã·)</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="space-y-3">
                                        <div class="bg-gray-800 rounded-lg h-48 flex items-center justify-center overflow-hidden border-4 border-stone-400 relative shadow-inner">
                                            <img id="edit-monster-preview-img" src="" class="max-h-full max-w-full object-contain" alt="é è¦½åœ–">
                                            <div class="absolute bottom-0 left-0 right-0 bg-black/60 text-white text-xs text-center p-1">å³æ™‚é è¦½</div>
                                        </div>
                                        
                                        <div class="bg-white p-3 rounded-lg border border-stone-200 space-y-2">
                                            <div>
                                                <label class="block text-xs font-bold text-gray-500 mb-1">åœ–1 URL (æ­£å¸¸ç‹€æ…‹/åˆ—è¡¨åœ–)</label>
                                                <input type="text" id="edit-monster-img-1" oninput="document.getElementById('edit-monster-preview-img').src=this.value" class="w-full border border-stone-300 rounded p-1 text-xs font-mono text-gray-600">
                                            </div>
                                            <div>
                                                <label class="block text-xs font-bold text-gray-500 mb-1">åœ–2 URL (æ”»æ“Šç‹€æ…‹)</label>
                                                <input type="text" id="edit-monster-img-2" class="w-full border border-stone-300 rounded p-1 text-xs font-mono text-gray-600">
                                            </div>
                                            <div>
                                                <label class="block text-xs font-bold text-gray-500 mb-1">åœ–3 URL (BOSSåœ–)</label>
                                                <input type="text" id="edit-monster-img-3" class="w-full border border-stone-300 rounded p-1 text-xs font-mono text-gray-600">
                                            </div>
                                        </div>
                                        
                                        <button onclick="app.saveCurrentMonsterEdit()" class="w-full bg-amber-600 text-white py-3 rounded-xl font-bold text-lg shadow-lg hover:bg-amber-700 active:scale-95 transition-all flex justify-center gap-2">
                                            <span>ğŸ’¾</span> æš«å­˜æ­¤æ€ªç‰©è¨­å®š
                                        </button>
                                        <p class="text-xs text-center text-gray-400">é»æ“Šæš«å­˜å¾Œï¼Œè¨˜å¾—åœ¨ä¸»ç•«é¢æŒ‰ä¸‹ã€Œå„²å­˜å…¨åŸŸè¨­å®šã€</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div>
                <div class="mt-4 pt-4 border-t border-gray-100">
                    <button onclick="app.saveAdminSettings()" class="w-full bg-slate-800 text-white font-bold py-3 rounded-xl shadow-lg hover:bg-slate-900 active:scale-95 transition-transform">ğŸ’¾ å„²å­˜å…¨åŸŸè¨­å®š</button>
                </div>
             </div>
        </div>
        <div id="game-board" class="hidden fade-in">
            <div class="flex flex-wrap justify-between items-center mb-4 bg-white/80 backdrop-blur rounded-xl p-3 shadow border border-amber-200">
                <div class="flex items-center gap-3">
                    <span class="bg-amber-200 text-amber-900 px-3 py-1 rounded-full font-bold">ç­ç´š: <span id="display-class-id">--</span></span>
                    <span class="bg-blue-100 text-blue-900 px-3 py-1 rounded-full font-bold" id="user-identity">--</span>
                </div>
                <div class="flex items-center gap-3 mt-2 md:mt-0">
                    <button <button id="voice-toggle-btn" class="hidden bg-gray-200 px-3 py-1 rounded-full text-sm font-bold" onclick="app.toggleVoice()">ğŸ”Š èªéŸ³é–‹</button>
                    <button class="bg-amber-100 text-amber-800 px-3 py-1 rounded-full text-sm font-bold border border-amber-200 hover:bg-amber-200 transition-colors" onclick="app.leaveGame()">ğŸ”™ è¿”å›å¤§å»³</button>
                </div>
            </div>

            <div class="tablet-layout">
                <div class="tablet-left flex flex-col gap-4">
                    <div class="bg-amber-100 rounded-2xl p-4 shadow-inner text-center relative border-2 border-amber-300">
                        <div id="round-display" class="absolute right-3 top-2 text-XL font-black text-amber-900/60 font-mono tracking-widest select-none">ROUND 1</div>
                        
                        <div id="game-status-text" class="text-xl font-bold text-amber-800">ç­‰å¾…éŠæˆ²é–‹å§‹...</div>
                        <div id="timer-display" class="hidden mt-2 text-4xl font-black text-red-600 font-mono drop-shadow-sm">30</div>
                    </div>

                    <div class="relative bg-amber-50/50 rounded-2xl p-4 min-h-[400px] flex flex-col items-center justify-center border-2 border-amber-200">
                        <div id="monster-stage-layer" class="absolute inset-0 z-20 pointer-events-none rounded-2xl">
                            <div class="absolute top-2 left-2 w-24 h-40 md:w-28 md:h-48 monster-slot flex items-center justify-center opacity-50 transition-all">
                                <span class="text-xs font-bold text-amber-800 opacity-60">Deck</span>
                            </div>
                            <div class="absolute top-2 right-2 w-24 h-40 md:w-28 md:h-48 monster-slot flex items-center justify-center opacity-50 transition-all">
                                <span class="text-xs font-bold text-amber-800 opacity-60">Battle</span>
                            </div>
                            <div id="dynamic-monster-container"></div>
                        </div>
                        
                        <div id="pyramid-board" class="w-full max-w-[320px] mx-auto scale-90 origin-top">
                            </div>
                    </div>

                    <div class="grid grid-cols-4 gap-2 text-center font-bold text-white mt-2">
                        <div class="bg-black/80 rounded-lg deck-count-box">é»‘<div class="deck-count-num" id="count-black">0</div></div>
                        <div class="bg-red-600 rounded-lg deck-count-box">ç´…<div class="deck-count-num" id="count-red">0</div></div>
                        <div class="bg-blue-600 rounded-lg deck-count-box">è—<div class="deck-count-num" id="count-blue">0</div></div>
                        <div class="bg-yellow-400 text-black rounded-lg deck-count-box">é»ƒ<div class="deck-count-num" id="count-yellow">0</div></div>
                    </div>
                </div>

               <div class="tablet-right flex flex-col h-full">
                    
                   <div id="panel-teacher" class="hidden bg-white rounded-2xl p-4 shadow-lg border-2 border-amber-600 flex-shrink-0 overflow-hidden max-h-[40vh] transition-all">
                        <div class="teacher-panel-grid h-full">
                            
                            <div class="flex flex-col gap-2 h-full overflow-y-auto">
                                <div class="flex justify-between items-center mb-2 border-b pb-2 flex-shrink-0">
                                    <h3 class="text-1x1 font-bold text-amber-900">ğŸ›ï¸ ç¥æ®¿è©¦ç…‰</h3>
                                    <div class="flex items-center gap-2 bg-amber-50 px-3 py-1 rounded-full border border-amber-200">
                                        <span class="text-1x1 font-bold text-amber-900">ğŸ¤– æ“²éª°</span>
                                        <label class="switch scale-75">
                                            <input type="checkbox" id="auto-roll-toggle" onchange="app.toggleAutoRoll()">
                                            <span class="slider"></span>
                                        </label>
                                    </div>
                                </div>

                                <div class="grid grid-cols-2 gap-3 mb-2 flex-shrink-0">
                                    <button id="btn-roll" onclick="app.teacherRollDice()" class="col-span-2 bg-gradient-to-r from-amber-600 to-amber-700 text-white py-4 rounded-xl font-bold text-2xl shadow hover:scale-105 transition-transform active:scale-95">ğŸ² æ“²éª°å­</button>
                                    <button onclick="app.forceNextRound()" class="bg-slate-600 text-white py-3 rounded-xl font-bold shadow hover:bg-slate-700 text-base active:scale-95">ä¸‹ä¸€å±€</button>
                                    <button onclick="app.triggerEndGame()" class="bg-red-700 text-white py-3 rounded-xl font-bold shadow hover:bg-red-800 text-base active:scale-95">ğŸ å†’éšªçµæŸ</button>
                                </div>
                                
                                
                            </div>

                            <div class="flex flex-col h-full overflow-hidden bg-amber-50/50 rounded-xl border border-amber-100 relative">
                                <div id="teacher-personal-board" class="overflow-y-auto flex-1 p-2 space-y-1 custom-scrollbar absolute inset-0">
                                </div>
                            </div>

                        </div>
                    </div>

                   <div id="panel-student" class="hidden flex flex-col h-full gap-3">
                        
                        <div id="student-squad-section" class="bg-white/80 rounded-xl p-2 border-2 border-amber-400 shadow-sm w-full">
                            <div class="flex justify-between items-center mb-1 border-b border-amber-200 pb-1">
                                <span class="font-black text-amber-800 text-base">âš”ï¸ å†’éšªå°éšŠç‹€æ³</span>
                                <span class="text-xs text-gray-500">é“å…·æŒæœ‰ä¸­</span>
                            </div>
                            <div id="student-team-board" class="squad-board-container custom-scrollbar" style="height: 160px;">
                                </div>
                        </div>

                        <div id="student-inventory" class="hidden flex items-center justify-between bg-amber-100/50 p-2 rounded-lg border border-amber-200 mx-2">
                            <span class="text-1xl font-black text-amber-900 mr-4 flex items-center shadow-sm bg-amber-200 px-2 rounded-lg">ğŸ’ èƒŒåŒ…</span>
                            <div id="inventory-list" class="flex gap-3 flex-1 justify-end"></div>
                        </div>

                        <div class="bg-white rounded-xl p-4 shadow border-2 border-amber-300">
                             <div class="flex justify-center gap-3 mb-3">
                                <button onclick="app.inputChar(app.state.dice.d8)" id="s-dice-8" class="cursor-control-btn w-12 h-12 bg-amber-100 border-2 border-amber-400 rounded-lg font-black text-xl hover:bg-amber-200 active:bg-amber-300 transition-colors">-</button>
                                <button onclick="app.inputChar(app.state.dice.d10)" id="s-dice-10" class="cursor-control-btn w-12 h-12 bg-amber-100 border-2 border-amber-400 rounded-lg font-black text-xl hover:bg-amber-200 active:bg-amber-300 transition-colors">-</button>
                                <button onclick="app.inputChar(app.state.dice.d12)" id="s-dice-12" class="cursor-control-btn w-12 h-12 bg-amber-100 border-2 border-amber-400 rounded-lg font-black text-xl hover:bg-amber-200 active:bg-amber-300 transition-colors">-</button>
                            </div>
                            
                            <div class="relative">
                                <div id="formula-display" class="fake-input-container" onclick="app.el('formula-display').focus()">
                                    <span class="text-gray-400 text-base font-normal">é»æ“ŠæŒ‰éˆ•è¼¸å…¥...</span>
                                </div>
                                <button onclick="app.backspace()" class="absolute right-2 top-2 bottom-2 px-3 text-red-500 hover:bg-red-50 rounded cursor-control-btn font-bold">âŒ«</button>
                            </div>
                        </div>
                            <div id="horus-input-area" class="hidden grid grid-cols-3 gap-2 mb-2 mt-2 animate-[fadeIn_0.3s_ease-out]"></div>
                        

                        <div id="active-item-status" class="hidden mb-2 p-3 rounded-lg border-2 border-amber-400 bg-amber-50 text-center animate-[popIn_0.3s_ease-out] cursor-pointer hover:bg-red-50 transition-colors" onclick="app.useItem(app.state.activeItem)" title="é»æ“Šå¯é—œé–‰é“å…·"></div>

                        <div class="grid grid-cols-4 gap-2 flex-grow">
                            <button id="btn-op-add" onclick="app.inputChar('+')" class="cursor-control-btn bg-indigo-100 text-indigo-900 rounded-lg font-bold text-2xl shadow border-b-4 border-indigo-200 transition-colors duration-300">+</button>
                            <button id="btn-op-sub" onclick="app.inputChar('-')" class="cursor-control-btn bg-indigo-100 text-indigo-900 rounded-lg font-bold text-2xl shadow border-b-4 border-indigo-200 transition-colors duration-300">-</button>
                            <button id="btn-op-mul" onclick="app.inputChar('Ã—')" class="cursor-control-btn bg-indigo-100 text-indigo-900 rounded-lg font-bold text-2xl shadow border-b-4 border-indigo-200 transition-colors duration-300">Ã—</button>
                            <button id="btn-op-div" onclick="app.inputChar('Ã·')" class="cursor-control-btn bg-indigo-100 text-indigo-900 rounded-lg font-bold text-2xl shadow border-b-4 border-indigo-200 transition-colors duration-300">Ã·</button>
                            
                            <button onclick="app.inputChar('(')" class="cursor-control-btn bg-indigo-50 text-indigo-800 rounded-lg font-bold text-xl shadow border-b-4 border-indigo-200 active:scale-95">(</button>
                            <button onclick="app.inputChar(')')" class="cursor-control-btn bg-indigo-50 text-indigo-800 rounded-lg font-bold text-xl shadow border-b-4 border-indigo-200 active:scale-95">)</button>
                            <button onclick="app.moveCursor(-1)" class="cursor-control-btn bg-amber-200 text-amber-900 rounded-lg font-black text-2xl shadow border-b-4 border-amber-300 active:scale-95 active:bg-amber-300">â¬…ï¸</button>
                            <button onclick="app.moveCursor(1)" class="cursor-control-btn bg-amber-200 text-amber-900 rounded-lg font-black text-2xl shadow border-b-4 border-amber-300 active:scale-95 active:bg-amber-300">â¡ï¸</button>
                            <button onclick="app.submitAnswer()" id="btn-submit" class="col-span-4 bg-green-600 text-white rounded-xl font-bold text-xl shadow-lg border-b-4 border-green-800 active:scale-95 active:border-b-0 transition-all mt-2 py-3 disabled:opacity-50 disabled:grayscale">âœ¨ é©—è­‰ç­”æ¡ˆ</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="msg-toast" class="fixed top-20 left-1/2 transform -translate-x-1/2 bg-slate-800 text-white px-6 py-3 rounded-full shadow-2xl z-50 transition-opacity opacity-0 pointer-events-none font-bold text-lg text-center w-max max-w-[90%]">
                æç¤ºè¨Šæ¯
            </div>
        </div>
       <div id="game-over-modal" class="fixed inset-0 z-[60] hidden flex items-center justify-center modal-backdrop">
             <div class="game-over-modal-content bg-white rounded-3xl p-6 md:p-8 max-w-lg w-full mx-4 relative overflow-hidden flex flex-col max-h-[90vh]">
                <div class="text-center mb-4 z-10">
                    <div class="text-6xl mb-2 animate-bounce">ğŸ‰</div>
                    <h2 class="text-3xl md:text-4xl font-black text-amber-800 drop-shadow-sm">å†’éšªå®Œæˆï¼</h2>
                    
                    <div class="mt-4 bg-gradient-to-r from-amber-100 to-orange-100 rounded-2xl p-4 border-2 border-amber-300 shadow-inner">
                        <p class="text-amber-800 font-bold text-sm uppercase tracking-widest mb-1">Adventure Squad Score</p>
                        <div class="text-5xl font-black text-amber-900 drop-shadow-sm flex justify-center items-center gap-2">
                            <span class="text-3xl">ğŸ›¡ï¸</span>
                            <span id="end-total-score">0</span>
                        </div>
                    </div>
                </div>
                
                <div class="flex-1 overflow-y-auto z-10 px-1 py-2 custom-scrollbar">
                    <div class="bg-amber-50/50 rounded-xl p-4 border border-amber-200">
                        <h3 class="font-bold text-amber-900 border-b-2 border-amber-200 pb-2 mb-3 text-center text-lg flex justify-center items-center gap-2">
                            <span>ğŸ†</span> å‚³å¥‡å†’éšªå®¶
                        </h3>
                        <div id="end-player-ranks" class="space-y-2">
                            </div>
                    </div>
                </div>

                <div class="mt-4 text-center z-10 pt-4 border-t border-amber-100">

                <div class="mt-6 text-center z-10 pt-4 border-t border-amber-100">
                    <p class="text-sm text-gray-500 mb-3">è€å¸«ç¢ºèªå¾Œå¯é–‹å•Ÿæ–°çš„ä¸€å±€</p>
                    <div class="flex flex-col md:flex-row justify-center gap-3">
                        <button onclick="app.leaveGame()" class="bg-slate-500 text-white px-6 py-3 rounded-full font-bold text-lg shadow-lg hover:bg-slate-600 transition-transform">ğŸ”™ è¿”å›å¤§å»³</button>
                        <button id="btn-download-report" onclick="app.downloadGameData()" class="hidden bg-green-600 text-white px-6 py-3 rounded-full font-bold text-lg shadow-lg hover:bg-green-700 transition-transform">ğŸ“¥ ä¸‹è¼‰æˆ°ç¸¾è¡¨</button>
                        <button id="btn-restart-game" onclick="(async () => { try { await app.resetGame(); } catch(e) { console.error(e); } })()" class="hidden bg-gradient-to-r from-amber-600 to-amber-800 text-white px-8 py-3 rounded-full font-bold text-xl shadow-lg hover:scale-105 transition-transform">ğŸ”„ é–‹å•Ÿæ–°å†’éšª</button>
                    </div>
                    <button id="btn-close-end-modal" onclick="app.el('game-over-modal').classList.add('hidden')" class="md:hidden mt-2 text-gray-400 underline text-sm">æš«æ™‚é—œé–‰</button>
                </div>
             </div>
        </div>
<div id="auto-grant-modal" class="fixed inset-0 z-[60] hidden flex items-center justify-center modal-backdrop">
             <div class="bg-white rounded-2xl p-6 max-w-md w-full mx-4 shadow-2xl border-4 border-amber-600 animate-[fadeIn_0.3s_ease-out]">
                <div class="flex justify-between items-center mb-4 border-b pb-2">
                    <h3 class="text-xl font-black text-amber-900">âš™ï¸ è‡ªå‹•é“å…·æ’ç¨‹</h3>
                    <button onclick="app.el('auto-grant-modal').classList.add('hidden')" class="text-gray-400 hover:text-gray-600 font-bold text-xl">âœ•</button>
                </div>
                
                <div class="space-y-4 mb-6">
                    <div class="flex justify-between items-center bg-amber-50 p-3 rounded-xl border border-amber-200">
                        <span class="font-bold text-amber-900">å•Ÿç”¨è‡ªå‹•ç™¼æ”¾</span>
                        <label class="switch">
                            <input type="checkbox" id="ag-enable">
                            <span class="slider"></span>
                        </label>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-bold text-gray-500 mb-1">æ¯éš”å¹¾å›åˆ?</label>
                            <input type="number" id="ag-interval" value="3" min="1" class="w-full border-2 border-amber-300 rounded-lg p-2 text-center font-bold text-amber-900">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 mb-1">çµ¦å€’æ•¸å¹¾çµ„?</label>
                            <input type="number" id="ag-target-count" value="2" min="1" max="5" class="w-full border-2 border-amber-300 rounded-lg p-2 text-center font-bold text-amber-900">
                        </div>
                         <div class="col-span-2">
                            <label class="block text-xs font-bold text-gray-500 mb-1">æ¯çµ„çµ¦å¹¾å€‹?</label>
                            <input type="number" id="ag-item-count" value="1" min="1" max="3" class="w-full border-2 border-amber-300 rounded-lg p-2 text-center font-bold text-amber-900">
                        </div>
                    </div>

                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-2">å…è¨±ç™¼æ”¾çš„é“å…· (éš¨æ©ŸæŠ½å–)</label>
                        <div class="grid grid-cols-2 md:grid-cols-3 gap-2 text-sm">
                            <label class="flex items-center gap-1 cursor-pointer"><input type="checkbox" class="ag-item-check" value="hint" checked> ğŸ“œ æç¤º</label>
                            <label class="flex items-center gap-1 cursor-pointer"><input type="checkbox" class="ag-item-check" value="double" checked> ğŸ¦‚ è–ç”²èŸ²</label>
                            <label class="flex items-center gap-1 cursor-pointer"><input type="checkbox" class="ag-item-check" value="nile" checked> ğŸŒŠ å°¼ç¾…æ²³</label>
                            <label class="flex items-center gap-1 cursor-pointer"><input type="checkbox" class="ag-item-check" value="horus"> ğŸ‘ï¸ è·é­¯æ–¯</label>
                            <label class="flex items-center gap-1 cursor-pointer"><input type="checkbox" class="ag-item-check" value="time"> â³ æ™‚ä¹‹æ²™</label>
                            <label class="flex items-center gap-1 cursor-pointer"><input type="checkbox" class="ag-item-check" value="seal"> ğŸ”’ å°å°</label>
                            <label class="flex items-center gap-1 cursor-pointer"><input type="checkbox" class="ag-item-check" value="anubis"> âš–ï¸ é˜¿åŠªæ¯”æ–¯</label>
                            <label class="flex items-center gap-1 cursor-pointer"><input type="checkbox" class="ag-item-check" value="shard" checked> ğŸ•’ ç¢ç‰‡</label>
							<label class="flex items-center gap-1 cursor-pointer"><input type="checkbox" class="ag-item-check" value="mummy"> ğŸ‘» æœ¨ä¹ƒä¼Š</label>
                        </div>
                    </div>
                </div>

                <button onclick="app.saveAutoGrantSettings()" class="w-full bg-green-600 text-white rounded-xl font-bold py-3 shadow-lg hover:bg-green-700 active:scale-95 transition-all">âœ… å„²å­˜ä¸¦å¥—ç”¨</button>
             </div>
        </div>
        <div id="team-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center modal-backdrop" onclick="if(event.target === this) this.classList.add('hidden')">
             <div class="bg-white rounded-2xl p-6 max-w-sm w-full mx-4 shadow-2xl border-4 border-amber-600 animate-[fadeIn_0.3s_ease-out]">
                <div class="flex justify-between items-center mb-4 border-b pb-2">
                    <h3 class="text-xl font-black text-amber-900" id="modal-team-title">å°çµ„è©³æƒ…</h3>
                    <button onclick="document.getElementById('team-modal').classList.add('hidden')" class="text-gray-400 hover:text-gray-600 font-bold text-xl">âœ•</button>
                </div>
                <div id="modal-team-list" class="space-y-2 max-h-[300px] overflow-y-auto">
                    </div>
             </div>
        </div>
		<div id="student-stats-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center modal-backdrop" onclick="if(event.target === this) this.classList.add('hidden')">
             <div class="bg-white rounded-2xl p-6 max-w-md w-full mx-4 shadow-2xl border-4 border-amber-600 animate-[fadeIn_0.3s_ease-out] flex flex-col max-h-[80vh]">
                <div class="flex justify-between items-center mb-4 border-b pb-2">
                    <h3 class="text-xl font-black text-amber-900">ğŸ“Š å†’éšªæˆ°æ³é€Ÿå ±</h3>
                    <button onclick="document.getElementById('student-stats-modal').classList.add('hidden')" class="text-gray-400 hover:text-gray-600 font-bold text-xl">âœ•</button>
                </div>
                <div id="student-stats-content" class="overflow-y-auto space-y-4 p-1">
                    </div>
             </div>
        </div>
        <div id="solution-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center modal-backdrop">
             <div class="bg-white rounded-2xl p-8 max-w-sm w-full mx-4 shadow-2xl border-4 border-amber-600 text-center animate-[urgentFloat_0.5s_ease-out]">
                <h3 class="text-2xl font-black text-amber-900 mb-4">ğŸ”® æ³•è€ç‹çš„æç¤º</h3>
                <div class="bg-amber-100 p-4 rounded-xl mb-4">
                    <p class="text-sm text-amber-800 mb-1">å‰å…©å€‹æ•¸å­—çš„é‹ç®—æ˜¯...</p>
                    <p id="solution-hint-text" class="text-3xl font-bold text-indigo-700 font-mono tracking-wider">--</p>
                </div>
                <button onclick="document.getElementById('solution-modal').classList.add('hidden')" class="bg-amber-700 text-white px-6 py-2 rounded-lg font-bold">æˆ‘çŸ¥é“äº†</button>
             </div>
        </div>
<div id="reset-overlay" class="fixed inset-0 z-[70] hidden flex flex-col items-center justify-center bg-slate-900/95 text-white animate-[fadeIn_0.5s_ease-out]">
            <div class="text-6xl mb-6 animate-bounce">ğŸº</div>
            <h2 class="text-3xl md:text-5xl font-black mb-4 text-amber-400 tracking-widest">å†’éšªå·²é‡ç½®</h2>
            <p class="text-xl text-gray-300 mb-12">æ³•è€ç‹å·²é–‹å•Ÿæ–°çš„ç¯‡ç« </p>
            <button onclick="app.leaveGame()" class="group relative px-8 py-4 bg-transparent overflow-hidden rounded-full transition-all hover:scale-105">
                <div class="absolute inset-0 w-full h-full bg-gradient-to-r from-amber-500 to-amber-700 opacity-90 group-hover:opacity-100 transition-opacity"></div>
                <div class="relative flex items-center gap-3">
                    <span class="text-2xl font-bold text-white shadow-sm">ğŸ”™ å›åˆ°åˆå§‹ä¹‹åœ°</span>
                </div>
            </button>
        </div>
    </div>
	<script>
    // --- Firebase é…ç½® ---
    const firebaseConfig = {
       apiKey: "AIzaSyDKTbUT8d2UidvZLJjgE8PJnWAJFI1MhLc",
  authDomain: "pharaohrpg-code-v4.firebaseapp.com",
  databaseURL: "https://pharaohrpg-code-v4-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "pharaohrpg-code-v4",
  storageBucket: "pharaohrpg-code-v4.firebasestorage.app",
  messagingSenderId: "727026967052",
  appId: "1:727026967052:web:43e06e2863deee8121c429"
    };

    // åˆå§‹åŒ– Firebase
    firebase.initializeApp(firebaseConfig);
   const db = firebase.database();
    const auth = firebase.auth(); // v4.1.5 æ–°å¢ Auth

    // --- æ‡‰ç”¨ç¨‹å¼æ ¸å¿ƒé‚è¼¯ ---
    const app = {
        state: {
            user: null, // v4.1.5: å„²å­˜ Google ä½¿ç”¨è€…ç‰©ä»¶
            role: null, 
            classId: null,
            myTeam: null,
            myName: null,
            gameData: {},
            cards: {}, 
            voiceEnabled: true,
            localTimer: null,
            selectedCardIndex: null,
            inputFormula: "", 
            inputCursorPos: 0,
            lastRoundProcessed: 0,
            lastStatus: null,
            lastWinnerTime: 0,
            autoRollEnabled: false,
            isResetting: false,
            autoGrant: {
                enabled: false,
                interval: 4,
                targetCount: 1,
                itemCount: 1,
                allowedTypes: ['hint', 'double', 'nile']
            }
        },

        el: (id) => document.getElementById(id),

        // v4.1.5: Google ç™»å…¥é‚è¼¯
        loginGoogle: () => {
            const provider = new firebase.auth.GoogleAuthProvider();
            auth.signInWithPopup(provider)
                .then((result) => {
                    app.toast(`ğŸ‰ æ­¡è¿å›ä¾†ï¼Œ${result.user.displayName}`);
                    // onAuthStateChanged æœƒè‡ªå‹•è™•ç† UI æ›´æ–°
                })
                .catch((error) => {
                    console.error(error);
                    app.toast(`âŒ ç™»å…¥å¤±æ•—ï¼š${error.message}`);
                });
        },

        // v4.1.5: è™•ç†ç™»å…¥å¾Œçš„ UI èˆ‡è³‡æ–™åŒæ­¥
        handleAuthUser: (user) => {
            app.state.user = user;
            // é è¨­å…ˆç”¨ Google åç¨±ï¼Œç¨å¾Œè³‡æ–™åº«è¼‰å…¥æœƒè¦†è“‹
            app.state.myName = user.displayName; 
            
            // UI åˆ‡æ›
            app.el('auth-panel-guest').classList.add('hidden');
            app.el('auth-panel-logged-in').classList.remove('hidden');
            app.el('auth-panel-logged-in').classList.add('flex');
            
            // å¡«å…¥åŸºæœ¬è³‡æ–™
            app.el('user-avatar').src = user.photoURL;
            // é€™è£¡å…ˆä¸å¡« user-display-nameï¼Œäº¤ç”±ä¸‹æ–¹è³‡æ–™åº«ç›£è½å™¨çµ±ä¸€è™•ç†

            // å¾ Firebase è®€å–è©²ç”¨æˆ¶çš„å®Œæ•´è³‡æ–™ (åˆ†æ•¸ + è‡ªè¨‚åç¨±)
            const userRef = db.ref(`users/${user.uid}`);
            userRef.on('value', snapshot => {
                const data = snapshot.val() || {};
                
                // 1. è™•ç†åç¨±ï¼šå„ªå…ˆä½¿ç”¨è³‡æ–™åº«ä¸­çš„ displayNameï¼Œè‹¥ç„¡å‰‡ç”¨ Google é è¨­
                const finalName = data.displayName || user.displayName;
                app.state.myName = finalName;
                app.el('user-display-name').textContent = finalName;
                app.el('lobby-player-name').value = finalName; // åŒæ­¥æ›´æ–°å‰µæˆ¿æ™‚çš„é è¨­åç¨±
                
                // 2. è™•ç†åˆ†æ•¸
                if (data.highScore) {
                    app.el('lobby-high-score-auth').textContent = data.highScore;
                    localStorage.setItem('pharaoh_high_score', data.highScore);
                } else {
                    app.el('lobby-high-score-auth').textContent = '0';
                }
            });
        },
// v4.1.5: åˆ‡æ›ä¿®æ”¹åç¨±æ¨¡å¼
        toggleEditName: () => {
            const displayArea = app.el('auth-name-display-area');
            const editArea = app.el('auth-name-edit-area');
            const input = app.el('edit-auth-name-input');

            if (editArea.classList.contains('hidden')) {
                // é–‹å•Ÿç·¨è¼¯
                displayArea.classList.add('hidden');
                editArea.classList.remove('hidden');
                editArea.classList.add('flex');
                input.value = app.state.myName; // é å¸¶å…¥ç›®å‰åç¨±
                input.focus();
            } else {
                // å–æ¶ˆç·¨è¼¯
                displayArea.classList.remove('hidden');
                editArea.classList.add('hidden');
                editArea.classList.remove('flex');
            }
        },

        // v4.1.5: å„²å­˜æ–°åç¨±åˆ°è³‡æ–™åº«
        saveAuthName: () => {
            const newName = app.el('edit-auth-name-input').value.trim();
            if (!newName) return app.toast('âŒ åç¨±ä¸èƒ½ç‚ºç©ºï¼');
            if (newName.length > 12) return app.toast('âŒ åç¨±å¤ªé•·å›‰ (æœ€å¤š12å­—)');

            if (app.state.user) {
                // å¯«å…¥ Firebase
                db.ref(`users/${app.state.user.uid}`).update({
                    displayName: newName
                }).then(() => {
                    app.toast('âœ… åç¨±æ›´æ–°æˆåŠŸï¼');
                    app.toggleEditName(); // é—œé–‰ç·¨è¼¯æ¡†
                    // handleAuthUser ä¸­çš„ç›£è½å™¨æœƒè‡ªå‹•æ›´æ–° UI
                }).catch(err => {
                    console.error(err);
                    app.toast('âŒ æ›´æ–°å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
                });
            } else {
                app.toast('âŒ è«‹å…ˆç™»å…¥ Google å¸³è™Ÿ');
            }
        },
        // v4.1.5: è™•ç†ç™»å‡º (åŒ…å« Firebase èˆ‡ æœ¬åœ°)
        logout: () => {
            // ç„¡è«–æ˜¯ Google ç™»å…¥é‚„æ˜¯åŒ¿åï¼Œéƒ½å…ˆæ¸…é™¤æœ¬åœ°èˆŠæš«å­˜ï¼Œé¿å…æ®˜ç•™
            localStorage.removeItem('pharaoh_v3_state');
            
            if (app.state.user) {
                // æœ‰ Google ç™»å…¥ï¼šåŸ·è¡Œ Firebase ç™»å‡º
                auth.signOut().then(() => {
                    app.state.user = null;
                    app.state.myName = null;
                    app.toast('ğŸ‘‹ å·²ç™»å‡º Google å¸³è™Ÿ');
                    // onAuthStateChanged æœƒè‡ªå‹•åµæ¸¬åˆ° user ç‚º null ä¸¦åˆ‡æ› UI
                }).catch((error) => {
                    console.error("Logout Error:", error);
                    // è‹¥ Firebase ç™»å‡ºå¤±æ•—ï¼Œè‡³å°‘å¼·åˆ¶é‡æ•´
                    location.reload();
                });
            } else {
                // åŒ¿åç™»å‡ºæ¨¡å¼ï¼šç›´æ¥é‡æ•´
                location.reload();
            }
        },

        // [v4.3.0] é›¢é–‹éŠæˆ²é‚è¼¯ (æˆ¿ä¸»è§£æ•£æˆ¿é–“ vs ç©å®¶å€‹äººé›¢é–‹)
        leaveGame: () => {
            const isHost = app.state.isHost;
            const msg = isHost 
                ? 'âš ï¸ è­¦å‘Šï¼šæ‚¨æ˜¯æˆ¿ä¸»ï¼\né›¢é–‹å°‡æœƒã€Œè§£æ•£æ•´å€‹æˆ¿é–“ã€ï¼Œæ‰€æœ‰äººçš„é€£ç·šå°‡ä¸­æ–·ã€‚\nç¢ºå®šè¦çµæŸä¸¦è¿”å›å¤§å»³å—ï¼Ÿ' 
                : 'ğŸ”™ ç¢ºå®šè¦é›¢é–‹ç›®å‰çš„å†’éšªä¸¦è¿”å›å¤§å»³å—ï¼Ÿ';

            if(!confirm(msg)) return;

            // 1. æ¸…é™¤æœ¬åœ° Session è¨˜æ†¶ (é˜²æ­¢è‡ªå‹•é‡é€£)
            localStorage.removeItem('pharaoh_current_room_id');
            localStorage.removeItem('pharaoh_is_host');
            localStorage.removeItem('pharaoh_role');

            if (isHost && app.state.classId) {
                // [é—œéµ] æˆ¿ä¸»é›¢é–‹ -> ç‰©ç†åˆªé™¤æˆ¿é–“
                // é€™æœƒè§¸ç™¼å…¶ä»–äººçš„ listenToGameData (data=null)ï¼Œè®“ä»–å€‘è¢«è¿«é›¢é–‹
                db.ref(`classes/${app.state.classId}`).remove()
                    .then(() => window.location.reload())
                    .catch(e => { console.error(e); window.location.reload(); });
            } else {
                // ç©å®¶é›¢é–‹ -> åªé‡æ•´é é¢ (æˆ–æ˜¯å¯é¸æ“‡å¾ players ç§»é™¤è‡ªå·±ï¼Œé€™é‚Šé¸æ“‡ä¿ç•™æ•¸æ“šä½†åˆ‡æ–·é€£çµ)
                window.location.reload();
            }
        },

        // v3.2.9 è‡ªå‹•æ“²éª°ç›¸é—œ (ä¿ç•™)
        toggleAutoRoll: () => {
            app.state.autoRollEnabled = app.el('auto-roll-toggle').checked;
            const msg = app.state.autoRollEnabled ? 'ğŸ¤– è‡ªå‹•æ“²éª°å·²é–‹å•Ÿ' : 'ğŸ›‘ è‡ªå‹•æ“²éª°å·²é—œé–‰';
            app.toast(msg);
            if (app.state.autoRollEnabled && app.state.gameData.status === 'waiting') {
                app.triggerAutoRollQueue();
            }
        },

        triggerAutoRollQueue: () => {
            if (!app.state.autoRollEnabled || app.state.gameData?.status !== 'waiting') return;
            if (window.speechSynthesis.speaking) {
                // ä¿®æ”¹ï¼šç¸®çŸ­æª¢æŸ¥é »ç‡ï¼Œå¾ 1000 æ”¹ç‚º 200 (æ¯0.2ç§’æª¢æŸ¥ä¸€æ¬¡æ˜¯å¦è¬›å®Œè©±)
                setTimeout(app.triggerAutoRollQueue, 200); 
            } else {
                // ä¿®æ”¹ï¼šç¸®çŸ­æ“²éª°å‰çš„ç·©è¡ï¼Œå¾ 1000 æ”¹ç‚º 200 (è¬›å®Œè©±å¾Œ0.2ç§’å°±æ“²éª°)
                setTimeout(() => {
                    if (app.state.autoRollEnabled && app.state.gameData?.status === 'waiting') {
                        app.teacherRollDice();
                    }
                }, 200);
            }
        },
// [v4.3.0 æ–°å¢] æª¢æŸ¥ä¸¦æ¢å¾©é€£ç·š
        checkPreviousSession: () => {
            const savedRoomId = localStorage.getItem('pharaoh_current_room_id');
            const savedMyName = localStorage.getItem('pharaoh_player_name');
            const savedIsHost = localStorage.getItem('pharaoh_is_host') === 'true';

            // åªæœ‰ç•¶æœ¬åœ°æœ‰ç´€éŒ„æ™‚æ‰åŸ·è¡Œ
            if (savedRoomId && savedMyName) {
                console.log("ğŸ”„ åµæ¸¬åˆ°æ–·ç·šé‡é€£éœ€æ±‚...", savedRoomId);
                
                // æª¢æŸ¥ Firebase è©²æˆ¿é–“æ˜¯å¦é‚„æ´»è‘—
                db.ref(`classes/${savedRoomId}`).once('value', snapshot => {
                    const roomData = snapshot.val();
                    if (snapshot.exists() && roomData) {
                        // æˆ¿é–“é‚„åœ¨ -> æ¢å¾©ç‹€æ…‹
                        
                        // [ä¿®æ­£é‚è¼¯] å¼·åˆ¶æˆ¿ä¸»æ­¸ä½é˜²è­·æ©Ÿåˆ¶
                        if (savedIsHost) {
                             // å¦‚æœæœ¬åœ°ç´€éŒ„æ˜¯æˆ¿ä¸»ï¼Œå¼·åˆ¶å°‡ã€Œæˆ‘çš„åå­—ã€æ ¡æ­£ç‚ºè³‡æ–™åº«ä¸­çš„ã€Œæˆ¿ä¸»åå­—ã€
                             // é€™èƒ½é˜²æ­¢å›  Google ç™»å…¥åç¨±èˆ‡éŠæˆ²æš±ç¨±ä¸åŒï¼Œå°è‡´è®Šæˆæ–°è§’è‰²çš„å•é¡Œ
                             app.state.myName = roomData.hostName; 
                             app.state.isHost = true;
                             // åŒæ­¥æ›´æ–°æœ¬åœ°å„²å­˜ï¼Œé¿å…ä¸‹æ¬¡åˆä¸ä¸€è‡´
                             localStorage.setItem('pharaoh_player_name', roomData.hostName);
                        } else {
                             // ä¸€èˆ¬å­¸ç”Ÿå‰‡ä½¿ç”¨ç´€éŒ„çš„åå­—
                             app.state.myName = savedMyName;
                             app.state.isHost = false;
                        }

                        app.state.classId = savedRoomId;
                        app.state.role = 'student';
                        app.state.myTeam = 'team1';
                        
                        // [v4.3.1] æˆ¿ä¸»å›æ­¸å¿ƒè·³ï¼šæ›´æ–°æ´»èºæ™‚é–“ï¼Œç¢ºä¿æˆ¿é–“åœ¨å¤§å»³ç¹¼çºŒé¡¯ç¤º
                        if (savedIsHost) {
                            db.ref(`classes/${savedRoomId}`).update({
                                lastActive: firebase.database.ServerValue.TIMESTAMP
                            });
                        }

                        app.toast('âš¡ ç¶²è·¯é–ƒæ–·ï¼Œå·²è‡ªå‹•å¹«æ‚¨é€£å›å†’éšªï¼');
                        app.enterGameMode();
                    } else {
                        // æˆ¿é–“å·²ä¸å­˜åœ¨ (æˆ¿ä¸»å·²è§£æ•£) -> æ¸…é™¤åƒåœ¾ç´€éŒ„
                        console.log("æˆ¿é–“å·²é—œé–‰ï¼Œæ¸…é™¤æœ¬åœ°ç´€éŒ„");
                        localStorage.removeItem('pharaoh_current_room_id');
                        localStorage.removeItem('pharaoh_is_host');
                        localStorage.removeItem('pharaoh_role');
                    }
                });
            }
        },

        // --- 1. åˆå§‹åŒ–èˆ‡è‡ªå‹•ç™»å…¥ [v4.3.0 æ›´æ–°] ---
        init: () => {
            app.createPredefinedCards();
            
            // ç›£è½ Google ç™»å…¥ç‹€æ…‹
            auth.onAuthStateChanged((user) => {
                if (user) {
                    app.handleAuthUser(user);
                } else {
                    app.state.user = null;
                    app.el('auth-panel-guest').classList.remove('hidden');
                    app.el('auth-panel-logged-in').classList.add('hidden');
                    app.el('auth-panel-logged-in').classList.remove('flex');
                    
                    const savedName = localStorage.getItem('pharaoh_player_name');
                    if (savedName) {
                        app.state.myName = savedName;
                        app.el('lobby-player-name').value = savedName;
                    }
                    app.el('lobby-high-score').textContent = localStorage.getItem('pharaoh_high_score') || '0';
                }
                
                // [é—œéµ] ç™»å…¥ç‹€æ…‹ç¢ºèªå¾Œï¼ŒåŸ·è¡Œæ–·ç·šé‡é€£æª¢æŸ¥
                app.checkPreviousSession();
            });

            // ç›£è½å…¨åŸŸè¨­å®š
            db.ref('global_settings').on('value', snapshot => {
                app.state.globalSettings = snapshot.val() || {};
            });

            // è®€å–ä¸¦é¡¯ç¤ºå¤§å»³æˆ¿é–“
            app.refreshLobby();
            
            // é è¨­è¼‰å…¥å¤§å»³
            app.el('page-lobby').classList.remove('hidden');
            app.el('game-board').classList.add('hidden');
            app.el('admin-gear-btn').classList.remove('hidden');
        },

        // v4.0.2: åˆ·æ–°å¤§å»³æˆ¿é–“åˆ—è¡¨ (å³æ™‚ç›£è½ Firebase)
        refreshLobby: () => {
            const listEl = app.el('lobby-room-list');
            const myName = localStorage.getItem('pharaoh_player_name') || 'æœªå‘½å';
            app.el('lobby-high-score').textContent = localStorage.getItem('pharaoh_high_score') || '0';

            // ç›£è½æ‰€æœ‰æˆ¿é–“è®ŠåŒ–
            db.ref('classes').on('value', snapshot => {
                const rooms = snapshot.val();
                if (!rooms) {
                    listEl.innerHTML = '<div class="text-center text-gray-400 py-10"><div class="text-4xl mb-2">ğŸƒ</div><p>ç›®å‰æ²’æœ‰æˆ¿é–“ï¼Œä½ å¯ä»¥å»ºç«‹ä¸€å€‹ï¼</p></div>';
                    return;
                }
                app.renderRoomList(rooms);
            });
        },

        // v4.0.2: æ¸²æŸ“æˆ¿é–“åˆ—è¡¨ (éæ¿¾ 5 åˆ†é˜å…§æ´»èº)
        renderRoomList: (rooms) => {
            const listEl = app.el('lobby-room-list');
            const now = Date.now();
            let html = '';
            let activeCount = 0;

            // è½‰é™£åˆ—ä¸¦æ’åº (æœ€æ–°çš„åœ¨ä¸Šé¢)
            const roomArr = Object.entries(rooms).map(([id, data]) => ({ id, ...data }));
            roomArr.sort((a, b) => (b.lastActive || 0) - (a.lastActive || 0));

            roomArr.forEach(room => {
                // ç¯©é¸æ¢ä»¶: 5åˆ†é˜å…§æ´»èº (5 * 60 * 1000 = 300000)
                // [v4.3.1] æ–°å¢éæ¿¾æ¢ä»¶ï¼šå¿…é ˆæ˜¯æ´»èºä¸”ã€ŒéçµæŸã€ç‹€æ…‹çš„æˆ¿é–“æ‰é¡¯ç¤º
                const isAlive = (now - (room.lastActive || 0)) < 300000;
                const isNotEnded = room.status !== 'ended'; // ç¢ºä¿å†’éšªçµæŸçš„æˆ¿é–“ä¸é¡¯ç¤º
                
                if (isAlive && isNotEnded) {
                    activeCount++;
                    const isMyRoom = room.hostName === app.state.myName;
                    const statusText = room.status === 'waiting' ? 'ç­‰å¾…ä¸­' : 'å†’éšªé€²è¡Œä¸­';
                    const statusClass = room.status === 'waiting' ? 'bg-green-100 text-green-700' : 'bg-orange-100 text-orange-700';
                    
                    // å£“ç¸® HTML é˜²æ­¢ç©ºç™½ç¯€é»
                    html += `<div onclick="app.joinLobbyRoom('${room.id}')" class="room-item"><div class="flex items-center gap-3"><div class="text-2xl">ğŸ°</div><div><div class="font-bold text-amber-900">${room.roomName || 'æœªå‘½åæˆ¿é–“'}</div><div class="text-xs text-gray-500 flex items-center gap-2"><span>æˆ¿ä¸»: ${room.hostName}</span><span class="${statusClass} px-2 py-0.5 rounded-full text-[0.6rem] font-bold">${statusText}</span></div></div></div><div class="text-amber-600 font-bold text-sm">é»æ“ŠåŠ å…¥ âœ</div></div>`;
                }
            });

            if (activeCount === 0) {
                html = '<div class="text-center text-gray-400 py-10"><div class="text-4xl mb-2">ğŸ’¤</div><p>æ‰€æœ‰æˆ¿é–“éƒ½åœ¨ä¼‘æ¯ä¸­...</p></div>';
            }
            listEl.innerHTML = html;
        },

        // v4.0.2: åŠ å…¥æˆ¿é–“ (ä¸€éµåŠ å…¥) - [v4.3.0] æ–°å¢ Session è¨˜æ†¶èˆ‡æ–·ç·šä¿è­·
        joinLobbyRoom: (roomId) => {
            const name = app.el('lobby-player-name').value.trim();
            if (!name) return app.toast('âŒ è«‹å…ˆè¼¸å…¥ä½ çš„å†’éšªè€…åå­—');
            
            // å¯«å…¥æœ¬åœ°è¨˜æ†¶
            localStorage.setItem('pharaoh_player_name', name);
            localStorage.setItem('pharaoh_current_room_id', roomId);
            localStorage.setItem('pharaoh_is_host', 'false');
            localStorage.setItem('pharaoh_role', 'student');

            app.state.myName = name;
            app.state.classId = roomId;
            app.state.role = 'student';
            app.state.isHost = false; 
            app.state.myTeam = 'team1'; 

            // æª¢æŸ¥æˆ¿é–“æ˜¯å¦å­˜åœ¨ä¸¦åŠ å…¥
            const roomRef = db.ref(`classes/${roomId}`);
            roomRef.once('value', snapshot => {
                if (snapshot.exists()) {
                    // [é—œéµ] ä½¿ç”¨ update æ›´æ–°æœ€å¾Œæ´»å‹•æ™‚é–“ï¼Œä¸”ä¸è¨­å®š onDisconnect().remove()
                    // é€™æ¨£ç©å®¶é–ƒé€€å†é€£å›ä¾†ï¼Œåˆ†æ•¸é‚„åœ¨
                    db.ref(`classes/${roomId}/players/team1/${name}`).update({
                        name: name,
                        lastActive: firebase.database.ServerValue.TIMESTAMP
                    });
                    
                    app.enterGameMode();
                    app.toast(`ğŸš€ å·²åŠ å…¥ ${snapshot.val().hostName} çš„å†’éšªï¼`);
                } else {
                    app.toast('âŒ æˆ¿é–“å·²ä¸å­˜åœ¨');
                    // æ¸…é™¤ç„¡æ•ˆè¨˜æ†¶
                    localStorage.removeItem('pharaoh_current_room_id');
                }
            });
        },

        // v4.0.1: å»ºç«‹æ–°æˆ¿é–“ (æˆç‚ºæˆ¿ä¸»+ä¸»æ§è€…) - [v4.3.0] æ–°å¢ Session è¨˜æ†¶
        createRoom: () => {
            const name = app.el('lobby-player-name').value.trim();
            if (!name) return app.toast('âŒ è«‹å…ˆè¼¸å…¥ä½ çš„å†’éšªè€…åå­—');
            
            // å„²å­˜åå­—èˆ‡èº«åˆ†æ¨™è¨˜
            localStorage.setItem('pharaoh_player_name', name);
            app.state.myName = name;

            // ç”Ÿæˆéš¨æ©Ÿæˆ¿é–“ä»£ç¢¼ (6ç¢¼æ•¸å­—)
            const roomId = Math.floor(100000 + Math.random() * 900000).toString();
            app.state.classId = roomId;
            app.state.role = 'student'; 
            app.state.isHost = true;    
            app.state.myTeam = 'team1'; 

            // [é—œéµ] å¯«å…¥ Sessionï¼Œåšç‚ºæ–·ç·šé‡é€£çš„æ†‘è­‰
            localStorage.setItem('pharaoh_current_room_id', roomId);
            localStorage.setItem('pharaoh_is_host', 'true');
            localStorage.setItem('pharaoh_role', 'student');

            // [v4.2.5 ä¿®æ­£] ç¢ºä¿è®€å–æ­£ç¢ºçš„å…¨åŸŸè¨­å®šé è¨­å€¼
            // é¿å…å› æœªæ‰“é–‹ç®¡ç†å“¡è¦–çª—ï¼Œå°è‡´è®€å–åˆ° checkbox é è¨­ false çš„å•é¡Œ
            const globalSet = app.state.globalSettings || {};
            const initAutoRoll = (globalSet.autoRollDefault !== undefined) ? globalSet.autoRollDefault : true;
            const initEndless = (globalSet.endlessMode === true); // é è¨­ falseï¼Œé™¤éå…¨åŸŸæ˜ç¢ºç‚º true

            // å¯«å…¥ Firebase
            const initialData = app.generateInitialGameData();
            db.ref(`classes/${roomId}`).set({
                hostName: name,
                roomName: `${name} çš„å†’éšª`,
                status: 'waiting', 
                dice: { d8: '-', d10: '-', d12: '-' },
                round: 1,
                timer: 30,
                timerActive: false,
                pyramid: initialData.pyramid,
                decks: initialData.decks,
                lastActive: firebase.database.ServerValue.TIMESTAMP, 
                autoRoll: initAutoRoll, 
                endlessMode: initEndless
            }).then(() => {
                // åŠ å…¥è‡ªå·±ç‚ºç©å®¶
                db.ref(`classes/${roomId}/players/team1/${name}`).set({
                    name: name,
                    score: 0,
                    lastActive: firebase.database.ServerValue.TIMESTAMP
                });
                
                app.enterGameMode();
                app.toast(`ğŸ° å†’éšªå°éšŠå»ºç«‹æˆåŠŸï¼ä»£ç¢¼ï¼š${roomId}`, 1);
                app.speak('å°éšŠå»ºç«‹ï¼');
                
                // æç¤ºç›®å‰æ¨¡å¼
                if (initEndless) {
    setTimeout(() => {
        app.toast('â™¾ï¸ ç„¡ç›¡æˆ°é¬¥æ¨¡å¼ï¼šå·²å•Ÿç”¨', 1);
        app.speak('æˆ°é¬¥æº–å‚™ä¸­ï¼');
    }, 1200); // ä¾èªéŸ³é•·åº¦å¾®èª¿
}
            });
        },

        // v4.0.3: é€²å…¥éŠæˆ²ä»‹é¢ (æˆ¿ä¸»æ¬Šé™æ§åˆ¶)
       // v4.1.0: é€²å…¥éŠæˆ²ä»‹é¢ (ä¿®æ­£ä¸»æ§è€…å€’æ•¸è¨ˆæ™‚èˆ‡èªéŸ³æŒ‰éˆ•é¡¯ç¤º)
        enterGameMode: () => {
            app.el('page-lobby').classList.add('hidden');
            app.el('game-board').classList.remove('hidden');
            app.el('admin-gear-btn').classList.add('hidden');
            
            app.el('display-class-id').textContent = app.state.classId;
            const roleText = app.state.isHost ? 'ğŸ‘‘ æˆ¿ä¸» (ä¸»æ§)' : 'ğŸ¤  å†’éšªè€…';
            app.el('user-identity').textContent = `${roleText} ${app.state.myName}`;
            
            // æ‰€æœ‰äººéƒ½èƒ½çœ‹åˆ°æ“ä½œé¢æ¿
            app.el('panel-student').classList.remove('hidden');

            // v4.1.0: æˆ¿ä¸»é¡¯ç¤ºæ§åˆ¶é¢æ¿èˆ‡èªéŸ³æŒ‰éˆ•
            if (app.state.isHost) {
                app.el('panel-teacher').classList.remove('hidden');
                app.el('voice-toggle-btn').classList.remove('hidden'); // ä¿®æ­£ï¼šé¡¯ç¤ºèªéŸ³æŒ‰éˆ•
                
                // [v4.1.2 ä¿®æ­£] æˆ¿ä¸»å·²æœ‰ä¸Šæ–¹å¤§çœ‹æ¿ï¼Œéš±è—å­¸ç”Ÿé¢æ¿å…§çš„é‡è¤‡å°éšŠå€å¡Šï¼Œé¿å…æ“æ“ 
                const studentSection = app.el('student-squad-section');
                if (studentSection) studentSection.classList.add('hidden');

                // è®€å–å…¨åŸŸè¨­å®šä¾†æ±ºå®šåˆå§‹è‡ªå‹•æ“²éª°ç‹€æ…‹
                db.ref('global_settings/autoRollDefault').once('value', snap => {
                    const defaultAuto = snap.val() !== false; // é è¨­ true
                    app.state.autoRollEnabled = defaultAuto;
                    app.el('auto-roll-toggle').checked = defaultAuto;
                });
            } else {
                app.el('panel-teacher').classList.add('hidden');
            }
            
            app.listenToGameData();

            // v4.1.0: æ ¸å¿ƒä¿®æ­£ - å•Ÿå‹•ä¸»æ§è€…çš„å€’æ•¸è¨ˆæ™‚å™¨è¿´åœˆ
            if (app.state.isHost) {
                if (app.state.hostTimerInterval) clearInterval(app.state.hostTimerInterval);
                
                app.state.hostTimerInterval = setInterval(() => {
                    // åªæœ‰ç•¶ timerActive ç‚º true ä¸”æ™‚é–“å¤§æ–¼ 0 æ™‚æ‰å€’æ•¸
                    if (app.state.gameData && app.state.gameData.timerActive && app.state.gameData.timer > 0) {
                        const newTime = app.state.gameData.timer - 1;
                        db.ref(`classes/${app.state.classId}/timer`).set(newTime);
                        
                        // å‰©é¤˜ 10 ç§’å…§èªéŸ³å ±æ™‚
                        if (newTime <= 10 && newTime > 0) app.speak(newTime.toString());
                        
                        // æ™‚é–“åˆ°
                        if (newTime === 0) {
                            app.handleTimeUp(); // è§¸ç™¼æ™‚é–“åˆ°é‚è¼¯ (åŒ…å«è‡ªå‹•æ›å±€)
                            db.ref(`classes/${app.state.classId}/timerActive`).set(false);
                        }
                    }
                }, 1000);
            }
        },

        // --- ç®¡ç†å“¡ç›¸é—œ (v4.0.3 å¯¦ä½œå…¨åŸŸè¨­å®š) ---
        // [v4.2.3 ä¿®æ”¹] åŠ å…¥è‡ªå‹•ç™»å…¥åˆ¤æ–·
        openAdminAuth: () => {
            // æª¢æŸ¥æ˜¯å¦å·²æœ‰ç™»å…¥ç´€éŒ„
            if (localStorage.getItem('pharaoh_admin_token') === 'valid') {
                app.fetchGlobalSettingsToUI();
                app.el('admin-settings-modal').classList.remove('hidden');
                app.toast('ğŸ”“ æ­¡è¿å›ä¾†ï¼Œç®¡ç†å“¡');
            } else {
                // ç„¡ç´€éŒ„æ‰é¡¯ç¤ºè¼¸å…¥å¯†ç¢¼æ¡†
                app.el('admin-auth-modal').classList.remove('hidden');
                app.el('admin-password-input').value = '';
                app.el('admin-password-input').focus();
            }
        },

        // [v4.2.3 ä¿®æ”¹] é©—è­‰æˆåŠŸå¾Œå¯«å…¥ç´€éŒ„
        verifyAdmin: () => {
            const pwd = app.el('admin-password-input').value;
            if (pwd === '6317261') {
                // å¯«å…¥æœ¬åœ°è¨˜æ†¶
                localStorage.setItem('pharaoh_admin_token', 'valid');
                
                app.el('admin-auth-modal').classList.add('hidden');
                app.fetchGlobalSettingsToUI(); 
                app.el('admin-settings-modal').classList.remove('hidden');
                app.toast('ğŸ”“ ç®¡ç†å“¡é©—è­‰æˆåŠŸ');
            } else {
                app.toast('âŒ å¯†ç¢¼éŒ¯èª¤');
            }
        },

        // [v4.2.3 æ–°å¢] ç®¡ç†å“¡ç™»å‡ºåŠŸèƒ½
        logoutAdmin: () => {
            if(confirm('ğŸ”’ ç¢ºå®šè¦ç™»å‡ºç®¡ç†å“¡æ¨¡å¼å—ï¼Ÿ\nä¸‹æ¬¡é€²å…¥éœ€è¦é‡æ–°è¼¸å…¥å¯†ç¢¼ã€‚')) {
                localStorage.removeItem('pharaoh_admin_token');
                app.el('admin-settings-modal').classList.add('hidden');
                app.toast('ğŸ”’ ç®¡ç†å“¡å·²ç™»å‡º');
            }
        },
// v4.1.8: ç®¡ç†å“¡åˆ†é åˆ‡æ›
        switchAdminTab: (tabName) => {
            // éš±è—æ‰€æœ‰å…§å®¹
            document.querySelectorAll('.admin-tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.admin-tab-btn').forEach(el => el.classList.remove('admin-tab-active'));
            
            // é¡¯ç¤ºç›®æ¨™å…§å®¹
            app.el(`tab-content-${tabName}`).classList.add('active');
            app.el(`tab-btn-${tabName}`).classList.add('admin-tab-active');
        },

        // v4.1.8: ç„¡ç›¡æ¨¡å¼ - æŒ‡å®šé¡è‰²ç‰Œåº«å›å¡« (éæ¿¾æ‰å ´ä¸Šå·²æœ‰çš„ç‰Œ)
        refillSpecificDeck: (color) => {
            // 1. ç”¢ç”Ÿè©²é¡è‰²çš„å®Œæ•´æ–°ç‰Œçµ„
            const fullDecks = app.createFullDeck();
            const freshCards = fullDecks[color];
            
            // 2. æ‰¾å‡ºç›®å‰é‡‘å­—å¡”ä¸Šã€Œå·²ç¶“å­˜åœ¨ã€çš„è©²è‰²ç‰Œ (é¿å…å ´ä¸Šå‡ºç¾å…©å¼µä¸€æ¨£çš„ç‰Œ)
            const currentOnBoardNumbers = (app.state.gameData.pyramid || [])
                .filter(c => c && c.color === color && !c.isTaken)
                .map(c => c.number);

            // 3. éæ¿¾æ‰å ´ä¸Šçš„ç‰Œï¼Œå‰©ä¸‹çš„éƒ½æ”¾å…¥ç‰Œåº«
            const newDeck = freshCards.filter(c => !currentOnBoardNumbers.includes(c.number));
            
            // 4. æ´—ç‰Œä¸¦å›å¡«
            app.state.gameData.decks[color] = app.shuffle(newDeck);
            console.log(`â™¾ï¸ [Endless] Refilled ${color} deck with ${newDeck.length} cards.`);
        },
       // å°‡è³‡æ–™åº«è¨­å®šå¡«å›ç®¡ç†å“¡ä»‹é¢ (v4.1.8 æ›´æ–°ï¼šåŠ å…¥ç„¡ç›¡æ¨¡å¼)
	   // --- v4.2.2 æ€ªç‰©åˆ—è¡¨ç®¡ç†ç³»çµ± ---
        // åˆ‡æ›åˆ—è¡¨/ç·¨è¼¯è¦–åœ–
        switchMonsterView: (view) => {
            if (view === 'list') {
                app.el('monster-list-view').classList.remove('hidden');
                app.el('monster-editor-view').classList.add('hidden');
                app.renderMonsterListUI(); // é‡æ–°æ¸²æŸ“åˆ—è¡¨ä»¥æ›´æ–°æ•¸æ“š
            } else {
                app.el('monster-list-view').classList.add('hidden');
                app.el('monster-editor-view').classList.remove('hidden');
            }
        },

       // æ¸²æŸ“æ€ªç‰©åˆ—è¡¨ (ç”Ÿæˆç„¡ç©ºç™½ HTML)
        renderMonsterListUI: () => {
            const list = app.state.tempMonsterList || [];
            const container = app.el('monster-list-container');
            let html = '';

            // å®šç¾©å¡èƒŒåœ–ç‰‡å°ç…§è¡¨
            const cardBacks = {
                1: 'https://class.kh.edu.tw/sites/30033/upload_file/6/BK8K9kH.jpg',
                2: 'https://class.kh.edu.tw/sites/30033/upload_file/6/jZAPi9w.jpg',
                3: 'https://class.kh.edu.tw/sites/30033/upload_file/6/YBrnPT7.jpg',
                4: 'https://class.kh.edu.tw/sites/30033/upload_file/6/gold.jpg',
                5: 'https://class.kh.edu.tw/sites/30033/upload_file/6/platinum.jpg',
                6: 'https://class.kh.edu.tw/sites/30033/upload_file/6/yauTZnK.jpg',
                7: 'https://class.kh.edu.tw/sites/30033/upload_file/6/AuMVWei.jpg'
            };

            if (list.length === 0) {
                html = '<div class="p-8 text-center text-gray-400 font-bold">å°šç„¡æ€ªç‰©è³‡æ–™ï¼Œè«‹é»æ“Šå³ä¸Šæ–¹ã€Œæ–°å¢æ€ªç‰©ã€</div>';
            } else {
                list.forEach((m, idx) => {
                    const img = m.img1 || 'https://cdn-icons-png.flaticon.com/512/1548/1548680.png'; // é è¨­åœ–
                    const cbUrl = cardBacks[m.cardBack || 1] || cardBacks[1]; // å–å¾—å¡èƒŒåœ–ï¼Œé è¨­1
                    
                    // è¡¨æ ¼åˆ— HTML (ä½¿ç”¨å£“ç¸®å¯«æ³•é¿å…ç©ºç™½ç¯€é»)
                    // èª¿æ•´æ¬„ä½: Name(3), Card(1), HP(1), ATK(1), Gold(1), Action(3)
                    html += `<div class="grid grid-cols-12 gap-2 p-2 border-b border-stone-200 items-center text-center hover:bg-stone-50 transition-colors group"><div class="col-span-1 flex justify-center"><img src="${img}" class="w-8 h-8 object-cover rounded bg-gray-200 border border-gray-300"></div><div class="col-span-1 font-mono text-xs text-gray-400">#${idx + 1}</div><div onclick="app.editMonsterDetail(${idx})" class="col-span-3 text-left pl-2 font-bold text-stone-800 cursor-pointer hover:text-amber-600 hover:underline flex items-center gap-1 truncate" title="${m.name}"><span>${m.name}</span><span class="text-[0.6rem] text-gray-400 group-hover:inline hidden">âœï¸</span></div><div class="col-span-1 flex justify-center"><img src="${cbUrl}" class="w-6 h-9 object-cover rounded border border-gray-300 shadow-sm" title="å¼·åº¦: ${m.cardBack||1}"></div><div class="col-span-1"><input type="number" onchange="app.updateMonsterDirect(${idx}, 'hp', this.value)" value="${m.hp}" class="w-full border border-stone-300 rounded px-1 text-center text-sm font-bold text-red-700 bg-white focus:bg-amber-50"></div><div class="col-span-1"><input type="number" onchange="app.updateMonsterDirect(${idx}, 'atk', this.value)" value="${m.atk}" class="w-full border border-stone-300 rounded px-1 text-center text-sm font-bold text-orange-700 bg-white focus:bg-amber-50"></div><div class="col-span-1"><input type="number" onchange="app.updateMonsterDirect(${idx}, 'gold', this.value)" value="${m.gold}" class="w-full border border-stone-300 rounded px-1 text-center text-sm font-bold text-yellow-700 bg-white focus:bg-amber-50"></div><div class="col-span-3 flex justify-center gap-2"><button onclick="app.editMonsterDetail(${idx})" class="bg-slate-100 text-slate-600 px-3 py-1 rounded text-xs font-bold hover:bg-amber-100 hover:text-amber-700 transition-colors border border-slate-200">è©³ç´°è¨­å®š</button></div></div>`;
                });
            }
            container.innerHTML = html;
        },

        // æ–°å¢ä¸€éš»é è¨­æ€ªç‰©
        addNewMonster: () => {
            if (!app.state.tempMonsterList) app.state.tempMonsterList = [];
            app.state.tempMonsterList.push({
                name: 'æ–°æ€ªç‰©',
                hp: 1000, maxHp: 1000, atk: 10, gold: 50,
                cardBack: 1, // é è¨­é»ƒåœŸå¡
                mode1: false, mode2: false, mode3: false, mode4: 0, mode5: '',
                img1: '', img2: '', img3: ''
            });
            app.renderMonsterListUI();
            // è‡ªå‹•æ²å‹•åˆ°åº•éƒ¨
            setTimeout(() => {
                const c = app.el('monster-list-container');
                c.scrollTop = c.scrollHeight;
            }, 100);
        },

        // ç›´æ¥åœ¨åˆ—è¡¨ä¸­æ›´æ–°æ•¸å€¼ (HP, ATK, Gold)
        updateMonsterDirect: (index, field, value) => {
            if (app.state.tempMonsterList && app.state.tempMonsterList[index]) {
                app.state.tempMonsterList[index][field] = parseInt(value) || 0;
                if (field === 'hp') app.state.tempMonsterList[index].maxHp = parseInt(value) || 0;
            }
        },

        // é€²å…¥è©³ç´°ç·¨è¼¯æ¨¡å¼
        editMonsterDetail: (index) => {
            const m = app.state.tempMonsterList[index];
            if (!m) return;

            app.el('edit-monster-index').value = index;
            app.el('edit-monster-name').value = m.name;
            app.el('edit-monster-cardback').value = m.cardBack || 1; // è¼‰å…¥å¡èƒŒè¨­å®š
            app.el('edit-monster-hp').value = m.hp;
            app.el('edit-monster-atk').value = m.atk;
            app.el('edit-monster-gold').value = m.gold;
            
            app.el('edit-monster-mode-1').checked = m.mode1 || false;
            app.el('edit-monster-mode-2').checked = m.mode2 || false;
            app.el('edit-monster-mode-3').checked = m.mode3 || false;
            app.el('edit-monster-mode-4-val').value = m.mode4 || '';
            app.el('edit-monster-mode-5-op').value = m.mode5 || '';
            
            app.el('edit-monster-img-1').value = m.img1 || '';
            app.el('edit-monster-img-2').value = m.img2 || '';
            app.el('edit-monster-img-3').value = m.img3 || '';
            
            // æ›´æ–°é è¦½åœ–
            app.el('edit-monster-preview-img').src = m.img1 || '';

            app.switchMonsterView('editor');
        },

        // å„²å­˜ç•¶å‰ç·¨è¼¯çš„æ€ªç‰© (å¾ç·¨è¼¯å™¨å¯«å›æš«å­˜é™£åˆ—)
        saveCurrentMonsterEdit: () => {
            const idx = parseInt(app.el('edit-monster-index').value);
            if (isNaN(idx) || !app.state.tempMonsterList[idx]) return;

            const m = app.state.tempMonsterList[idx];
            m.name = app.el('edit-monster-name').value.trim();
            m.cardBack = parseInt(app.el('edit-monster-cardback').value) || 1; // å„²å­˜å¡èƒŒ
            m.hp = parseInt(app.el('edit-monster-hp').value) || 100;
            m.maxHp = m.hp;
            m.atk = parseInt(app.el('edit-monster-atk').value) || 10;
            m.gold = parseInt(app.el('edit-monster-gold').value) || 10;
            
            m.mode1 = app.el('edit-monster-mode-1').checked;
            m.mode2 = app.el('edit-monster-mode-2').checked;
            m.mode3 = app.el('edit-monster-mode-3').checked;
            m.mode4 = parseInt(app.el('edit-monster-mode-4-val').value) || 0;
            m.mode5 = app.el('edit-monster-mode-5-op').value;
            
            m.img1 = app.el('edit-monster-img-1').value.trim();
            m.img2 = app.el('edit-monster-img-2').value.trim();
            m.img3 = app.el('edit-monster-img-3').value.trim();

            app.toast('âœ… æ€ªç‰©è³‡æ–™å·²æš«å­˜ (è«‹è¨˜å¾—å„²å­˜å…¨åŸŸè¨­å®š)');
            app.switchMonsterView('list');
        },

        // åˆªé™¤ç•¶å‰ç·¨è¼¯çš„æ€ªç‰©
        deleteCurrentMonster: () => {
            const idx = parseInt(app.el('edit-monster-index').value);
            if (confirm('ğŸ—‘ï¸ ç¢ºå®šè¦åˆªé™¤é€™éš»æ€ªç‰©å—ï¼Ÿ')) {
                app.state.tempMonsterList.splice(idx, 1);
                app.switchMonsterView('list');
            }
        },
        fetchGlobalSettingsToUI: () => {
            db.ref('global_settings').once('value', snapshot => {
                const settings = snapshot.val() || {};
                app.el('admin-auto-roll').checked = settings.autoRollDefault !== false; 
                app.el('admin-endless-mode').checked = settings.endlessMode || false; // v4.1.8
                
                // v4.5.0 æ™‚é–“è¨­å®šè®€å– (é è¨­ 120 èˆ‡ 45)
                app.el('admin-timer-base').value = settings.baseTimer || 120;
                app.el('admin-timer-reset').value = settings.resetTimer || 45;

                const ag = settings.autoGrant || {};
                app.el('admin-ag-enable').checked = ag.enabled || false;
                app.el('admin-ag-interval').value = ag.interval || 3;
                app.el('admin-ag-target').value = ag.targetCount || 2;
                app.el('admin-ag-count').value = ag.itemCount || 1;

                const allowed = ag.allowedTypes || ['hint', 'double', 'nile', 'shard'];
                document.querySelectorAll('.admin-ag-item-check').forEach(chk => {
                    chk.checked = allowed.includes(chk.value);
                });
				
				// v4.2.2 è®€å–æ€ªç‰©åˆ—è¡¨è¨­å®š
                // å¦‚æœæœ‰æ–°ç‰ˆçš„ list å‰‡ç”¨ listï¼Œå¦å‰‡æª¢æŸ¥æœ‰æ²’æœ‰èˆŠç‰ˆå–®ä¸€è¨­å®šä¸¦è½‰ç‚º listï¼Œè‹¥éƒ½æ²’æœ‰å‰‡çµ¦é è¨­å€¼
                if (settings.monsterList && Array.isArray(settings.monsterList)) {
                    app.state.tempMonsterList = settings.monsterList;
                } else if (settings.monsterConfig) {
                    // ç›¸å®¹æ€§éæ¸¡ï¼šå°‡èˆŠç‰ˆå–®ä¸€è¨­å®šè½‰ç‚ºé™£åˆ—çš„ç¬¬ä¸€ç­†
                    app.state.tempMonsterList = [settings.monsterConfig];
                } else {
                    app.state.tempMonsterList = [];
                }
                
                // åˆå§‹é¡¯ç¤ºåˆ—è¡¨è¦–åœ–
                app.switchMonsterView('list');
            });
        },

        saveAdminSettings: () => {
            // æ”¶é›†å…è¨±çš„é“å…·é¡å‹
            const allowedTypes = [];
            document.querySelectorAll('.admin-ag-item-check:checked').forEach(chk => {
                allowedTypes.push(chk.value);
            });

            if (app.el('admin-ag-enable').checked && allowedTypes.length === 0) {
                return app.toast('âš ï¸ é–‹å•Ÿè‡ªå‹•ç™¼æ”¾æ™‚ï¼Œè‡³å°‘è¦å‹¾é¸ä¸€ç¨®é“å…·ï¼');
            }

            const settings = {
                autoRollDefault: app.el('admin-auto-roll').checked,
                endlessMode: app.el('admin-endless-mode').checked,
                // v4.5.0 å„²å­˜æ™‚é–“è¨­å®š
                baseTimer: parseInt(app.el('admin-timer-base').value) || 120,
                resetTimer: parseInt(app.el('admin-timer-reset').value) || 45,
                
                autoGrant: {
                    enabled: app.el('admin-ag-enable').checked,
                    interval: parseInt(app.el('admin-ag-interval').value) || 3,
                    targetCount: parseInt(app.el('admin-ag-target').value) || 2,
                    itemCount: parseInt(app.el('admin-ag-count').value) || 1,
                    allowedTypes: allowedTypes
                },
                // v4.2.2 æ–°å¢æ€ªç‰©è¨­å®š
                // v4.2.2 å„²å­˜æ€ªç‰©åˆ—è¡¨
                monsterList: app.state.tempMonsterList || [],
                timestamp: firebase.database.ServerValue.TIMESTAMP
            };

            db.ref('global_settings').set(settings).then(() => {
                app.state.globalSettings = settings; 
                app.el('admin-settings-modal').classList.add('hidden');
                
                // è‹¥é–‹å•Ÿç„¡ç›¡æ¨¡å¼ï¼Œå³æ™‚æ›´æ–°ç•¶å‰æˆ¿é–“è¨­å®š (é¸æ“‡æ€§)
                if (app.state.isHost) {
                     db.ref(`classes/${app.state.classId}/endlessMode`).set(settings.endlessMode);
                }

                app.toast('ğŸ’¾ GMå…¨åŸŸè¨­å®šå·²å„²å­˜ (ç„¡ç›¡æ¨¡å¼: ' + (settings.endlessMode ? 'é–‹' : 'é—œ') + ')');
            });
        },
        
        clearAllRooms: () => {
            if(confirm('âš ï¸ è­¦å‘Šï¼šé€™å°‡å¼·åˆ¶æ¸…é™¤ä¼ºæœå™¨ä¸Šæ‰€æœ‰æˆ¿é–“æ•¸æ“šï¼Œç¢ºå®šåŸ·è¡Œï¼Ÿ')) {
                // å¯¦ä½œæ¸…é™¤é‚è¼¯
                app.toast('ğŸ—‘ï¸ æ¸…é™¤æŒ‡ä»¤å·²ç™¼é€');
            }
        },
        saveLocalState: () => {
            const data = {
                role: app.state.role,
                classId: app.state.classId,
                team: app.state.myTeam,
                name: app.state.myName
            };
            localStorage.setItem('pharaoh_v3_state', JSON.stringify(data));
        },

        // --- 3. éŠæˆ²ä»‹é¢èˆ‡åŒæ­¥ ---
        startGameInterface: () => {
            app.el('page-teacher-setup').classList.add('hidden');
            app.el('page-student-login').classList.add('hidden');
            app.el('game-board').classList.remove('hidden');
            
            app.el('display-class-id').textContent = app.state.classId;
            app.el('user-identity').textContent = app.state.role === 'teacher' ? 'ğŸ‘‘ è€å¸«' : `ğŸ¤  ${app.state.myName}`;

            // v4.0.8: ä¿®æ­£é¢æ¿é¡¯ç¤ºé‚è¼¯ï¼Œæˆ¿ä¸»ä¹Ÿèƒ½çœ‹åˆ°æ§åˆ¶å°
            if (app.state.role === 'teacher' || app.state.isHost) {
                app.el('panel-teacher').classList.remove('hidden');
                app.el('voice-toggle-btn').classList.remove('hidden');
            }
            
            // æ‰€æœ‰äºº(åŒ…å«æˆ¿ä¸»)éƒ½é¡¯ç¤ºå­¸ç”Ÿé¢æ¿
            if (app.state.role === 'student') {
                app.el('panel-student').classList.remove('hidden');
            }

            app.listenToGameData();
            
            // v4.0.8: æ ¸å¿ƒä¿®æ­£ - åªè¦æ˜¯æˆ¿ä¸» (isHost) æˆ–æ˜¯è€å¸«ï¼Œå°±æœ‰è³‡æ ¼é©…å‹•ä¼ºæœå™¨å€’æ•¸
            if (app.state.role === 'teacher' || app.state.isHost) {
                // é˜²æ­¢é‡è¤‡ç¶å®š (é›–ç„¶ init åªè·‘ä¸€æ¬¡ï¼Œä½†å®‰å…¨èµ·è¦‹)
                if (app.state.hostTimerInterval) clearInterval(app.state.hostTimerInterval);
                
                app.state.hostTimerInterval = setInterval(() => {
                    if (app.state.gameData && app.state.gameData.timerActive && app.state.gameData.timer > 0) {
                        const newTime = app.state.gameData.timer - 1;
                        db.ref(`classes/${app.state.classId}/timer`).set(newTime);
                        
                        if (newTime <= 10 && newTime > 0) app.speak(newTime.toString());
                        if (newTime === 0) {
                            app.handleTimeUp();
                            db.ref(`classes/${app.state.classId}/timerActive`).set(false);
                        }
                    }
                }, 1000);
            }
        },

      listenToGameData: () => {
            const classRef = db.ref(`classes/${app.state.classId}`);
            
            classRef.on('value', snapshot => {
                const data = snapshot.val();

                // [v4.3.0] æˆ¿ä¸»å·²è§£æ•£æˆ¿é–“ (data ç‚º null)
                if (!data) {
                    // æ¸…é™¤æœ¬åœ°ç´€éŒ„ï¼Œé¿å…é‡æ•´å¾Œåˆè©¦åœ–é‡é€£
                    localStorage.removeItem('pharaoh_current_room_id');
                    localStorage.removeItem('pharaoh_is_host');

                    // é¡¯ç¤ºå¼·åˆ¶çµæŸé®ç½©
                    app.el('game-board').classList.add('hidden');
                    app.el('reset-overlay').classList.remove('hidden');
                    
                    // ä¿®æ”¹é®ç½©æ–‡å­—å…§å®¹ (å‹•æ…‹ä¿®æ”¹ï¼Œä¸éœ€æ”¹ HTML)
                    const overlayTitle = document.querySelector('#reset-overlay h2');
                    const overlayDesc = document.querySelector('#reset-overlay p');
                    if(overlayTitle) overlayTitle.textContent = "å†’éšªå·²çµæŸ";
                    if(overlayDesc) overlayDesc.textContent = "æˆ¿ä¸»å·²è§£æ•£æˆ¿é–“ï¼Œè«‹è¿”å›å¤§å»³";
                    
                    return;
                }
                
                // [v3.1.5] åµæ¸¬åˆ°æˆ¿é–“è¢«é‡ç½®
                if (data.status === 'restarting' || data.status === 'reset_completed') {
                    app.el('game-board').classList.add('hidden');
                    app.el('game-over-modal').classList.add('hidden');
                    app.el('reset-overlay').classList.remove('hidden');
                    
                    const overlayTitle = document.querySelector('#reset-overlay h2');
                    const overlayDesc = document.querySelector('#reset-overlay p');
                    if(overlayTitle) overlayTitle.textContent = "å†’éšªå·²é‡ç½®";
                    if(overlayDesc) overlayDesc.textContent = "æ³•è€ç‹å·²é–‹å•Ÿæ–°çš„ç¯‡ç« ";
                    return;
                }

                // [v3.0.8] åµæ¸¬å›åˆåˆ‡æ›,æ¸…ç©ºè¼¸å…¥
                if (data.round && data.round > app.state.lastRoundProcessed) {
                    app.state.lastRoundProcessed = data.round;
                    if (app.state.role === 'student') {
                        app.resetInput();
                        // v3.3.1: æ–°å›åˆå¼·åˆ¶æ¸…é™¤æ‰€æœ‰é“å…·æ•ˆæœ
                        app.state.activeItem = null;
                        app.renderStudentInventory(data.players); 
                        app.toast('ğŸ”” æ–°å›åˆé–‹å§‹ï¼Œé“å…·æ•ˆæœå·²é‡ç½®', 1);
                    }
                }

                // v3.2.6 æ–°å¢ï¼šè€å¸«ç«¯ç›£è½è´å®¶ä¸¦å»£æ’­
                if (app.state.role === 'teacher' && data.lastWinner && data.lastWinner.timestamp > app.state.lastWinnerTime) {
                    app.state.lastWinnerTime = data.lastWinner.timestamp;
                    const now = Date.now();
                    if (now - data.lastWinner.timestamp < 10000) {
                        
                         app.toast(`ğŸ‰ æ­å–œ ${data.lastWinner.name} å¥ªå¯¶æˆåŠŸï¼`);
                    }
                }

                app.state.gameData = data;
                app.updateUI(data);
            });
        },

       updateUI: (data) => {
            const statusEl = app.el('game-status-text');
            const statusBox = statusEl.parentElement;
            
            // v3.2.4 å„ªåŒ–ï¼šç‹€æ…‹æ”¹è®Šæ™‚çš„åŒæ­¥èªéŸ³èˆ‡æç¤ºé‚è¼¯
           // v3.2.4 å„ªåŒ–ï¼šç‹€æ…‹æ”¹è®Šæ™‚çš„åŒæ­¥èªéŸ³èˆ‡æç¤ºé‚è¼¯
            if (app.state.lastStatus !== data.status) {
                // v3.2.9 æ–°å¢ï¼šåµæ¸¬è½‰ç‚ºç­‰å¾…ç‹€æ…‹æ™‚ï¼Œè§¸ç™¼è‡ªå‹•æ“²éª°
                if (data.status === 'waiting' && app.state.lastStatus !== 'waiting' && app.state.autoRollEnabled) {
                    app.triggerAutoRollQueue();
                }

                app.state.lastStatus = data.status;
                if (data.status === 'dead_end') {
                    const msg = "âš ï¸ æ­¤å±€ç„¡è§£ï¼";
                    app.toast(msg);
                    // ç¢ºä¿èªéŸ³ä¸é‡è¤‡è§¸ç™¼
                }
            }

            statusBox.className = "bg-amber-100 rounded-2xl p-4 shadow-inner text-center relative border-2 border-amber-300 transition-colors duration-300";
            statusEl.className = "text-xl font-bold text-amber-800";
            
            const statusMap = {
                'waiting': 'ç­‰å¾…æ³•è€ç‹é–‹å•Ÿè©¦ç…‰...',
                'rolling': 'ğŸ² å‘½é‹ä¹‹éª°è½‰å‹•ä¸­...',
                'playing': 'âœ¨ è©¦ç…‰é€²è¡Œä¸­ - ç ´è§£åœ–é¨°ï¼',
                'dead_end': 'âš ï¸ æ­¤å±€ç„¡è§£ï¼æº–å‚™é‡æ–°é–‹å§‹...', // v3.2.4 æ–°å¢ç‹€æ…‹
                'ended': 'ğŸ å†’éšªçµæŸ - çµ±è¨ˆæˆ°æœ'
            };
            statusEl.textContent = statusMap[data.status] || data.status;
            
            // [æ–°å¢] æ›´æ–°å›åˆæ•¸é¡¯ç¤º
            if (app.el('round-display')) {
                // å¦‚æœæƒ³è¦æ”¹é¡¯ç¤ºä¸­æ–‡ï¼Œå¯æ”¹ç‚º: `ç¬¬ ${data.round || 1} å›åˆ`
                app.el('round-display').textContent = `ç¬¬ ${data.round || 1} å›åˆ`;
            }

            // ç‰¹æ®Šç‹€æ…‹æ¨£å¼
            if (data.status === 'dead_end') {
                statusBox.className = "bg-red-100 rounded-2xl p-4 shadow-inner text-center relative border-2 border-red-400 animate-pulse";
                statusEl.className = "text-xl font-black text-red-800";
            }

            app.updateDiceUI(data.dice);
            app.renderPyramid(data.pyramid);

            if (data.timerActive) {
                app.el('timer-display').classList.remove('hidden');
                app.el('timer-display').textContent = data.timer;
                if(data.timer === 0) app.handleTimeUp(); 
            } else {
                app.el('timer-display').classList.add('hidden');
            }
            
            app.calculateAndRenderScores(data.players);

            // [v4.3.3] æ¸²æŸ“æ€ªç‰©å¡ç‰Œèˆå°
            app.renderMonsterStage();
            // v3.2.0: æ›´æ–°å­¸ç”ŸèƒŒåŒ…é¡¯ç¤º
            if (app.state.role === 'student') {
                app.renderStudentInventory(data.players);
            }
            // v3.0.9: éŠæˆ²çµæŸæ™‚ï¼Œè‡ªå‹•å½ˆå‡ºçµç®—ç•«é¢
            if (data.status === 'ended') {
                app.renderGameOverStats(data.players);
                app.el('game-over-modal').classList.remove('hidden');
                
                // [v3.1.0] åªæœ‰è€å¸«èƒ½çœ‹åˆ°ã€Œä¸‹è¼‰ã€èˆ‡ã€Œé‡å•Ÿã€æŒ‰éˆ•
                if (app.state.role === 'teacher') {
                    app.el('btn-restart-game').classList.remove('hidden');
                    app.el('btn-download-report').classList.remove('hidden'); // é¡¯ç¤ºä¸‹è¼‰æŒ‰éˆ•
                }
            } else {
                app.el('game-over-modal').classList.add('hidden');
            }

            // è€å¸«ç«¯é‚è¼¯
            if (app.state.role === 'teacher' || app.state.isHost) {
                const btnRoll = app.el('btn-roll');
                // çµæŸæ™‚é–å®šæ“²éª°
                if (data.status === 'waiting') {
                    btnRoll.disabled = false;
                    btnRoll.classList.remove('btn-disabled');
                    btnRoll.textContent = "ğŸ² æ“²éª°å­";
                } else {
                    btnRoll.disabled = true;
                    btnRoll.classList.add('btn-disabled');
                    btnRoll.textContent = (data.status === 'ended') ? "ğŸ çµ±è¨ˆä¸­" : ((data.status === 'rolling') ? "ğŸ² è½‰å‹•ä¸­..." : "ğŸ”’ é–å®šä¸­");
                }
                
                // æ­»å±€æª¢æŸ¥ (åƒ…åœ¨éŠç©ä¸­ä¸”éå€’æ•¸ç‹€æ…‹)
                if (data.status === 'playing') {
                    const currentDice = [data.dice.d8, data.dice.d10, data.dice.d12];
                    const remainingTargets = data.pyramid
                        .filter(c => c && !c.isTaken)
                        .map(c => c.number);
                    
                    if (remainingTargets.length > 0) {
                        let hasSolution = false;
                        for (let target of remainingTargets) {
                            if (app.findSolution(currentDice, target)) {
                                hasSolution = true;
                                break;
                            }
                        }
                        if (!hasSolution) {
                            // v3.2.5 ä¿®æ­£ï¼šéŠæˆ²ä¸­é€”è®Šç„¡è§£ï¼Œç›´æ¥å¯«å…¥è³‡æ–™åº«ï¼Œè§¸ç™¼å…¨é«”å»£æ’­èˆ‡å€’æ•¸
                            // åŠ ä¸Šé˜²æ­¢é‡è¤‡è§¸ç™¼çš„é–ï¼šåªæœ‰åœ¨ç‹€æ…‹å°šæœªè®Šæˆ dead_end æ™‚æ‰åŸ·è¡Œ
                            if (app.state.lastStatus !== 'dead_end') {
                                db.ref(`classes/${app.state.classId}`).update({
                                    status: 'dead_end',
                                    timerActive: false // åœæ­¢åŸæœ¬çš„å€’æ•¸(å¦‚æœæœ‰)
                                });
                                // è€å¸«ç«¯è² è²¬åœ¨ 4 ç§’å¾Œå¼·åˆ¶æ›å±€
                                setTimeout(() => app.forceNextRound(), 4000);
                            }
                        }
                    }
                }
            }
        },

       // v4.1.2: ä¿®æ­£å¾Œçš„è¨ˆåˆ†èˆ‡é¡¯ç¤ºé‚è¼¯ (æ”¯æ´è€å¸«èˆ‡å­¸ç”Ÿé›™ä»‹é¢ã€é“å…·é¡¯ç¤ºã€äººç‰©é ­åƒ)
        calculateAndRenderScores: (players) => {
            if (!players) return;

            app.state.latestTeamStats = {};

            let allPlayers = [];
            let totalTeamScore = 0;

            Object.keys(players).forEach(teamKey => {
                const membersObj = players[teamKey];
                if (!app.state.latestTeamStats[teamKey]) {
                    app.state.latestTeamStats[teamKey] = {
                        name: app.getTeamName(teamKey),
                        score: 0,
                        count: 0,
                        members: []
                    };
                }

                if (membersObj) {
                    Object.values(membersObj).forEach(p => {
                        allPlayers.push({...p, team: teamKey});
                        totalTeamScore += (p.score || 0);
                        
                        app.state.latestTeamStats[teamKey].score += (p.score || 0);
                        app.state.latestTeamStats[teamKey].count++;
                        app.state.latestTeamStats[teamKey].members.push(p);
                    });
                }
            });

            // æ›´æ–°é«˜åˆ†ç´€éŒ„ (æœ¬åœ° + é›²ç«¯)
            if (app.state.myName) {
                const myData = allPlayers.find(p => p.name === app.state.myName);
                const myScore = myData ? (myData.score || 0) : 0;
                const currentHigh = parseInt(localStorage.getItem('pharaoh_high_score') || '0');
                
                if (myScore > currentHigh) {
                    localStorage.setItem('pharaoh_high_score', myScore);
                    // v4.1.5: è‹¥æœ‰ç™»å…¥ Googleï¼ŒåŒæ­¥æ›´æ–°é›²ç«¯ç´€éŒ„
                    if (app.state.user) {
                        db.ref(`users/${app.state.user.uid}`).update({
                            highScore: myScore,
                            lastActive: firebase.database.ServerValue.TIMESTAMP,
                            displayName: app.state.user.displayName
                        });
                        // å³æ™‚æ›´æ–°å¤§å»³é¡¯ç¤º
                        const lobbyAuthScore = app.el('lobby-high-score-auth');
                        if (lobbyAuthScore) lobbyAuthScore.textContent = myScore;
                    } else {
                        // åŒ¿åæ›´æ–°
                        const lobbyGuestScore = app.el('lobby-high-score');
                        if (lobbyGuestScore) lobbyGuestScore.textContent = myScore;
                    }
                }
            }

            // v4.1.2 ä¿®æ”¹ï¼šä¸é€²è¡Œåˆ†æ•¸æ’åº (allPlayers.sort è¢«ç§»é™¤)ï¼Œä¿æŒåˆ—è¡¨ç©©å®š
            // è‹¥æƒ³è¦ç¨å¾®æœ‰é»é †åºï¼Œå¯ä»¥ä¾åå­—æ’åºï¼š allPlayers.sort((a, b) => a.name.localeCompare(b.name));

            // å…±ç”¨æ¸²æŸ“é‚è¼¯ï¼šç”¢ç”Ÿç„¡ç©ºç™½ç¯€é»çš„ HTML å­—ä¸²
            const generateBoardHtml = (isCompact) => {
                // è§’è‰²é ­åƒåº« (ä¾åºå¾ªç’°ä½¿ç”¨)
                const avatars = ['ğŸ’‚','ğŸ‘¸','ğŸ§™','ğŸ§','ğŸ§›','ğŸ§š','ğŸ§','ğŸ§œ','ğŸ§Ÿ','ğŸ•µï¸'];
                
                let listHtml = '';
                
                if (allPlayers.length === 0) {
                    listHtml = `<div class="text-center text-gray-400 py-4 text-xs">ç­‰å¾…å†’éšªè€…åŠ å…¥...</div>`;
                } else {
                    allPlayers.forEach((p, index) => {
                        // 1. æ±ºå®šé ­åƒ (ä½¿ç”¨ index å¾ªç’°å–ç”¨)
                        const avatar = avatars[index % avatars.length];
                        
                        // 2. åˆ¤æ–·æ˜¯å¦ç‚ºè‡ªå·±
                        const isMe = (p.name === app.state.myName);
                        const highlightClass = isMe ? 'bg-amber-100 border-amber-300' : 'bg-white border-slate-100';
                        const nameClass = isMe ? 'text-amber-900' : 'text-slate-700';

                        // 3. ç”Ÿæˆé“å…·åœ–ç¤ºå­—ä¸² (ç„¡ç©ºç™½)
                        let itemsBadge = '';
                        if (p.items) {
                            if (p.items.hint > 0) itemsBadge += 'ğŸ“œ'; 
                            if (p.items.double > 0) itemsBadge += 'ğŸ¦‚';
                            if (p.items.horus > 0) itemsBadge += 'ğŸ‘ï¸'; 
                            if (p.items.nile > 0) itemsBadge += 'ğŸŒŠ';
                            if (p.items.time > 0) itemsBadge += 'â³'; 
                            if (p.items.shard > 0) itemsBadge += 'ğŸ•’';
                            if (p.items.seal > 0) itemsBadge += 'ğŸ”’'; 
                            if (p.items.anubis > 0) itemsBadge += 'âš–ï¸';
                            if (p.items.mummy > 0) itemsBadge += 'ğŸ‘»';
                        }
                        // è‹¥ç„¡é“å…·é¡¯ç¤ºç©ºä½ï¼Œä¿æŒæ’ç‰ˆ (å¯é¸)
                        // if(itemsBadge === '') itemsBadge = '<span class="opacity-0">.</span>';

                        // 4. çµ„åˆå–®è¡Œ HTML (åš´æ ¼ç„¡ç©ºç™½)
                        listHtml += `<div class="flex justify-between items-center p-2 ${highlightClass} rounded-lg border mb-1 shadow-sm transition-all hover:scale-[1.01]"><div class="truncate mr-2 flex items-center gap-2 overflow-hidden"><span class="text-xl filter drop-shadow-sm grayscale-[0.2]">${avatar}</span><div class="flex flex-col"><span class="font-bold ${nameClass} text-sm leading-tight">${p.name}</span><span class="text-[0.65rem] text-gray-500 tracking-tighter h-4 overflow-hidden">${itemsBadge}</span></div></div><div class="font-black text-amber-700 flex-shrink-0 text-lg">${p.score}</div></div>`;
                    });
                }
                return listHtml;
            };

            // æ¸²æŸ“ï¼šè€å¸«ç«¯é¢æ¿
            const teacherBoard = app.el('teacher-personal-board');
            if (teacherBoard) {
                const content = generateBoardHtml(false);
                // åŠ ä¸Šç¸½åˆ†æ¨™é¡Œåˆ—
                const header = `<div class="sticky top-0 bg-white border-b border-amber-200 pb-2 mb-2 z-10 flex justify-between items-center"><span class="font-black text-amber-800 text-lg">âš”ï¸ å†’éšªå°éšŠ</span><span class="bg-amber-100 text-amber-900 px-3 py-1 rounded-full font-black text-xl border border-amber-300 shadow-sm">${totalTeamScore}</span></div>`;
                teacherBoard.innerHTML = header + content;
            }

            // æ¸²æŸ“ï¼šå­¸ç”Ÿç«¯é¢æ¿ (v4.1.2 æ–°å¢)
            const studentBoard = app.el('student-team-board');
            if (studentBoard) {
                 // å­¸ç”Ÿç«¯ç›´æ¥é¡¯ç¤ºåˆ—è¡¨å…§å®¹å³å¯ï¼Œå¤–æ¡†å·²åœ¨ HTML å®šç¾©
                 studentBoard.innerHTML = generateBoardHtml(true);
            }
        },

        // v3.3.3 æ–°å¢ï¼šé¡¯ç¤ºå­¸ç”Ÿæˆ°æ³è¦–çª—

// v3.3.3 æ–°å¢ï¼šé¡¯ç¤ºå­¸ç”Ÿæˆ°æ³è¦–çª—
        // v4.0.4: é¡¯ç¤ºå­¸ç”Ÿæˆ°æ³è¦–çª— (å…¨é«”æ’è¡Œæ¦œæ¨¡å¼)
        showStudentStats: () => {
            const players = app.state.gameData.players;
            if (!players) return app.toast('âš ï¸ ç›®å‰å°šç„¡æˆ°æ³è³‡æ–™');

            const contentEl = app.el('student-stats-content');
            
            // æ”¶é›†æ‰€æœ‰ç©å®¶
            let allPlayers = [];
            // é›–ç„¶ç¾åœ¨åªæœ‰ team1ï¼Œä½†ç‚ºäº†ç©©å¥æ€§æˆ‘å€‘éæ­·æ‰€æœ‰å¯èƒ½çš„ key
            Object.keys(players).forEach(teamKey => {
                if(players[teamKey]) {
                    Object.values(players[teamKey]).forEach(p => {
                        allPlayers.push(p);
                    });
                }
            });

            // æ’åºï¼šåˆ†æ•¸é«˜ -> ä½
            allPlayers.sort((a, b) => (b.score || 0) - (a.score || 0));

            // ç”Ÿæˆæ’è¡Œæ¦œ HTML
            let listHtml = '';
            if (allPlayers.length > 0) {
                allPlayers.forEach((p, index) => {
                    const isMe = p.name === app.state.myName;
                    const rank = index + 1;
                    const rankIcon = rank === 1 ? 'ğŸ¥‡' : (rank === 2 ? 'ğŸ¥ˆ' : (rank === 3 ? 'ğŸ¥‰' : `<span class="text-gray-400 font-bold w-6 text-center">${rank}.</span>`));
                    
                    // æ¨£å¼ï¼šå¦‚æœæ˜¯è‡ªå·±ï¼ŒåŠ å¼·é¡¯ç¤º
                    const bgClass = isMe ? 'bg-amber-100 border-amber-300 ring-1 ring-amber-300' : 'bg-white border-slate-100';
                    const textClass = isMe ? 'text-amber-900' : 'text-slate-700';

                    // é“å…·åœ–ç¤º
                    let itemsBadge = '';
                    if (p.items) {
                         const i = p.items;
                         if (i.hint) itemsBadge += 'ğŸ“œ'; if (i.double) itemsBadge += 'ğŸ¦‚';
                         if (i.horus) itemsBadge += 'ğŸ‘ï¸'; if (i.nile) itemsBadge += 'ğŸŒŠ';
                         if (i.time) itemsBadge += 'â³'; if (i.shard) itemsBadge += 'ğŸ•’';
                         if (i.seal) itemsBadge += 'ğŸ”’'; if (i.anubis) itemsBadge += 'âš–ï¸';
                         if (i.mummy) itemsBadge += 'ğŸ‘»';
                    }

                    listHtml += `<div class="flex justify-between items-center p-3 rounded-lg border ${bgClass} shadow-sm transition-transform hover:scale-[1.01]"><div class="flex items-center gap-3"><div class="text-xl">${rankIcon}</div><div><div class="font-bold ${textClass}">${p.name}</div><div class="text-xs text-gray-500 tracking-wider">${itemsBadge}</div></div></div><div class="font-black text-xl text-amber-600">${p.score || 0}</div></div>`;
                });
            } else {
                listHtml = '<div class="text-center text-gray-400 py-6">ç­‰å¾…å†’éšªè€…åŠ å…¥...</div>';
            }

            // æ¸²æŸ“ä»‹é¢ (ç„¡ç©ºç™½ç¯€é»)
            contentEl.innerHTML = `<div class="bg-amber-50 p-4 rounded-xl border border-amber-200 mb-2"><h4 class="font-bold text-amber-800 flex items-center gap-2 mb-3"><span class="text-2xl">ğŸ†</span> å†’éšªè€…æ’è¡Œæ¦œ</h4><div class="space-y-2 max-h-[60vh] overflow-y-auto pr-1">${listHtml}</div></div>`;

            app.el('student-stats-modal').classList.remove('hidden');
        },
        // v4.0.4: ç”¢ç”ŸéŠæˆ²çµæŸçš„çµç®—ç•«é¢å…§å®¹ (å–®ä¸€å°éšŠç‰ˆ)
        renderGameOverStats: (players) => {
            if (!players) return;
            
            // æ”¶é›†ä¸¦çµ±è¨ˆ
            let allPlayers = [];
            let totalScore = 0;

            Object.keys(players).forEach(teamKey => {
                if(players[teamKey]) {
                    Object.values(players[teamKey]).forEach(p => {
                        const score = p.score || 0;
                        allPlayers.push({...p, score: score});
                        totalScore += score;
                    });
                }
            });

            // æ’åºå€‹äººåˆ†æ•¸
            allPlayers.sort((a, b) => b.score - a.score);
            
            // æ¸²æŸ“ï¼šè‹±é›„æ¦œ (å‰ 10 å)
            let playerHtml = '';
            if (allPlayers.length > 0) {
                allPlayers.slice(0, 10).forEach((p, i) => {
                    const rankClass = i===0 ? 'rank-1' : (i===1 ? 'rank-2' : (i===2 ? 'rank-3' : 'rank-other'));
                    const rowBg = i < 3 ? 'bg-white' : 'bg-slate-50';
                    playerHtml += `<div class="flex items-center justify-between p-3 rounded-xl border border-amber-100 ${rowBg} shadow-sm mb-2"><div class="flex items-center gap-3"><span class="rank-badge ${rankClass} text-lg shadow-sm">${i+1}</span><span class="font-bold text-slate-700 text-lg">${p.name}</span></div><span class="font-black text-amber-700 text-xl">${p.score}</span></div>`;
                });
            } else {
                playerHtml = '<div class="text-center text-gray-400 py-4">æœ¬æ¬¡å†’éšªç„¡äººå¾—åˆ†</div>';
            }

            // æ›´æ–° HTML
            // æˆ‘å€‘ç›´æ¥æ“ä½œ DOM ä¾†æ”¹è®Š modal çš„æ¨™é¡Œèˆ‡å…§å®¹ï¼Œä½¿å…¶é©æ‡‰å–®æ¬„ä½ˆå±€
            app.el('end-total-score').textContent = totalScore;
            app.el('end-player-ranks').innerHTML = playerHtml;
        },

   showTeamModal: (teamKey) => {
            if (!app.state.latestTeamStats) return;
            const team = app.state.latestTeamStats[teamKey];
            if (!team) return;

            app.el('modal-team-title').textContent = `${team.name} (${team.count}äºº)`;
            const listEl = app.el('modal-team-list');
            
            // æ’åºçµ„å“¡åˆ†æ•¸
            team.members.sort((a, b) => b.score - a.score);
            
            // v3.7.0 ä¿®æ”¹ï¼š3x3 ç‰ˆé¢é…ç½®ï¼Œä¸”ä¾ç…§åŠŸèƒ½åˆ†é¡é…è‰²
            // æç¤ºé¡(é»ƒ/æ©˜)ï¼šæç¤ºå¡
            // åˆ†æ•¸åŠ å€é¡(ç´«)ï¼šè–ç”²èŸ²ã€é˜¿åŠªæ¯”æ–¯
            // æ™‚é–“è¦å‰‡é¡(è—)ï¼šæ™‚ä¹‹æ²™ã€æ™‚ä¹‹ç¢ç‰‡
            // è¨ˆç®—è¦å‰‡é¡(ç¶ )ï¼šè·é­¯æ–¯ã€å°¼ç¾…æ²³
            // å°å°é™·é˜±é¡(ç°/é»‘)ï¼šå°å°ã€æœ¨ä¹ƒä¼Š
            
            let html = '<div class="mb-4 bg-amber-50 p-3 rounded-xl border border-amber-200"><div class="grid grid-cols-3 gap-2">';
            
            // ç¬¬ä¸€æ’
            html += `<button onclick="app.grantItem('${teamKey}', 'hint')" class="grant-btn bg-yellow-50 border-yellow-200 hover:bg-yellow-100"><span class="text-xl mb-1">ğŸ“œ</span><span class="text-[0.6rem] font-bold text-yellow-900">æç¤ºå¡</span></button>`;
            html += `<button onclick="app.grantItem('${teamKey}', 'double')" class="grant-btn bg-purple-50 border-purple-200 hover:bg-purple-100"><span class="text-xl mb-1">ğŸ¦‚</span><span class="text-[0.6rem] font-bold text-purple-900">è–ç”²èŸ²</span></button>`;
            html += `<button onclick="app.grantItem('${teamKey}', 'anubis')" class="grant-btn bg-purple-50 border-purple-200 hover:bg-purple-100"><span class="text-xl mb-1">âš–ï¸</span><span class="text-[0.6rem] font-bold text-purple-900">é˜¿åŠªæ¯”æ–¯</span></button>`;
            
            // ç¬¬äºŒæ’
            html += `<button onclick="app.grantItem('${teamKey}', 'time')" class="grant-btn bg-blue-50 border-blue-200 hover:bg-blue-100"><span class="text-xl mb-1">â³</span><span class="text-[0.6rem] font-bold text-blue-900">æ™‚ä¹‹æ²™</span></button>`;
            html += `<button onclick="app.grantItem('${teamKey}', 'shard')" class="grant-btn bg-blue-50 border-blue-200 hover:bg-blue-100"><span class="text-xl mb-1">ğŸ•’</span><span class="text-[0.6rem] font-bold text-blue-900">ç¢ç‰‡</span></button>`;
            html += `<button onclick="app.grantItem('${teamKey}', 'seal')" class="grant-btn bg-slate-100 border-slate-300 hover:bg-slate-200"><span class="text-xl mb-1">ğŸ”’</span><span class="text-[0.6rem] font-bold text-slate-800">å°å°</span></button>`;

            // ç¬¬ä¸‰æ’
            html += `<button onclick="app.grantItem('${teamKey}', 'horus')" class="grant-btn bg-emerald-50 border-emerald-200 hover:bg-emerald-100"><span class="text-xl mb-1">ğŸ‘ï¸</span><span class="text-[0.6rem] font-bold text-emerald-900">è·é­¯æ–¯</span></button>`;
            html += `<button onclick="app.grantItem('${teamKey}', 'nile')" class="grant-btn bg-emerald-50 border-emerald-200 hover:bg-emerald-100"><span class="text-xl mb-1">ğŸŒŠ</span><span class="text-[0.6rem] font-bold text-emerald-900">å°¼ç¾…æ²³</span></button>`;
            html += `<button onclick="app.grantItem('${teamKey}', 'mummy')" class="grant-btn bg-stone-200 border-stone-400 hover:bg-stone-300"><span class="text-xl mb-1">ğŸ‘»</span><span class="text-[0.6rem] font-bold text-stone-900">æœ¨ä¹ƒä¼Š</span></button>`; // æ–°å¢

            html += '</div></div><div class="text-xs text-gray-500 mb-2 font-bold">çµ„å“¡åˆ—è¡¨ï¼š</div>';

            team.members.forEach(m => {
                let itemsBadge = '';
                if (m.items) {
                    if (m.items.hint) itemsBadge += 'ğŸ“œ';
                    if (m.items.double) itemsBadge += 'ğŸ¦‚';
                    if (m.items.horus) itemsBadge += 'ğŸ‘ï¸';
                    if (m.items.nile) itemsBadge += 'ğŸŒŠ';
                    if (m.items.time) itemsBadge += 'â³';
                    if (m.items.shard) itemsBadge += 'ğŸ•’';
                    if (m.items.seal) itemsBadge += 'ğŸ”’';
                    if (m.items.anubis) itemsBadge += 'âš–ï¸';
                    if (m.items.mummy) itemsBadge += 'ğŸ‘»'; // æ–°å¢åˆ—è¡¨åœ–ç¤º
                }
                html += `<div class="team-detail-row items-center"><span class="font-bold text-gray-700">${m.name} <span class="text-xs">${itemsBadge}</span></span><span class="font-bold text-amber-600">${m.score}åˆ†</span></div>`;
            });
            
            if (team.members.length === 0) html += '<div class="text-center text-gray-400 py-4">ç›®å‰æ²’æœ‰çµ„å“¡</div>';
            
            listEl.innerHTML = html;
            app.el('team-modal').classList.remove('hidden');
        },

        // v3.2.0 æ–°å¢ï¼šç™¼æ”¾é“å…·é‚è¼¯
      // [ä¿®æ”¹ 2] æ¬Šé‡å‹é“å…·ç™¼é€ï¼šåˆ†æ•¸ä½ã€é“å…·å°‘è€…å„ªå…ˆ
        grantItem: (teamKey, type) => {
             const team = app.state.latestTeamStats[teamKey];
             if (!team || team.members.length === 0) return app.toast('âŒ è©²çµ„æ²’æœ‰æˆå“¡');

             // --- è¨ˆç®—æ¯ä½æˆå“¡çš„ä¸­çæ¬Šé‡ ---
             let candidates = team.members.map(member => {
                 let weight = 10; // åŸºç¤æ¬Šé‡

                 // æ¢ä»¶ A: åˆ†æ•¸ä½æˆ–æ˜¯å°šæœªå–å¾—åˆ†æ•¸ (0åˆ†è€…æ¬Šé‡ +100ï¼Œåˆ†æ•¸ä½æ–¼å¹³å‡è€… +30)
                 const score = member.score || 0;
                 if (score === 0) {
                     weight += 100;
                 } else if (score < (team.score / team.members.length)) { 
                     // å¦‚æœå€‹äººåˆ†æ•¸ä½æ–¼è©²çµ„å¹³å‡
                     weight += 30;
                 }

                 // è¨ˆç®—è©²ç©å®¶ç›®å‰æ“æœ‰çš„é“å…·ç¸½æ•¸
                 const items = member.items || {};
                 const totalItems = (items.hint||0) + (items.double||0) + (items.horus||0) + (items.nile||0) + (items.seal||0);

                 // æ¢ä»¶ B: å°šæœªç²å¾—éé“å…· (é“å…·ç¸½æ•¸ç‚º 0 è€…æ¬Šé‡ +80)
                 if (totalItems === 0) {
                     weight += 80;
                 }

                 // æ¢ä»¶ C: é“å…·å–å¾—æ¬¡æ•¸è¶Šå°‘ï¼Œæ©Ÿç‡è¶Šé«˜ (æ¯å¤šä¸€å€‹é“å…·ï¼Œæ¬Šé‡ç¨å¾®æ‰£æ¸›ï¼Œä½†æœ€ä½ä¿ç•™ 5)
                 weight -= (totalItems * 10);
                 if (weight < 5) weight = 5; 

                 return { member: member, weight: weight };
             });

             // --- åŠ æ¬Šéš¨æ©Ÿæ¼”ç®—æ³• ---
             const totalWeight = candidates.reduce((sum, c) => sum + c.weight, 0);
             let randomValue = Math.random() * totalWeight;
             let luckyMember = candidates[0].member;

             for (let i = 0; i < candidates.length; i++) {
                 randomValue -= candidates[i].weight;
                 if (randomValue <= 0) {
                     luckyMember = candidates[i].member;
                     break;
                 }
             }
             
             console.log(`é“å…·ç™¼é€ï¼š${luckyMember.name} (æ¬Šé‡: ${candidates.find(c=>c.member===luckyMember).weight}/${totalWeight})`);

             // --- åŸ·è¡Œç™¼é€ ---
             const itemRef = db.ref(`classes/${app.state.classId}/players/${teamKey}/${luckyMember.name}/items/${type}`);
             itemRef.transaction((currentCount) => {
                 return (currentCount || 0) + 1;
             }, (error, committed) => {
                 if (committed) {
                    const itemNames = {
                         hint: 'ğŸ“œ å¤è€æç¤ºå¡',
                         double: 'ğŸ¦‚ è–ç”²èŸ²ç¥ç¦',
                         horus: 'ğŸ‘ï¸ è·é­¯æ–¯ä¹‹çœ¼',
                         nile: 'ğŸŒŠ å°¼ç¾…æ²³æ©è³œ',
                         time: 'â³ æ™‚ä¹‹æ²™',
                         shard: 'ğŸ•’ æ™‚ä¹‹ç¢ç‰‡',
                         seal: 'ğŸ”’ æ³•è€ç‹çš„å°å°',
                         anubis: 'âš–ï¸ é˜¿åŠªæ¯”æ–¯çš„å¯©åˆ¤',
                         mummy: 'ğŸ‘» æœ¨ä¹ƒä¼Šçš„è©›å’’' // æ–°å¢
                     };
                     const itemName = itemNames[type] || 'ğŸ ç¥ç§˜é“å…·';
                     app.toast(ç‰©è³‡å·²ç™¼æ”¾);
                 }
             });
        },

        updateDiceUI: (dice) => {
            // v4.0.6: åªæ›´æ–°è¼¸å…¥é¢æ¿çš„éª°å­æŒ‰éˆ•ï¼Œä¸»æ§è€…ä»‹é¢å·²ç§»é™¤è¦–è¦ºéª°å­
            ['d8', 'd10', 'd12'].forEach(k => {
                const sEl = app.el(`s-dice-${k.slice(1)}`);
                if(sEl) sEl.textContent = dice[k];
            });
            app.state.dice = dice;
        },

       // v3.4.0 æ›´æ–°ï¼šé‡‘å­—å¡”æ¸²æŸ“ (æ”¯æ´æ™‚ä¹‹æ²™å‡çµè¦–è¦ºæ•ˆæœ)
       renderPyramid: (pyramidData) => {
            const board = app.el('pyramid-board');
            if (!pyramidData) return;
            
            const now = Date.now();

            // --- 1. æª¢æŸ¥å‡çµç‹€æ…‹ (æ™‚ä¹‹æ²™) & å°å°ç‹€æ…‹ ---
            let hasActiveLocks = false;
            pyramidData.forEach(c => {
                if(c && c.lockedUntil && c.lockedUntil > now) hasActiveLocks = true;
            });

            const frozenState = app.state.gameData.frozenState;
            let isTimeFrozen = false;
            let frozenRemaining = 0;
            let showGray = false;

            if (frozenState && frozenState.endTime > now) {
                isTimeFrozen = true;
                frozenRemaining = Math.ceil((frozenState.endTime - now) / 1000);
                
                if (app.state.role === 'teacher') {
                    showGray = true; 
                } else if (app.state.role === 'student') {
                    if (frozenState.byTeam !== app.state.myTeam) {
                        showGray = true;
                    }
                }
            }

            const needsTimer = isTimeFrozen || hasActiveLocks;
            if (needsTimer && !app.state.freezeTimerInterval) {
                app.state.freezeTimerInterval = setInterval(() => {
                    app.renderPyramid(app.state.gameData.pyramid); 
                }, 1000);
            } else if (!needsTimer && app.state.freezeTimerInterval) {
                clearInterval(app.state.freezeTimerInterval);
                app.state.freezeTimerInterval = null;
            }

            // --- 2. å»ºæ§‹å¡ç‰‡ HTML ---
            const cardSizeClass = "w-20 h-24 md:w-24 md:h-28 flex-shrink-0";
            const rows = [[0], [1,2], [3,4,5], [6,7,8,9]];
            let html = '';
            
            if (showGray) {
                html += `<div class="frozen-timer-overlay"><div class="frozen-icon">â„ï¸</div><div>${frozenRemaining}s</div></div>`;
            }

            if (isTimeFrozen && !showGray) {
                html += `<div class="absolute -top-8 -left-2 z-40 flex items-center gap-2 bg-white/90 border-4 border-blue-400 px-4 py-1 rounded-full shadow-[0_0_15px_rgba(59,130,246,0.6)] animate-pulse"><span class="text-2xl filter drop-shadow">â³</span><span class="text-2xl font-black text-blue-700 tracking-wider">${frozenRemaining}s</span></div>`;
            }

            html += `<div class="${showGray ? 'frozen-mode' : ''} transition-all duration-500 relative">`;

            rows.forEach(rowIndices => {
                html += '<div class="flex justify-center mb-3 gap-2">'; 
                rowIndices.forEach(idx => {
                    const card = pyramidData[idx];
                    if (card) {
                        const isSelected = app.state.selectedCardIndex === idx;
                        const ringClass = isSelected ? 'ring-4 ring-green-500 scale-110 z-10' : '';
                        const colorClass = app.getCardColorClass(card.color);
                        const visibilityClass = card.isTaken ? 'opacity-0 pointer-events-none' : 'opacity-100';
                        
                        // å¡ç‰Œé–å®šç‹€æ…‹æª¢æŸ¥
                        let lockHtml = '';
                        if (card.lockedUntil && card.lockedUntil > now) {
                            const remaining = Math.ceil((card.lockedUntil - now) / 1000);
                            const isMyLock = card.lockedBy === app.state.myTeam;
                            if (isMyLock) {
                                lockHtml = `<div class="absolute -top-6 -left-2 w-full text-left z-30"><span class="bg-red-500 text-white text-xs font-black px-1.5 py-0.5 rounded-full shadow-md animate-pulse">${remaining}s</span></div><div class="absolute -top-2 -left-2 text-2xl z-20 drop-shadow-md">ğŸ”’</div><div class="absolute bottom-0 w-full text-[0.6rem] bg-green-600 text-white text-center py-0.5 rounded-b-md">å·²é–å®š</div>`;
                            } else {
                                lockHtml = `<div class="absolute inset-0 bg-slate-800/80 rounded-xl z-20 flex flex-col items-center justify-center text-white backdrop-blur-[2px]"><div class="text-xl font-black text-amber-400 mb-1">${remaining}s</div><div class="text-3xl">ğŸ”’</div><div class="text-xs font-bold mt-1">å°å°ä¸­</div></div>`;
                            }
                        }

                        // v3.7.1 ä¿®æ­£ï¼šè©›å’’é¡¯ç¤ºé‚è¼¯ (å³ä¸Šè§’ã€ä¸é‡ç–Šã€åƒ…éšŠå‹å¯è¦‹)
                        let curseHtml = '';
                        if (card.curseData && !card.isTaken) {
                            // åš´æ ¼é™åˆ¶ï¼šåªæœ‰è‡ªå·±çš„éšŠä¼æ‰çœ‹å¾—åˆ°
                            if (app.state.myTeam === card.curseData.team) {
                                // é¡¯ç¤ºåœ¨å³ä¸Šè§’ (top-0 right-0)ï¼ŒåŒ…å«å€’æ•¸è¨ˆæ™‚
                                curseHtml = `<div class="absolute -top-2 -right-2 z-30 flex flex-col items-center"><span class="text-xl filter drop-shadow-sm animate-bounce">ğŸ‘»</span><span class="bg-stone-800 text-white text-[0.6rem] px-1.5 rounded-full font-bold -mt-1 border border-white">${card.curseData.roundsLeft}</span></div>`;
                            }
                        }

                        html += `<div onclick="app.studentSelectCard(${idx})" class="${cardSizeClass} rounded-xl shadow-lg cursor-pointer transition-all duration-200 ${colorClass} ${ringClass} ${visibilityClass} flex items-center justify-center font-black relative border-2 border-white/20">${lockHtml}${curseHtml}<div class="absolute top-1 right-2 text-sm opacity-60 font-bold">${card.points}</div><span class="pyramid-num-lg drop-shadow-md">${card.number}</span></div>`;
                    } else {
                        html += `<div class="${cardSizeClass} rounded-xl border-4 border-dashed border-amber-300/50 bg-white/20"></div>`;
                    }
                });
                html += '</div>';
            });
            html += '</div>'; // å®¹å™¨çµæŸ

            board.innerHTML = html;
            
            const decks = app.state.gameData.decks || {};
            app.el('count-black').textContent = decks.black ? decks.black.length : 0;
            app.el('count-red').textContent = decks.red ? decks.red.length : 0;
            app.el('count-blue').textContent = decks.blue ? decks.blue.length : 0;
            app.el('count-yellow').textContent = decks.yellow ? decks.yellow.length : 0;
        },

      studentSelectCard: (index) => {
            if (app.state.role !== 'student') return;
            if (app.state.gameData.status !== 'playing') return app.toast('âœ‹ ç¾åœ¨é‚„ä¸èƒ½é¸å¡ç‰‡å–”');
            
            const card = app.state.gameData.pyramid[index];
            if (!card || card.isTaken) return;

            // v3.7.1: æœ¨ä¹ƒä¼Šçš„è©›å’’ - åŸ‹è¨­é™·é˜± (é‚è¼¯ç§»åˆ°æœ€ä¸Šæ–¹ï¼Œå¯ç„¡è¦–å°å°)
            if (app.state.activeItem === 'mummy') {
                if (card.curseData) {
                    if (card.curseData.team === app.state.myTeam) return app.toast('ğŸ‘» ä½ å€‘å·²ç¶“åœ¨é€™å¼µç‰Œä¸‹è©›å’’äº†ï¼');
                }

                if (!confirm(`ğŸ‘» ç¢ºå®šè¦åœ¨æ•¸å­— ${card.number} åŸ‹ä¸‹æœ¨ä¹ƒä¼Šçš„è©›å’’å—ï¼Ÿ\n(æŒçºŒ 3 å›åˆï¼Œæ•µäººè¸©åˆ°å°‡å€’æ‰£åˆ†æ•¸)`)) return;

                const itemRef = db.ref(`classes/${app.state.classId}/players/${app.state.myTeam}/${app.state.myName}/items/mummy`);
                itemRef.transaction(count => {
                    if ((count || 0) > 0) {
                        // v3.7.1 å¯«å…¥è©›å’’è³‡è¨Š (åŒ…å«å‰©é¤˜å›åˆæ•¸ 3)
                        db.ref(`classes/${app.state.classId}/pyramid/${index}`).update({
                            curseData: {
                                team: app.state.myTeam,
                                roundsLeft: 3
                            }
                        });
                        app.speak('é™·é˜±å·²åŸ‹è¨­');
                        app.state.activeItem = null;
                        app.renderActiveItemStatus();
                        app.renderStudentInventory(app.state.gameData.players);
                        return count - 1;
                    } else {
                        app.toast('âŒ é“å…·æ•¸é‡ä¸è¶³ï¼');
                        return count; 
                    }
                });
                return;
            }

            // v3.3.1 å°å°é“å…·é‚è¼¯
            if (app.state.activeItem === 'seal') {
                if (card.lockedUntil && card.lockedUntil > Date.now()) {
                    return app.toast('âš ï¸é€™å¼µç‰Œå·²ç¶“è¢«é–å®šäº†ï¼');
                }
                
                if (!confirm(`ğŸ”’ ç¢ºå®šè¦æ¶ˆè€—ä¸€å¼µã€Œæ³•è€å°å°ã€é–å®šæ•¸å­— ${card.number} å—ï¼Ÿ\n(é–å®šæ™‚é–“ 60 ç§’)`)) return;

                const itemRef = db.ref(`classes/${app.state.classId}/players/${app.state.myTeam}/${app.state.myName}/items/seal`);
                itemRef.transaction(count => {
                    if ((count || 0) > 0) {
                        db.ref(`classes/${app.state.classId}/pyramid/${index}`).update({
                            lockedBy: app.state.myTeam,
                            lockedUntil: Date.now() + 60000 
                        });
                        app.speak('å°å°ç™¼å‹•');
                        app.state.activeItem = null; 
                        app.renderActiveItemStatus();
                        app.renderStudentInventory(app.state.gameData.players);
                        return count - 1;
                    } else {
                        app.toast('âŒ é“å…·æ•¸é‡ä¸è¶³ï¼');
                        return count; 
                    }
                });
                return; 
            }

            // v3.4.0: æ™‚ä¹‹æ²™é˜»æ“‹æª¢æŸ¥
            const frozen = app.state.gameData.frozenState;
            if (frozen && frozen.endTime > Date.now() && frozen.byTeam !== app.state.myTeam) {
                return app.toast(`â„ï¸ æ™‚é–“å·²è¢« ${app.getTeamShortName(frozen.byTeam)} å‡çµï¼ç„¡æ³•å‹•ä½œï¼`);
            }
            
            // v3.3.1: æª¢æŸ¥å¡ç‰Œæ˜¯å¦è¢«åˆ¥äººé–å®š (ä¸€èˆ¬é»æ“Šç­”é¡Œæ™‚)
            if (card.lockedUntil && card.lockedUntil > Date.now()) {
                if (card.lockedBy !== app.state.myTeam) {
                    app.speak("æ­¤ç‰Œå·²è¢«å°å°");
                    return app.toast(`ğŸ”’ æ­¤ç‰Œå·²è¢«å…¶ä»–éšŠä¼å°å°ï¼`);
                }
            }

            app.state.selectedCardIndex = index;
            app.renderPyramid(app.state.gameData.pyramid);
            app.renderFormulaInput(); 
            
            // [v4.1.1 ä¿®æ”¹] åƒ…é¡¯ç¤ºè¦–è¦ºæç¤ºï¼Œä¸å‘¼å« speak æ’­æ”¾èªéŸ³
            const msg = `å·²é¸æ“‡ç›®æ¨™ï¼š${app.state.gameData.pyramid[index].number}`;
            const el = app.el('msg-toast');
            el.textContent = msg;
            el.style.opacity = '1';
            el.style.top = '100px';
            if(app.state.toastTimer) clearTimeout(app.state.toastTimer);
            app.state.toastTimer = setTimeout(() => { el.style.opacity = '0'; el.style.top = '20px'; }, 2000);
        },

        teacherGetHint: () => {
            if (app.state.gameData.status !== 'playing') return app.toast('âš ï¸ è«‹å…ˆæ“²éª°å­ä¸¦é–‹å§‹éŠæˆ²');
            const { d8, d10, d12 } = app.state.gameData.dice;
            const solution = app.findSolution([d8, d10, d12]);
            
            if (solution) {
    const match = solution.match(/(\d+\s*[\+\-\*\/]\s*\d+)/);
    let hint = match ? match[0] : solution;

    // [ä¿®æ­£] è¦–è¦ºä¸Šé¡¯ç¤ºç‚º Ã— å’Œ Ã·
    let displayHint = hint.replace(/\*/g, 'Ã—').replace(/\//g, 'Ã·');

    app.el('solution-hint-text').textContent = `(${displayHint}) ... ?`;
    app.el('solution-modal').classList.remove('hidden');

    // èªéŸ³éƒ¨åˆ†ç”± speak å‡½å¼çµ±ä¸€è™•ç†
    app.speak("æ³•è€ç‹æç¤ºï¼š" + hint);
} else {
                app.toast("âš ï¸ ç›®å‰çš„éª°å­ä¼¼ä¹ç„¡è§£...");
            }
        },

      teacherRollDice: () => {
            if (app.state.gameData.status === 'rolling' || app.state.gameData.status === 'playing') return;

            db.ref(`classes/${app.state.classId}`).update({
                status: 'rolling',
                dice: { d8: '?', d10: '?', d12: '?' }, // <--- é€™è£¡ä¹Ÿè¦æœ‰é€—è™Ÿ
				// [v4.4.1 ä¿®æ­£] æ“²éª°æ™‚æ›´æ–°æ´»èºæ™‚é–“
                lastActive: firebase.database.ServerValue.TIMESTAMP
            });
            
            if (app.state.voiceEnabled) app.speak("å…¨å“¡å‡ºæ“Š!!");

            const rollInterval = setInterval(() => {
                app.el('t-dice-8').textContent = Math.floor(Math.random() * 8) + 1;
                app.el('t-dice-10').textContent = Math.floor(Math.random() * 10) + 1;
                app.el('t-dice-12').textContent = Math.floor(Math.random() * 12) + 1;
            }, 80);

            setTimeout(() => {
                clearInterval(rollInterval);
                const d8 = Math.floor(Math.random() * 8) + 1;
                const d10 = Math.floor(Math.random() * 10) + 1;
                const d12 = Math.floor(Math.random() * 12) + 1;
                
                const activeTargets = app.state.gameData.pyramid.filter(c => c && !c.isTaken).map(c => c.number);
                let hasSolution = false;
                for (let target of activeTargets) {
                    if (app.findSolution([d8, d10, d12], target)) { hasSolution = true; break; }
                }

                if (!hasSolution) {
                    // v3.2.4: ç™¼ç¾ç„¡è§£ï¼Œå¯«å…¥è³‡æ–™åº« 'dead_end' ç‹€æ…‹ï¼Œè®“å­¸ç”Ÿç«¯åŒæ­¥é¡¯ç¤ºèˆ‡ç™¼è²
                    db.ref(`classes/${app.state.classId}`).update({ 
                        status: 'dead_end',
                        dice: { d8, d10, d12 } 
                    });
                    
                    const msg = `é‡æ–°é–‹å§‹`;
                    if (app.state.voiceEnabled) app.speak(msg);
                    
                    // è€å¸«ç«¯ 3 ç§’å¾Œè‡ªå‹•è§¸ç™¼ä¸‹ä¸€å±€
                    setTimeout(() => app.forceNextRound(), 3000);
                } else {
                    // v4.5.0: ä½¿ç”¨å…¨åŸŸè¨­å®šçš„æ™‚é–“ (é è¨­ 120)
                    const globalTime = app.state.globalSettings?.baseTimer || 120;
                    
                    db.ref(`classes/${app.state.classId}`).update({
                        status: 'playing',
                        dice: { d8, d10, d12 },
                        timerActive: true, // ä¿®æ”¹ï¼šæ“²éª°å¾Œç«‹å³é–‹å§‹å€’æ•¸
                        timer: globalTime 
                    });
                    if (app.state.voiceEnabled) app.speak(`æ“²éª°çµæœï¼š${d8}ã€${d10}ã€${d12}ã€‚`);
                }
            }, 1500);
        },

        

       // [v3.1.0] ä¸‹è¼‰éŠæˆ²è³‡æ–™ (HTML å ±è¡¨)
        downloadGameData: () => {
            const players = app.state.gameData.players || {};
            const date = new Date().toLocaleDateString();
            const classId = app.state.classId;
            
            let tableRows = '';
            // æ•´ç†è³‡æ–™
            let allPlayers = [];
            Object.keys(players).forEach(teamKey => {
                Object.values(players[teamKey]).forEach(p => {
                    allPlayers.push({...p, teamName: app.getTeamName(teamKey)});
                });
            });
            allPlayers.sort((a, b) => b.score - a.score);

            allPlayers.forEach((p, i) => {
                tableRows += `<tr style="background:${i%2===0?'#fff':'#f9fafb'}"><td style="padding:10px;border:1px solid #ddd;text-align:center">${i+1}</td><td style="padding:10px;border:1px solid #ddd">${p.name}</td><td style="padding:10px;border:1px solid #ddd">${p.teamName}</td><td style="padding:10px;border:1px solid #ddd;font-weight:bold;color:#b45309">${p.score}</td></tr>`;
            });

            // å»ºç«‹ç°¡æ˜“ HTML å ±è¡¨
            const reportHTML = `<!DOCTYPE html><html lang="zh-TW"><head><meta charset="UTF-8"><title>ç¥æ®¿è©¦ç…‰æˆ°ç¸¾è¡¨ - ${classId}</title><style>body{font-family:sans-serif;padding:20px;background:#fffbeb}table{width:100%;border-collapse:collapse;margin-top:20px;background:white}th{background:#d97706;color:white;padding:12px}h1{color:#92400e}</style></head><body><h1>ğŸº æ³•è€å¯†ç¢¼æˆ°ç¸¾è¡¨</h1><p><strong>ç­ç´šä»£ç¢¼ï¼š</strong>${classId} <span style="margin-left:20px"><strong>æ—¥æœŸï¼š</strong>${date}</span></p><table><thead><tr><th>æ’å</th><th>å§“å</th><th>å°çµ„</th><th>åˆ†æ•¸</th></tr></thead><tbody>${tableRows}</tbody></table><p style="margin-top:20px;color:#666;font-size:12px">ç”± æ³•è€å¯†ç¢¼ v3.2.6 ç³»çµ±è‡ªå‹•ç”Ÿæˆ</p></body></html>`;

            const blob = new Blob([reportHTML], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `ç¥æ®¿è©¦ç…‰_æˆ°ç¸¾_${classId}_${new Date().getTime()}.html`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            app.toast('ğŸ“¥ æˆ°ç¸¾è¡¨ä¸‹è¼‰ä¸­...');
        },

       // [v3.1.2] å„ªåŒ–å¾Œçš„é‡ç½®é‚è¼¯ï¼šä½¿ç”¨ Promise é¿å…é˜»å¡ä¸»åŸ·è¡Œç·’
       // [v3.1.5] å„ªåŒ–å¾Œçš„é‡ç½®é‚è¼¯ï¼šè¨­å®šç‹€æ…‹è®“æ‰€æœ‰äººçœ‹åˆ°ã€Œå›åˆ°åˆå§‹ä¹‹åœ°ã€æŒ‰éˆ•
        resetGame: async () => {
             if(!confirm('âš ï¸ ç¢ºå®šè¦é–‹å•Ÿæ–°çš„ä¸€å±€å—ï¼Ÿ\n\n1. æ‰€æœ‰åˆ†æ•¸å°‡æ­¸é›¶ã€‚\n2. æ‰€æœ‰äººå°‡çœ‹åˆ°ã€Œå›åˆ°åˆå§‹ä¹‹åœ°ã€æŒ‰éˆ•ã€‚\n3. è«‹ç¢ºèªå·²ä¸‹è¼‰æˆ°ç¸¾è¡¨ã€‚')) {
                 return;
             }

             try {
                 app.el('game-over-modal').classList.add('hidden');
                 app.state.isResetting = true; // æ¨™è¨˜è‡ªå·±ï¼Œé¿å…ç•«é¢é–ƒçˆ

                 // 1. ç”¢ç”Ÿæ–°çš„éŠæˆ²åˆå§‹è³‡æ–™
                 const initialData = app.generateInitialGameData();
                 
                 // 2. è¨­å®šè³‡æ–™åº«ç‹€æ…‹ç‚º reset_completedï¼Œä¸¦é‡ç½®æ‰€æœ‰è³‡æ–™
                 // é€™æ¨£æ‰€æœ‰å®¢æˆ¶ç«¯æ”¶åˆ°é€šçŸ¥å¾Œï¼Œå°±æœƒé¡¯ç¤ºå…¨è¢å¹•çš„æŒ‰éˆ•
                 // [v4.3.1] é‡ç½®æ™‚æ›´æ–° lastActiveï¼Œç¢ºä¿æˆ¿é–“é‡æ–°å‡ºç¾åœ¨å¤§å»³
                 await db.ref(`classes/${app.state.classId}`).set({
                    status: 'reset_completed', 
                    dice: { d8: '-', d10: '-', d12: '-' },
                    round: 1,
                    timer: 30,
                    timerActive: false,
                    pyramid: initialData.pyramid,
                    decks: initialData.decks,
                    lastActive: firebase.database.ServerValue.TIMESTAMP, // é—œéµï¼šè®“æˆ¿é–“å†æ¬¡æµ®ä¸Šå¤§å»³
                    autoRoll: app.el('admin-auto-roll').checked,
                    endlessMode: app.el('admin-endless-mode').checked
                 });
                 
                 app.toast('ğŸ”„ éŠæˆ²å·²é‡ç½®ï¼Œç­‰å¾…å†’éšªè€…å›æ­¸...');
                 
                 // è€å¸«è‡ªå·±ä¹Ÿé¡¯ç¤ºè©²é®ç½© (ç”± listenToGameData è™•ç†)
                 
             } catch (err) {
                 console.error("Reset failed:", err);
                 alert('é‡ç½®éç¨‹ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹æ‰‹å‹•é‡æ–°æ•´ç†é é¢ã€‚');
                 location.reload();
             }
        },
        
      forceNextRound: () => {
            const gameData = app.state.gameData;
            if (!gameData || !gameData.decks) return;

            // --- [v4.4.9] æ€ªç‰©æ”»æ“Šåˆ¤å®šé‚è¼¯ (Mode 1, 2, 4 ç²¾æº–åˆ†æµèˆ‡äº’æ–¥) ---
            const monster = gameData.activeMonster;
            
            // åªæœ‰ç•¶æ€ªç‰©è™•æ–¼æˆ°é¬¥ç‹€æ…‹æ‰é€²è¡Œåˆ¤æ–·
            if (monster && monster.state === 'battle') {
                let shouldAttack = false;
                let attackReason = "";
                let specificSpeech = ""; // å°ˆç”¨å–Šè©±è®Šæ•¸

                // 1. è¨ˆç®—å ´ä¸Šå¡ç‰Œç‹€æ…‹
                const currentPyramid = gameData.pyramid || [];
                const remainingCount = currentPyramid.filter(c => c && !c.isTaken).length;
                const totalSlots = 10; 
                // æœ¬å±€å·²è§£é–‹çš„å¡ç‰Œæ•¸ (ç”¨ä¾†åˆ¤æ–·ç©å®¶æ˜¯å¦æœ‰é€²è¡Œæ”»æ“Š)
                const takenCount = totalSlots - remainingCount;

                // 2. åˆ¤æ–·æ˜¯å¦ç‚ºã€Œæ™‚é–“åˆ°ã€ (timer === 0)
                const isTimeUp = (gameData.timer === 0);

                // --- åˆ¤å®šé‚è¼¯é–‹å§‹ (äº’æ–¥çµæ§‹) ---

                // [å„ªå…ˆæª¢æ¸¬] Mode 4: æ¯Nå›åˆå…¨é«”æ”»æ“Š (å›åˆé–‹å§‹å‰/çµæŸæ™‚æª¢æ¸¬)
                // é‚è¼¯ï¼šä¸‹ä¸€å›åˆæ˜¯ç¬¬å¹¾å±€ï¼Ÿ
                const nextRoundNum = (gameData.round || 1) + 1;
                if (monster.mode4 > 0 && nextRoundNum % monster.mode4 === 0) {
                     // è§¸ç™¼é€±æœŸæ€§æ”»æ“Š
                     shouldAttack = true;
                     attackReason = "mode4_periodic";
                     specificSpeech = `é­”ç‰©æš´èµ°ï¼`;
                }

                // [æ™‚é–“åˆ°æª¢æ¸¬] Mode 1 vs Mode 2 (åƒ…åœ¨æ™‚é–“åˆ°æ™‚è§¸ç™¼ï¼Œä¸”äº’æ–¥)
                if (isTimeUp && !shouldAttack) { // å¦‚æœå·²ç¶“è§¸ç™¼ Mode 4ï¼Œå‰‡å„ªå…ˆæ¬Šçµ¦ Mode 4ï¼Œæˆ–å¯ç–ŠåŠ (è¦–éœ€æ±‚)ï¼Œæ­¤è™•è¨­ç‚ºä¸ç–ŠåŠ é¿å…æ··äº‚
                    
                    if (takenCount > 0) {
                        // æƒ…æ³ A: ç©å®¶æœ‰é€²è¡Œæ”»æ“Š (takenCount > 0)ï¼Œä½†æ²’è§£å®Œ
                        // ---> æª¢æ¸¬ Mode 1 (è¢«å‹•åæ“Š)
                        if (monster.mode1 && remainingCount > 0) {
                            shouldAttack = true;
                            attackReason = "mode1_counter";
                            specificSpeech = "é­”ç‰©åæ“Šï¼";
                        } else {
                            // Mode 1 æœªé–‹å•Ÿï¼Œä¸”ç©å®¶æœ‰è§£é¡Œ -> ç´”ç²¹æ™‚é–“åˆ°ï¼Œå®‰å…¨
                            specificSpeech = "æ™‚é–“åˆ°ï¼åšå¾—å¥½ï¼";
                        }
                    } else {
                        // æƒ…æ³ B: ç©å®¶å®Œå…¨æ²’æœ‰æ”»æ“Š (takenCount === 0)
                        // ---> æª¢æ¸¬ Mode 2 (ä¸»å‹•æ”»æ“Š)
                        if (monster.mode2) {
                            shouldAttack = true;
                            attackReason = "mode2_active";
                            specificSpeech = "æ™‚é–“åˆ°ï¼Œé­”ç‰©ä¸»å‹•æ”»æ“Šï¼";
                        } else {
                            // Mode 2 æœªé–‹å•Ÿï¼Œä¸”ç©å®¶ç™¼å‘† -> ç´”ç²¹æ™‚é–“åˆ°ï¼Œå®‰å…¨
                            specificSpeech = "æ™‚é–“åˆ°ï¼Œé­”ç‰©æ­£åœ¨è§€å¯Ÿ...";
                        }
                    }
                }

                // [åŸ·è¡Œçµæœ]
                if (shouldAttack) {
                    console.log(`ğŸ‘¹ æ€ªç‰©ç™¼å‹•æ”»æ“Šï¼åŸå› ï¼š${attackReason} (å·²è§£:${takenCount}, å‰©é¤˜:${remainingCount})`);
                    
                    // å¯«å…¥æ”»æ“Šè¨Šè™Ÿ
                    db.ref(`classes/${app.state.classId}/activeMonster`).update({
                        action: 'attack',
                        actionTime: firebase.database.ServerValue.TIMESTAMP
                    });

                    // æ’­æ”¾å°æ‡‰èªéŸ³
                    if (specificSpeech) app.speak(specificSpeech);

                } else {
                    // è‹¥æ²’æœ‰æ”»æ“Šï¼Œä½†æœ‰è¨­å®šå¥½çš„èªéŸ³ (ä¾‹å¦‚ç´”æ™‚é–“åˆ°)ï¼Œå‰‡åœ¨æ­¤æ’­æ”¾
                    // è§£æ±ºã€Œæ™‚é–“åˆ°ã€èªéŸ³é‡è¤‡å•é¡Œï¼šåªåœ¨é€™è£¡æ’­æ”¾ä¸€æ¬¡
                    if (specificSpeech) app.speak(specificSpeech);
                }
            }
            // --- [ä¿®æ”¹çµæŸ] ---

            // [v4.1.9 ä¿®æ­£] é›™é‡æª¢æŸ¥ç„¡ç›¡æ¨¡å¼è¨­å®š
            // 1. å„ªå…ˆè®€å–æˆ¿é–“æœ¬èº«çš„è¨­å®š
            let isEndless = gameData.endlessMode;

            // 2. å¦‚æœæˆ¿é–“æ²’æœ‰è¨­å®š (undefined)ï¼Œå‰‡è®€å– GM å…¨åŸŸè¨­å®šä½œç‚ºå‚™æ¡ˆ
            if (isEndless === undefined || isEndless === null) {
                if (app.state.globalSettings && app.state.globalSettings.endlessMode === true) {
                    isEndless = true;
                } else {
                    isEndless = false;
                }
            }

            const newPyramid = [...(gameData.pyramid || [])];
            // æ·±æ‹·è²ç‰Œåº«ï¼Œé¿å…ç›´æ¥ä¿®æ”¹ stateï¼Œç¢ºä¿ç¨å¾Œå¯«å…¥ DB è³‡æ–™æ­£ç¢º
            const newDecks = JSON.parse(JSON.stringify(gameData.decks));

            let hasRefilled = false;
            let cannotRefill = false;
            let endlessRefilledMsg = "";

            // v3.7.1 æœ¨ä¹ƒä¼Šè©›å’’å€’æ•¸
            newPyramid.forEach(card => {
                if (card && !card.isTaken && card.curseData) {
                    card.curseData.roundsLeft -= 1;
                    if (card.curseData.roundsLeft <= 0) delete card.curseData;
                }
            });

            const slots = [
                { idx: 0, color: 'black' }, { idx: 1, color: 'red' }, { idx: 2, color: 'red' },
                { idx: 3, color: 'blue' }, { idx: 4, color: 'blue' }, { idx: 5, color: 'blue' },
                { idx: 6, color: 'yellow' }, { idx: 7, color: 'yellow' }, { idx: 8, color: 'yellow' }, { idx: 9, color: 'yellow' }
            ];

            // --- [v4.2.4 å„ªåŒ–] é å…ˆæª¢æŸ¥ï¼šæ˜¯å¦éœ€è¦å…¨åŸŸæ´—ç‰Œ (ç„¡ç›¡æ¨¡å¼) ---
            let needsGlobalRefill = false;

            for (const slot of slots) {
                // è‹¥è©²ä½ç½®æ˜¯ç©ºçš„æˆ–å·²è¢«æ‹¿èµ°ï¼Œéœ€è¦è£œç‰Œ
                if (!newPyramid[slot.idx] || newPyramid[slot.idx].isTaken) {
                    // æª¢æŸ¥å°æ‡‰é¡è‰²çš„ç‰Œåº«æ˜¯å¦ç‚ºç©º
                    if (!newDecks[slot.color] || newDecks[slot.color].length === 0) {
                        if (isEndless === true) {
                            needsGlobalRefill = true; // æ¨™è¨˜éœ€è¦å…¨åŸŸé‡ç½®
                            break; // åªè¦æœ‰ä¸€å€‹é¡è‰²ç¼ºç‰Œï¼Œå°±è·³å‡ºæª¢æŸ¥ï¼Œç›´æ¥è§¸ç™¼å…¨é«”é‡ç½®
                        } else {
                            cannotRefill = true; // éç„¡ç›¡æ¨¡å¼ï¼Œæ¨™è¨˜ç‚ºç„¡æ³•è£œç‰Œ (éŠæˆ²çµæŸ)
                        }
                    }
                }
            }

            // --- [v4.2.4 å¯¦ä½œ] åŸ·è¡Œå…¨åŸŸæ´—ç‰Œ (é‡å°æ‰€æœ‰é¡è‰²) ---
            if (needsGlobalRefill) {
                // 1. ç”¢ç”Ÿå…¨æ–°å®Œæ•´ç‰Œåº«
                const fullDecks = app.createFullDeck();

                // 2. æ‰¾å‡ºç›®å‰å ´ä¸Šã€Œæ®˜ç•™ã€çš„å¡ç‰Œ (é¿å…æ´—å‡ºé‡è¤‡çš„ç‰Œ)
                const currentOnBoard = newPyramid.filter(c => c && !c.isTaken);

                // 3. é‡å°å››ç¨®é¡è‰²ï¼Œåˆ†åˆ¥éæ¿¾æ‰å ´ä¸Šçš„ç‰Œï¼Œç„¶å¾Œæ´—ç‰Œå¡«å…¥ newDecks
                ['black', 'red', 'blue', 'yellow'].forEach(color => {
                    const freshCards = fullDecks[color];
                    const onBoardNums = currentOnBoard.filter(c => c.color === color).map(c => c.number);
                    // éæ¿¾ -> æ´—ç‰Œ -> è³¦å€¼ (ç¢ºä¿æ‰€æœ‰é¡è‰²éƒ½è£œæ»¿)
                    newDecks[color] = app.shuffle(freshCards.filter(c => !onBoardNums.includes(c.number)));
                });

                endlessRefilledMsg = "â™¾ï¸ ç‰Œåº«èƒ½é‡è€—ç›¡ï¼Œæ™‚å…‰å›æº¯ï¼å…¨å½©ç‰Œåº«å·²é‡ç½®ï¼";
            }

            // --- åŸ·è¡Œè£œç‰Œå‹•ä½œ ---
            if (cannotRefill) {
                app.triggerEndGame();
                app.toast('ğŸ ç‰Œåº«è€—ç›¡ï¼Œå†’éšªçµæŸï¼');
            } else {
                // ä¾åºå¡«è£œç©ºç¼º
                slots.forEach(slot => {
                    if (!newPyramid[slot.idx] || newPyramid[slot.idx].isTaken) {
                        // å†æ¬¡æª¢æŸ¥ (å› ç‚ºå¦‚æœè§¸ç™¼äº†å…¨åŸŸæ´—ç‰Œï¼Œé€™è£¡ä¸€å®šæœƒæœ‰ç‰Œ)
                        if (newDecks[slot.color] && newDecks[slot.color].length > 0) {
                            newPyramid[slot.idx] = newDecks[slot.color].pop();
                            hasRefilled = true;
                        }
                    }
                });

                const nextRound = (gameData.round || 1) + 1;
                const updates = {
                    status: 'waiting',
                    dice: { d8: '-', d10: '-', d12: '-' },
                    timerActive: false,
                    pyramid: newPyramid,
                    decks: newDecks,
                    round: nextRound,
                    endlessMode: isEndless,
                    // [v4.4.1 ä¿®æ­£] æ¯æ¬¡æ›å±€éƒ½æ›´æ–°æ´»èºæ™‚é–“ï¼Œé˜²æ­¢æˆ¿é–“åœ¨å¤§å»³æ¶ˆå¤±
                    lastActive: firebase.database.ServerValue.TIMESTAMP
                };

                db.ref(`classes/${app.state.classId}`).update(updates);

                // è§¸ç™¼è‡ªå‹•ç™¼æ”¾
                if (app.state.isHost) {
                    app.processAutoGrant(nextRound);
                }

                if (endlessRefilledMsg) {
                    app.toast(endlessRefilledMsg);
                    app.speak('æ™‚å…‰å›æº¯ï¼Œç‰Œåº«é‡ç½®');
                } else {
                    app.toast(hasRefilled ? 'è£œç‰Œ' : 'é€²å…¥ä¸‹ä¸€å›åˆ');
                }
            }
        },

        // v3.0.9: è§¸ç™¼éŠæˆ²çµæŸ
        
        triggerEndGame: () => {
            // v4.0.8: æˆ¿ä¸»ä¹Ÿæœ‰æ¬Šé™çµæŸéŠæˆ²
            if (app.state.role === 'teacher' || app.state.isHost) {
                db.ref(`classes/${app.state.classId}`).update({
                    status: 'ended',
                    timerActive: false
                });
            }
        },
        
        

        // v4.0.2: çµ±ä¸€åç¨±
        getTeamName: (key) => {
            // ç‚ºäº†ç›¸å®¹èˆŠè³‡æ–™çµæ§‹ï¼Œå°‡æ‰€æœ‰ teamKey éƒ½é¡¯ç¤ºç‚ºåŒä¸€åç¨±
            return 'ğŸ›¡ï¸ å†’éšªå°éšŠ';
        },
        
        getTeamShortName: (key) => {
             return 'å†’éšªè€…';
        },

        // --- 6. v3.0.8 å¼·åŒ–ç‰ˆè¼¸å…¥æ§åˆ¶ ---
        renderFormulaInput: () => {
            const displayEl = app.el('formula-display');
            const val = app.state.inputFormula;
            const pos = app.state.inputCursorPos;
            
            // æ’å…¥æ¸¸æ¨™ HTML
            const part1 = val.substring(0, pos);
            const part2 = val.substring(pos);
            
            // å¦‚æœå…§å®¹ç‚ºç©ºï¼Œé¡¯ç¤ºæç¤ºå­— (ä½†ä¿ç•™æ¸¸æ¨™)
            if (val === '') {
                displayEl.innerHTML = `<span class="cursor-blink"></span><span class="text-gray-300 ml-1">é»æ“Šä¸‹æ–¹æŒ‰éˆ•</span>`;
            } else {
                displayEl.innerHTML = `${part1}<span class="cursor-blink"></span>${part2}`;
            }
        },

        resetInput: () => {
            app.state.inputFormula = "";
            app.state.inputCursorPos = 0;
            app.renderFormulaInput();
        },

        inputChar: (char) => {
            if (app.state.role !== 'student') return;
            
            // v3.6.0: æª¢æŸ¥æ˜¯å¦è¢«é˜¿åŠªæ¯”æ–¯å°å°
            if (app.state.activeItem === 'anubis' && char === app.state.anubisBannedOp) {
                app.speak('æ­¤ç¬¦è™Ÿå·²è¢«å°å°');
                return app.toast(`ğŸš« å¯©åˆ¤é€²è¡Œä¸­ï¼ç¦æ­¢ä½¿ç”¨ã€Œ${char}ã€`);
            }

            const val = app.state.inputFormula;
            const pos = app.state.inputCursorPos;
            
            app.state.inputFormula = val.substring(0, pos) + char + val.substring(pos);
            app.state.inputCursorPos = pos + String(char).length;
            app.renderFormulaInput();
        },

        backspace: () => {
             const val = app.state.inputFormula;
             const pos = app.state.inputCursorPos;
             if (pos > 0) {
                 app.state.inputFormula = val.substring(0, pos - 1) + val.substring(pos);
                 app.state.inputCursorPos = pos - 1;
             }
             app.renderFormulaInput();
        },

        moveCursor: (direction) => {
            const pos = app.state.inputCursorPos;
            const len = app.state.inputFormula.length;
            app.state.inputCursorPos = direction === -1 ? Math.max(0, pos - 1) : Math.min(len, pos + 1);
            app.renderFormulaInput();
        },

     // v3.3.0 æ›´æ–°ï¼šé©—è­‰é‚è¼¯ (æ”¯æ´è·é­¯æ–¯ä¹‹çœ¼èˆ‡å°¼ç¾…æ²³æ©è³œ)
       // v3.3.1 æ›´æ–°ï¼šé©—è­‰é‚è¼¯ (ä¿®æ­£å°¼ç¾…æ²³æŒçºŒæ•ˆæœèˆ‡è·é­¯æ–¯æ¶ˆè€—)
      // v3.3.2 ä¿®æ­£ï¼šå¼·åˆ¶éª°å­å‹åˆ¥è½‰æ›ï¼Œä¿®å¾©é“å…·å¡é©—è­‰éŒ¯èª¤èˆ‡å››å‰‡é‹ç®—ç¬¦è™Ÿé‚è¼¯
   
       // [v4.3.4] æäº¤ç­”æ¡ˆ (æ•´åˆæ€ªç‰©æ‰£è¡€æ©Ÿåˆ¶)
        submitAnswer: () => {
            const idx = app.state.selectedCardIndex;
            if (idx === null) return app.toast('âš ï¸ è«‹å…ˆé»æ“Šé‡‘å­—å¡”ä¸Šçš„æ•¸å­—ï¼');
            
            // æª¢æŸ¥æ˜¯å¦è™•æ–¼æ€ªç‰©æœªå¬å–šç‹€æ…‹
            if (app.state.gameData?.activeMonster?.state !== 'battle') {
                return app.toast('ğŸ›¡ï¸ è«‹ç­‰å¾…æˆ¿ä¸»é­é‡é­”ç‰©å¾Œå†é€²è¡Œæ”»æ“Šï¼');
            }

            const frozen = app.state.gameData.frozenState;
            if (frozen && frozen.endTime > Date.now() && frozen.byTeam !== app.state.myTeam) {
                app.speak("æ™‚é–“å‡çµä¸­ï¼Œç„¡æ³•é€å‡ºç­”æ¡ˆ");
                return app.toast(`â„ï¸ æ™‚é–“å·²è¢« ${app.getTeamShortName(frozen.byTeam)} å‡çµï¼ç„¡æ³•é€å‡ºï¼`);
            }
            
            const card = app.state.gameData.pyramid[idx];
            if (!card || card.isTaken) return app.toast('ğŸš« æ™šäº†ä¸€æ­¥ï¼é€™å¼µç‰Œå·²ç¶“è¢«æ‹¿èµ°äº†ã€‚');
            
            const formula = app.state.inputFormula;
            const activeItem = app.state.activeItem;

            // æª¢æŸ¥é˜¿åŠªæ¯”æ–¯ç¦å¿Œç¬¦è™Ÿ
            if (activeItem === 'anubis' && app.state.anubisBannedOp) {
                if (formula.includes(app.state.anubisBannedOp)) {
                    app.speak('å¯©åˆ¤å¤±æ•—ï¼Œä½¿ç”¨äº†ç¦å¿Œç¬¦è™Ÿ');
                    return app.toast(`ğŸš« å¯©åˆ¤é€²è¡Œä¸­ï¼ç®—å¼å…§åŒ…å«è¢«å°å°çš„ã€Œ${app.state.anubisBannedOp}ã€ï¼Œç„¡æ³•é€å‡ºï¼`);
                }
            }

            const rawDice = app.state.dice;
            const diceNums = [rawDice.d8, rawDice.d10, rawDice.d12].map(n => Number(n)).sort((a,b) => a - b);
            const formulaNums = (formula.match(/\d+/g) || []).map(Number).sort((a,b) => a - b);
            
            let isUsageValid = false;

            // é©—è­‰éª°å­ä½¿ç”¨è¦å‰‡ (å«é“å…·)
            if (activeItem === 'nile') {
                if (formulaNums.length === 2) {
                    const tempDice = [...diceNums];
                    let matchCount = 0;
                    formulaNums.forEach(num => {
                        const foundIdx = tempDice.indexOf(num);
                        if (foundIdx !== -1) {
                            tempDice.splice(foundIdx, 1);
                            matchCount++;
                        }
                    });
                    if (matchCount === 2) isUsageValid = true;
                }
                if (formulaNums.length === 3 && JSON.stringify(diceNums) === JSON.stringify(formulaNums)) {
                    isUsageValid = true;
                }
                if (!isUsageValid) return app.toast('âŒ å°¼ç¾…æ²³è¦å‰‡ï¼šè«‹è¼¸å…¥åŒ…å«ã€Œ2é¡†ã€éª°å­æ•¸å­—çš„å…¬å¼ã€‚');

            } else if (activeItem === 'horus') {
                if (formulaNums.length === 3) {
                    const tempDice = [...diceNums];
                    let matchCount = 0;
                    let wildcardUsed = false;
                    const remainingFormulaNums = [];
                    formulaNums.forEach(num => {
                        const foundIdx = tempDice.indexOf(num);
                        if (foundIdx !== -1) {
                            tempDice.splice(foundIdx, 1); 
                            matchCount++;
                        } else {
                            remainingFormulaNums.push(num);
                        }
                    });
                    if (matchCount === 2 && remainingFormulaNums.length === 1) {
                        const wildcard = remainingFormulaNums[0];
                        if (wildcard >= 1 && wildcard <= 3) {
                            isUsageValid = true;
                        }
                    }
                    if (matchCount === 3) isUsageValid = true;
                }
                if (!isUsageValid) return app.toast('âŒ è·é­¯æ–¯è¦å‰‡ï¼šéœ€ç”¨ 2 é¡†åŸéª°å­ + 1 é¡†è®Šèº«æ•¸å­—(1~3)ã€‚');

            } else {
                if (JSON.stringify(diceNums) === JSON.stringify(formulaNums)) {
                    isUsageValid = true;
                }
                if (!isUsageValid) return app.toast('âŒ æ•¸å­—éŒ¯èª¤ï¼è«‹ç”¨å®Œæ‰€æœ‰éª°å­ã€‚');
            }

            try {
                // é‹ç®—é©—è­‰
                const codeFormula = formula.replace(/Ã—/g, '*').replace(/Ã·/g, '/');
                const cleanFormula = codeFormula.replace(/[^-()\d/*+.]/g, '');
                
                if (!cleanFormula || /[^0-9+\-*/(). ]/.test(cleanFormula)) {
                    throw new Error('Invalid formula');
                }

                const result = new Function(`return ${cleanFormula}`)();
                
               if (Math.abs(result - card.number) < 0.001) {
                    // --- é©—è­‰æˆåŠŸï¼šè¨ˆç®—åˆ†æ•¸èˆ‡å‚·å®³ ---
                    let points = card.points;
                    let playerName = app.state.myName;
                    let successMsg = `${playerName}è§£è¬æˆåŠŸï¼`;
                    let itemToConsume = null;
                    let curseTriggered = false;

                    // è©›å’’åˆ¤å®š
                    if (card.curseData && card.curseData.team !== app.state.myTeam) {
                        curseTriggered = true;
                        points = -Math.abs(points); // åˆ†æ•¸å€’æ‰£ï¼Œä¸æœƒå°æ€ªç‰©é€ æˆå‚·å®³
                        successMsg = `ğŸ˜± ç³Ÿäº†ï¼${playerName} è§¸ç™¼äº†æœ¨ä¹ƒä¼Šçš„è©›å’’ï¼åˆ†æ•¸å€’æ‰£ï¼`;
                    }

                    // é“å…·åŠ æˆåˆ¤å®š
                    if (activeItem === 'double') {
                        points *= 2;
                        if (curseTriggered) successMsg += " (è–ç”²èŸ²è®“å‚·å®³åŠ å€äº†!)";
                        else successMsg = `æ­å–œ${playerName}ï¼è–ç”²èŸ²ç™¼å¨ï¼Œåˆ†æ•¸é›™å€ï¼`;
                        itemToConsume = 'double';
                        app.state.activeItem = null; 
                    } else if (activeItem === 'anubis') {
                        points *= 3;
                        if (curseTriggered) successMsg += " (é˜¿åŠªæ¯”æ–¯è®“æ‡²ç½°è®Šä¸‰å€!)";
                        else successMsg = `âš–ï¸ å¯©åˆ¤é€šéï¼${playerName} åœ¨é™åˆ¶ä¸‹ç ´è§£è¬é¡Œï¼Œåˆ†æ•¸ä¸‰å€ï¼`;
                        itemToConsume = 'anubis';
                        app.state.activeItem = null;
                        app.state.anubisBannedOp = null;
                    } else if (activeItem === 'horus') {
                        if(!curseTriggered) successMsg = `æ­å–œ${playerName}ï¼è·é­¯æ–¯ä¹‹åŠ›ç ´è§£æˆåŠŸï¼`;
                        itemToConsume = 'horus';
                        app.state.activeItem = null; 
                    } else if (activeItem === 'nile') {
                        if(!curseTriggered) successMsg = `æ­å–œ${playerName}ï¼å°¼ç¾…æ²³æ©è³œé‹ç®—æˆåŠŸï¼`;
                        itemToConsume = 'nile';
                    }

                    // æ¶ˆè€—é“å…·
                    if (itemToConsume) {
                        const itemRef = db.ref(`classes/${app.state.classId}/players/${app.state.myTeam}/${app.state.myName}/items/${itemToConsume}`);
                        itemRef.transaction(count => Math.max(0, (count || 0) - 1));
                    }

                    app.renderStudentInventory(app.state.gameData.players);
                    app.renderActiveItemStatus();

                    // å»ºæ§‹æ›´æ–°è³‡æ–™
                    const updates = {};
                    updates[`pyramid/${idx}/isTaken`] = true;
                    
                    // [v4.4.1 ä¿®æ­£] åªè¦æœ‰äººç­”å°ï¼Œå°±æ›´æ–°æˆ¿é–“æ´»èºæ™‚é–“
                    updates['lastActive'] = firebase.database.ServerValue.TIMESTAMP;

                    // æ›´æ–°ç©å®¶åˆ†æ•¸
                    const scorePath = `players/${app.state.myTeam}/${app.state.myName}/score`;
                    const currentScore = (app.state.gameData.players?.[app.state.myTeam]?.[app.state.myName]?.score || 0);
                    updates[scorePath] = currentScore + points;
                    
                    updates['lastWinner'] = {
                        name: app.state.myName,
                        timestamp: firebase.database.ServerValue.TIMESTAMP
                    };

                    // [v4.3.7] æ€ªç‰©æ‰£è¡€èˆ‡ç‰¹æ•ˆåŒæ­¥é‚è¼¯
                    let monsterDied = false;
                    if (points > 0) {
                        const damage = points;
                        const currentMonsterHp = app.state.gameData.activeMonster?.currentHp || 0;
                        const newMonsterHp = Math.max(0, currentMonsterHp - damage);
                        
                        updates['activeMonster/currentHp'] = newMonsterHp;
                        // åŒæ­¥ç™¼é€å—å‚·ç‰¹æ•ˆè¨Šè™Ÿ
                        updates['activeMonster/action'] = 'damage';
                        updates['activeMonster/actionTime'] = firebase.database.ServerValue.TIMESTAMP;
                        
                        successMsg += ` (é€ æˆ ${damage} é»å‚·å®³!)`;
                        
                        if (newMonsterHp <= 0) {
                            monsterDied = true;
                        }
                    }
                    if (monsterDied) {
                        updates['status'] = 'ended';
                        updates['timerActive'] = false;
                        successMsg += " âš”ï¸ é­”ç‰©å·²å€’ä¸‹ï¼å†’éšªå°éšŠç²å‹ï¼";
                        app.speak(successMsg);
                        
                        // æ’­æ”¾å‹åˆ©å‹•ç•« (ç¨å¾Œç”± updateUI è™•ç†)
                        setTimeout(() => app.toast("ğŸ† æ­å–œï¼é­”ç‰©å·²è¢«æ“Šæ•—ï¼"), 1000);
                    } else {
                        // æ€ªç‰©æœªæ­»ï¼Œç¹¼çºŒéŠæˆ²æµç¨‹
                        // v4.5.0: ä½¿ç”¨å…¨åŸŸè¨­å®šçš„é‡ç½®æ™‚é–“ (é è¨­ 45)
                        const resetTime = app.state.globalSettings?.resetTimer || 45;
                        
                        updates['timerActive'] = true;
                        updates['timer'] = resetTime; 
                        app.speak(successMsg + " å€’æ•¸é–‹å§‹ï¼");
                    }

                    // åŸ·è¡Œä¸€æ¬¡æ€§æ›´æ–°
                    db.ref(`classes/${app.state.classId}`).update(updates);
                    app.resetInput();
                    app.state.selectedCardIndex = null;
                    
                  

                } else {
                    const displayResult = Math.round(result * 100) / 100;
                    app.toast(`âŒ è¨ˆç®—çµæœæ˜¯ ${displayResult}ï¼Œç›®æ¨™æ˜¯ ${card.number} å–”ï¼`);
                }
            } catch (e) {
                console.error(e);
                app.toast('âŒ å…¬å¼éŒ¯èª¤ï¼Œè«‹æª¢æŸ¥æ‹¬è™Ÿæˆ–é‹ç®—ç¬¦è™Ÿã€‚');
            }
        },

      handleTimeUp: () => {
            // v3.2.4: æ™‚é–“åˆ°ï¼Œè‡ªå‹•æ›ä¸‹ä¸€å±€ (ä¿®æ­£ï¼šç§»é™¤æ­¤è™•èªéŸ³ï¼Œæ”¹ç”± forceNextRound çµ±ä¸€åˆ¤æ–·æƒ…å¢ƒå¾Œæ’­æ”¾ï¼Œé¿å…é‡è¤‡)
            
            // v4.1.0: ç¢ºä¿ä¸»æ§è€…åœ¨ 2 ç§’ç·©è¡å¾Œå¼·åˆ¶é€²å…¥ä¸‹ä¸€å±€
            if (app.state.role === 'teacher' || app.state.isHost) {
                console.log("â³ æ™‚é–“åˆ°ï¼Œä¸»æ§è€…å°‡åœ¨ 2 ç§’å¾ŒåŸ·è¡Œä¸‹ä¸€å±€...");
                setTimeout(() => {
                    app.forceNextRound();
                }, 2000);
            }
        },

        findSolution: (nums, specificTarget = null) => {
             const ops = ['+', '-', '*', '/']; 
             let targets = [];
             if (specificTarget !== null) {
                 targets = [specificTarget];
             } else {
                 targets = app.state.gameData.pyramid.filter(c => c && !c.isTaken).map(c => c.number);
             }
             
             function getPermutations(arr) { if (arr.length === 1) return [arr]; const perms = []; for (let i = 0; i < arr.length; i++) { const first = arr[i], rest = arr.slice(0, i).concat(arr.slice(i + 1)); getPermutations(rest).forEach(sub => perms.push([first, ...sub])); } return perms; }
             
             for (const p of getPermutations(nums)) {
                const [a, b, c] = p;
                for (const op1 of ops) for (const op2 of ops) {
                    try { 
                        let f1 = `(${a} ${op1} ${b}) ${op2} ${c}`;
                        let r1 = eval(f1);
                        if (targets.some(t => Math.abs(t - r1) < 0.001)) return f1;
                        
                        let f2 = `${a} ${op1} (${b} ${op2} ${c})`;
                        let r2 = eval(f2);
                        if (targets.some(t => Math.abs(t - r2) < 0.001)) return f2;
                    } catch(e){}
                }
             }
             return null;
        },

        // [v4.4.6 ä¿®æ”¹] å¢åŠ  silentMode åƒæ•¸ï¼Œé è¨­ç‚º 0 (æ’­æ”¾èªéŸ³)ï¼Œå‚³å…¥ 1 å‰‡éœéŸ³  app.toast("ä½ å¥½", 1)ä¸æ”¾èªéŸ³
        toast: (msg, silentMode = 0) => {
            const el = app.el('msg-toast');
            el.textContent = msg;
            el.style.opacity = '1';
            el.style.top = '100px';
            // æ¸…é™¤èˆŠçš„ timer ä»¥å…é–ƒçˆ
            if(app.state.toastTimer) clearTimeout(app.state.toastTimer);
            app.state.toastTimer = setTimeout(() => { el.style.opacity = '0'; el.style.top = '20px'; }, 2000);
            
            // åªæœ‰ç•¶ silentMode ä¸ç­‰æ–¼ 1 æ™‚ï¼Œæ‰æ’­æ”¾èªéŸ³
            if (silentMode !== 1) {
                app.speak(msg);
            }
        },

        speak: (text) => {
            // v4.0.9: ä¿®æ­£èªéŸ³æ¬Šé™ï¼Œè®“æˆ¿ä¸» (isHost) ä¹Ÿèƒ½è½åˆ°èªéŸ³æç¤º
            if ((app.state.role === 'teacher' || app.state.isHost) && app.state.voiceEnabled && window.speechSynthesis) {
                // [ä¿®æ”¹] ç§»é™¤äº† window.speechSynthesis.cancel() 
                // åŸå› ï¼šç‚ºäº†è®“èªéŸ³æ’éšŠæ’­æ”¾ï¼Œè€Œä¸æ˜¯åˆ‡æ–·ä¸Šä¸€å¥ã€‚
                
                // [ä¿®æ­£] èªéŸ³å£èªåŒ–è½‰æ›ï¼šå°‡ç¬¦è™Ÿè½‰ç‚ºä¸­æ–‡
                let spokenText = text
                    .replace(/\*/g, 'ä¹˜ä»¥')   // é›»è…¦ç¬¦è™Ÿ * -> ä¹˜ä»¥
                    .replace(/\//g, 'é™¤ä»¥')   // é›»è…¦ç¬¦è™Ÿ / -> é™¤ä»¥
                    .replace(/Ã—/g, 'ä¹˜ä»¥')    // æ•¸å­¸ç¬¦è™Ÿ Ã— -> ä¹˜ä»¥
                    .replace(/Ã·/g, 'é™¤ä»¥')    // æ•¸å­¸ç¬¦è™Ÿ Ã· -> é™¤ä»¥
                    .replace(/-/g, 'æ¸›')      // æ¸›è™Ÿå”¸èµ·ä¾†é †ä¸€é»
                    .replace(/\+/g, 'åŠ ');    // åŠ è™Ÿå”¸èµ·ä¾†é †ä¸€é»

                // ç§»é™¤è¡¨æƒ…ç¬¦è™Ÿï¼Œé¿å…èªéŸ³å¼•æ“è®€å‡ºäº‚ç¢¼
                const cleanText = spokenText.replace(/([\u2700-\u27BF]|[\uE000-\uF8FF]|\uD83C[\uDC00-\uDFFF]|\uD83D[\uDC00-\uDFFF]|[\u2011-\u26FF]|\uD83E[\uDD10-\uDDFF])/g, '');

                const u = new SpeechSynthesisUtterance(cleanText);
                u.lang = 'zh-TW';
                // [å»ºè­°] æ’éšŠæ¨¡å¼ä¸‹ï¼Œèªé€Ÿè¨­ç‚º 1.0 (æ­£å¸¸) æˆ– 1.1ï¼Œé¿å…å¤§é‡è¨Šæ¯å †ç©æ™‚è¬›å¤ªä¹…
                u.rate = 1.5; 
                window.speechSynthesis.speak(u);
            }
        },
        
        toggleVoice: () => {
            app.state.voiceEnabled = !app.state.voiceEnabled;
            app.el('voice-toggle-btn').textContent = app.state.voiceEnabled ? "ğŸ”Š èªéŸ³é–‹" : "ğŸ”‡ èªéŸ³é—œ";
        },

        generatePredefinedCards: () => { /* ä½”ä½ç¬¦ */ },
        createPredefinedCards: () => { /* ä½”ä½ç¬¦ */ },
        getCardColorClass: (c) => { return { black: 'bg-slate-900 text-white', red: 'bg-red-600 text-white', blue: 'bg-blue-600 text-white', yellow: 'bg-yellow-400 text-black' }[c] || 'bg-gray-200'; },
        
        shuffle: (array) => {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        },

        createFullDeck: () => {
            const data = {
                black: { n: [49, 64, 84, 90], p: 6 },
                red: { n: [23, 26, 33, 44, 50, 54, 63, 70, 80], p: 4 },
                blue: { n: [19, 22, 25, 27, 28, 32, 35, 42, 45, 48, 56, 60, 72], p: 2 },
                yellow: { n: [3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 20, 21, 24, 30, 36, 40], p: 1 }
            };
            const decks = {};
            Object.keys(data).forEach(color => {
                decks[color] = app.shuffle([...data[color].n]).map(num => ({
                    number: num, color: color, points: data[color].p, isTaken: false
                }));
            });
            return decks;
        },
// --- v4.3.3 æ€ªç‰©å¡ç‰Œç‰¹æ•ˆç³»çµ± ---
        // --- v4.3.2 æ€ªç‰©å¡ç‰Œç‰¹æ•ˆç³»çµ± (å„ªåŒ–ç‰ˆï¼šç¨ç«‹è³‡è¨Šæ¬„) ---
      // [v4.3.6] æ¸²æŸ“æ€ªç‰©èˆå° (å…¨åŒæ­¥ç‰¹æ•ˆç‰ˆ)
        // [v4.5.2] æ¸²æŸ“æ€ªç‰©èˆå° (ä¿®æ­£æç¤ºä½ç½® + æ–°å¢ç‹€æ…‹ç‡ˆè™Ÿ)
        renderMonsterStage: () => {
            const container = app.el('dynamic-monster-container');
            if (!container) return;

            const remoteMonster = app.state.gameData?.activeMonster;
            const globalList = app.state.globalSettings?.monsterList || [];

            // --- æƒ…æ³ A: ç„¡æ€ªç‰©è³‡æ–™ (é¡¯ç¤ºç‰ŒèƒŒç­‰å¾…) ---
            if (!remoteMonster || remoteMonster.state !== 'battle') {
                // è‹¥åŸæœ¬å ´ä¸Šé‚„æœ‰æ€ª(ä¾‹å¦‚è¢«æ‰“æ­»)ï¼Œç¨å¾®å»¶é²å¾Œç§»é™¤
                const existing = document.getElementById('active-monster-card');
                if (existing && existing.classList.contains('is-in-battle')) {
                    existing.classList.remove('is-in-battle');
                    setTimeout(() => { if(document.getElementById('active-monster-card')) app.renderMonsterStage(); }, 500);
                    return;
                }
                
                // é¡¯ç¤ºé è¨­ç‰ŒèƒŒ (éœæ­¢ç‹€æ…‹)
                const defaultBackId = (globalList[0] && globalList[0].cardBack) ? globalList[0].cardBack : 1;
                const cardBacks = { 1: 'https://class.kh.edu.tw/sites/30033/upload_file/6/BK8K9kH.jpg', 2: 'https://class.kh.edu.tw/sites/30033/upload_file/6/jZAPi9w.jpg', 3: 'https://class.kh.edu.tw/sites/30033/upload_file/6/YBrnPT7.jpg', 4: 'https://class.kh.edu.tw/sites/30033/upload_file/6/gold.jpg', 5: 'https://class.kh.edu.tw/sites/30033/upload_file/6/platinum.jpg', 6: 'https://class.kh.edu.tw/sites/30033/upload_file/6/yauTZnK.jpg', 7: 'https://class.kh.edu.tw/sites/30033/upload_file/6/AuMVWei.jpg' };
                const backImg = cardBacks[defaultBackId] || cardBacks[1];
                
                // [No-Whitespace] ç‰ŒèƒŒ + v4.5.2 ä¿®æ­£ä½ç½®çš„å¬å–šæç¤º
                // [ç‰ˆé¢ä¿®æ”¹èªªæ˜]: 
                // 1. å¡ç‰‡ä½ç½®: style="top:0.5rem; left:0.5rem;" (è‹¥è¦ç§»å‹•å¡ç‰‡ï¼Œè«‹æ”¹é€™è£¡)
                // 2. æç¤ºæ–‡å­—ä½ç½®: ä¸‹æ–¹ div çš„ style="top: 11rem; left: 0.5rem;" 
                //    - top: 11rem (å› ç‚ºå¡ç‰‡é«˜ç´„10~12remï¼Œè¨­11remæœƒå‰›å¥½åœ¨ä¸‹æ–¹)
                //    - left: 0.5rem (é å·¦å°é½Šå¡ç‰‡)
                //    - è‹¥è¦ºå¾—å¤ªè¿‘æˆ–å¤ªé ï¼Œè«‹èª¿æ•´ top çš„æ•¸å€¼
                container.innerHTML = `<div id="active-monster-card" class="monster-card-wrapper w-24 h-40 md:w-28 md:h-48" style="top:0.5rem;left:0.5rem;" onclick="app.activateMonsterCard()"><div class="monster-card-inner"><div class="monster-face monster-face-front bg-slate-900"></div><div class="monster-face monster-face-back"><img src="${backImg}" class="w-full h-full object-cover" alt="Back"></div></div></div><div class="absolute w-24 md:w-28 text-center pointer-events-none flex justify-center" style="top:13.5rem;left:0.5rem;z-index:40;"><div class="text-amber-600 font-bold text-s bg-white/95 px-2 py-1 rounded-full shadow-md animate-bounce border border-amber-300 whitespace-nowrap">ğŸ‘† é»æ“Šé­é‡å¡</div></div>`;


                
                app.state.lastMonsterActionTime = 0; // é‡ç½®ç‰¹æ•ˆè¨ˆæ™‚å™¨
                return;
            }

            // --- æƒ…æ³ B: æœ‰æ€ªç‰© (æˆ°é¬¥ä¸­) ---
            const currentHp = (remoteMonster.currentHp !== undefined) ? remoteMonster.currentHp : 100;
            const maxHp = (remoteMonster.maxHp !== undefined) ? remoteMonster.maxHp : 100;
            const hpPercent = Math.max(0, Math.min(100, (currentHp / maxHp) * 100));
            
            const existingCard = document.getElementById('active-monster-card');
            const isSameMonster = existingCard && existingCard.dataset.monsterName === remoteMonster.name;

            // [v4.5.2] ç”Ÿæˆç‹€æ…‹ç‡ˆè™Ÿ HTML å­—ä¸² (ç„¡ç©ºç™½å£“ç¸®)
            let statusHtml = '';
            // Mode 1: è¢«å‹•
            if (remoteMonster.mode1) statusHtml += `<span onclick="app.toast('ğŸ›¡ï¸ [è¢«å‹•åæ“Š]ï¼šè‹¥å›åˆçµæŸ(æˆ–å€’æ•¸çµæŸ)æ™‚ï¼Œå ´ä¸Šå¡ç‰Œæœªå…¨æ¶ˆï¼Œæ€ªç‰©å°‡é€²è¡Œåæ“Šã€‚', 1)" class="cursor-pointer bg-slate-700 text-white px-1 rounded hover:bg-slate-600">[è¢«å‹•]</span>`;
            // Mode 2: ä¸»å‹•
            if (remoteMonster.mode2) statusHtml += `<span onclick="app.toast('âš”ï¸ [ä¸»å‹•æ”»æ“Š]ï¼šè‹¥å›åˆæ™‚é–“å€’æ•¸çµæŸï¼Œæ€ªç‰©å°‡ç™¼å‹•å…¨é«”æ”»æ“Šã€‚', 1)" class="cursor-pointer bg-red-700 text-white px-1 rounded hover:bg-red-600">[ä¸»å‹•]</span>`;
            // Mode 3: æ˜“æ€’
            if (remoteMonster.mode3) statusHtml += `<span onclick="app.toast('ğŸ’¢ [æ˜“æ€’é«”è³ª]ï¼šè‹¥ç­”éŒ¯é¡Œç›®ï¼Œæ€ªç‰©æœƒç«‹å³å°è©²å°éšŠé€²è¡Œæ‡²ç½°æ”»æ“Šã€‚', 1)" class="cursor-pointer bg-orange-600 text-white px-1 rounded hover:bg-orange-500">[æ˜“æ€’]</span>`;
            // Mode 4: æš´èµ°
            if (remoteMonster.mode4 && remoteMonster.mode4 > 0) statusHtml += `<span onclick="app.toast('ğŸ”¥ [æš´èµ°]ï¼šæ¯éš” ${remoteMonster.mode4} å›åˆï¼Œæ€ªç‰©æœƒç„¡æ¢ä»¶ç™¼å‹•æ”»æ“Šã€‚', 1)" class="cursor-pointer bg-purple-700 text-white px-1 rounded hover:bg-purple-600">[æš´èµ°]</span>`;
            // Mode 5: ç¦ç”¨
            if (remoteMonster.mode5) statusHtml += `<span onclick="app.toast('ğŸš« [æ³•å‰‡å°å°]ï¼šæœ¬å ´æˆ°é¬¥ç¦æ­¢ä½¿ç”¨ã€Œ${remoteMonster.mode5}ã€ç¬¦è™Ÿã€‚', 1)" class="cursor-pointer bg-black text-yellow-400 px-1 rounded hover:bg-gray-800 border border-yellow-500">[ç¦${remoteMonster.mode5}]</span>`;

            // 1. å¦‚æœå¡ç‰‡å·²å­˜åœ¨ä¸”æ˜¯åŒä¸€éš» -> åŸ·è¡Œæ›´æ–°èˆ‡ç‰¹æ•ˆæª¢æŸ¥
            if (existingCard && isSameMonster) {
                // æ›´æ–°è¡€æ¢
                const hpBar = document.getElementById('monster-hp-bar-fill');
                const hpText = document.getElementById('monster-hp-text');
                if (hpBar) hpBar.style.width = `${hpPercent}%`;
                if (hpText) hpText.innerText = `HP ${currentHp}/${maxHp}`;

                // æª¢æŸ¥æ˜¯å¦éœ€è¦è§¸ç™¼ç‰¹æ•ˆ (æ ¹æ“š actionTime)
                if (remoteMonster.actionTime && remoteMonster.actionTime > (app.state.lastMonsterActionTime || 0)) {
                    app.state.lastMonsterActionTime = remoteMonster.actionTime;
                    const now = Date.now();
                    const isRecent = (now - remoteMonster.actionTime) < 2000;
                    
                    if (isRecent) {
                        if (remoteMonster.action === 'attack') app.triggerMonsterAttackEffect('attack');
                        if (remoteMonster.action === 'damage') app.triggerMonsterAttackEffect('damage');
                    }
                }
                return; 
            }

            // 2. å¦‚æœå¡ç‰‡ä¸å­˜åœ¨æˆ–æ›æ€ª -> åŸ·è¡Œå®Œæ•´æ¸²æŸ“
            const cardBacks = { 1: 'https://class.kh.edu.tw/sites/30033/upload_file/6/BK8K9kH.jpg', 2: 'https://class.kh.edu.tw/sites/30033/upload_file/6/jZAPi9w.jpg', 3: 'https://class.kh.edu.tw/sites/30033/upload_file/6/YBrnPT7.jpg', 4: 'https://class.kh.edu.tw/sites/30033/upload_file/6/gold.jpg', 5: 'https://class.kh.edu.tw/sites/30033/upload_file/6/platinum.jpg', 6: 'https://class.kh.edu.tw/sites/30033/upload_file/6/yauTZnK.jpg', 7: 'https://class.kh.edu.tw/sites/30033/upload_file/6/AuMVWei.jpg' };
            const backImg = cardBacks[remoteMonster.cardBack || 1] || cardBacks[1];
            const faceImg = remoteMonster.img1 || 'https://cdn-icons-png.flaticon.com/512/1548/1548680.png';

            const now = Date.now();
            const isFreshSummon = remoteMonster.timestamp && (now - remoteMonster.timestamp) < 2000;
            const initialClass = isFreshSummon ? '' : 'is-in-battle is-flipped';

            // [No-Whitespace] æˆ°é¬¥ä¸­çš„æ€ªç‰©å¡ + ç‹€æ…‹ç‡ˆè™Ÿé¡¯ç¤ºå€
            // [ç‰ˆé¢ä¿®æ”¹èªªæ˜]: 
            // ç‹€æ…‹ç‡ˆè™Ÿå®¹å™¨: style="top: 13rem; ..." (ä½æ–¼æˆ°é¬¥ä½ç½®çš„ä¸‹æ–¹)
            // è‹¥æ€ªç‰©ç§»å‹•åˆ°å³å´æˆ°é¬¥ä½(is-in-battle)ï¼Œæ¨£å¼ç”± CSS class æ§åˆ¶ä½ç½®ï¼Œä½†ç‡ˆè™Ÿæ˜¯ absoluteï¼Œ
            // æˆ‘å€‘ä½¿ç”¨ä¸€å€‹ trickï¼šå°‡ç‡ˆè™Ÿæ”¾åœ¨å¡ç‰‡çµæ§‹ä¹‹å¤–ï¼Œä½†é€é CSS å®šä½åˆ°å³å´ã€‚
            // ä¿®æ­£ï¼šç‚ºäº†è®“ç‡ˆè™Ÿè·Ÿè‘—å¡ç‰‡è·‘æ¯”è¼ƒå›°é›£ï¼Œæˆ‘å€‘ç›´æ¥å°‡ç‡ˆè™Ÿå›ºå®šåœ¨ã€Œæˆ°é¬¥å€(ç•«é¢å³å´)çš„ä¸‹æ–¹ã€ã€‚
            
            // ä¸‹æ–¹ HTML çµæ§‹èªªæ˜ï¼š
            // 1. monster-card-wrapper: æ€ªç‰©å¡æœ¬é«”
            // 2. status-container: é¡¯ç¤º [è¢«å‹•] [ä¸»å‹•] ç­‰ç‹€æ…‹ï¼Œè¨­å®šåœ¨ style="top: 0.5rem; right: 0.5rem; ..." çš„æˆ°é¬¥ä½ç½®ä¸‹æ–¹
            // é€™è£¡æˆ‘å€‘å‹•æ…‹è¨ˆç®—ä½ç½®ï¼Œå› ç‚ºæ€ªç‰©æˆ°é¬¥æ™‚æœƒç§»å‹•åˆ°å³å´ (CSS class .is-in-battle)
            // ç‚ºäº†ç°¡åŒ–ï¼Œæˆ‘å€‘å°‡ç‹€æ…‹åˆ—æ”¾åœ¨å¡ç‰‡ wrapper å…§éƒ¨æˆ–ç·Šé„°ï¼Œä½†é€™æœƒè¢« 3D ç¿»è½‰å½±éŸ¿ã€‚
            // æœ€ä½³è§£ï¼šç¨ç«‹ä¸€å€‹çµ•å°å®šä½çš„ divï¼Œä½ç½®å°æ‡‰æˆ°é¬¥å€ã€‚
            
            // æˆ°é¬¥å€é è¨­ä½ç½®ï¼šæ‰‹æ©Ÿç‰ˆ left: calc(100% - 6rem - 0.5rem) / æ¡Œæ©Ÿç‰ˆ left: calc(100% - 7rem - 0.5rem)
            // æˆ‘å€‘ç›´æ¥æŠŠç‹€æ…‹åˆ—åŒ…å«åœ¨ container è£¡ï¼Œä¸¦çµ¦äºˆå°æ‡‰çš„å³å´å®šä½ã€‚
            
            container.innerHTML = `<div id="active-monster-card" data-monster-name="${remoteMonster.name}" class="monster-card-wrapper w-24 h-40 md:w-28 md:h-48 ${initialClass}" style="top:0.5rem;left:0.5rem;" onclick="app.activateMonsterCard()"><div class="monster-card-inner"><div class="monster-face monster-face-front flex flex-col bg-slate-900 border-2 border-amber-500 overflow-hidden shadow-lg"><div class="h-[72%] w-full relative bg-gray-800"><img id="monster-img-face" src="${faceImg}" class="w-full h-full object-contain" alt="Monster"></div><div class="h-[28%] w-full bg-slate-900 flex flex-col justify-center items-center px-1 py-0.5"><div class="text-[0.6rem] md:text-xs font-black text-amber-400 truncate w-full text-center leading-tight">${remoteMonster.name}</div><div class="w-[90%] bg-gray-700 h-1.5 rounded-full overflow-hidden relative my-0.5 border border-black/40"><div id="monster-hp-bar-fill" class="bg-gradient-to-r from-red-600 to-red-400 h-full absolute top-0 left-0 transition-all duration-300" style="width:${hpPercent}%"></div></div><div id="monster-hp-text" class="text-[1rem] md:text-sm text-white font-mono font-bold leading-none drop-shadow-sm">HP ${currentHp}/${maxHp}</div></div></div><div class="monster-face monster-face-back"><img src="${backImg}" class="w-full h-full object-cover" alt="Back"></div></div></div><div class="absolute w-32 flex flex-wrap justify-center gap-1 pointer-events-auto z-40" style="top:13.5rem; right:0.5rem;"><div class="flex flex-wrap justify-end gap-1 text-[0.6rem] font-bold shadow-sm">${statusHtml}</div></div>`;

            if (isFreshSummon) {
                setTimeout(() => {
                    const el = document.getElementById('active-monster-card');
                    if(el) {
                        el.classList.add('is-flipped');
                        app.speak('é–‹å§‹æˆ°é¬¥ï¼' + remoteMonster.name);
                        setTimeout(() => el.classList.add('is-in-battle'), 100); 
                    }
                }, 50);
            }

            app.state.lastMonsterActionTime = remoteMonster.actionTime || 0;
        },

        // ä¸»æ§è€…æŠ½å¡ (å¯«å…¥ DB)
        activateMonsterCard: () => {
            if (!app.state.isHost) {
                if(app.state.gameData?.activeMonster?.state !== 'battle') app.toast('âœ‹ ç­‰å¾…éšŠé•·æŠ½å–é­”ç¸');
                return;
            }
            if (app.state.gameData?.activeMonster?.state === 'battle') return;

            const monsterList = app.state.globalSettings?.monsterList || [];
            // éš¨æ©ŸæŠ½é¸æ€ªç‰©é‚è¼¯ (ç›®å‰ç¶­æŒå–ç¬¬1éš»ï¼Œå¯ä¿®æ”¹)
            const template = monsterList.length > 0 ? monsterList[0] : {
                name: 'å®ˆé—œé­”ç‰©', hp: 100, maxHp: 100, cardBack: 1, atk: 1, gold: 50,
                img1: 'https://cdn-icons-png.flaticon.com/512/1548/1548680.png'
            };

            const newMonsterData = {
                ...template,
                currentHp: template.hp,
                maxHp: template.hp,
                state: 'battle',
                timestamp: firebase.database.ServerValue.TIMESTAMP, // è¨˜éŒ„å¬å–šæ™‚é–“
                action: 'summon',
                actionTime: firebase.database.ServerValue.TIMESTAMP
            };

            db.ref(`classes/${app.state.classId}/activeMonster`).set(newMonsterData);
            app.toast('âš”ï¸ é­é‡é­”ç‰©ä¸­...');
        },

       // [v4.4.0] è§¸ç™¼ç‰¹æ•ˆ (å„ªåŒ–ç‰ˆï¼šå·¦é€€è®Šèº« -> å³è¡ -> é‚„åŸ)
        triggerMonsterAttackEffect: (type) => {
            const card = app.el('active-monster-card');
            const imgFace = document.getElementById('monster-img-face'); 
            if (!card) return;

            // 1. æº–å‚™åœ–ç‰‡è³‡æ–™
            const monsterData = app.state.gameData?.activeMonster;
            const idleImg = monsterData?.img1 || 'https://cdn-icons-png.flaticon.com/512/1548/1548680.png';
            const attackImg = monsterData?.img2; // æ”»æ“Šåœ–ç‰‡

            // ç§»é™¤èˆŠå‹•ç•« class ä»¥ä¾¿é‡æ’­
            card.classList.remove('monster-attacking', 'monster-damaged');
            void card.offsetWidth; // Force Reflow (å¼·åˆ¶ç€è¦½å™¨é‡ç¹ª)

            if (type === 'attack') {
                // --- æ”»æ“Šç‰¹æ•ˆé‚è¼¯ ---
                
                // A. å•Ÿå‹•å‹•ç•« (æ€ªç‰©é–‹å§‹å¾€å·¦å¾Œé€€)
                card.classList.add('monster-attacking'); 
               

                // B. è®Šèº«æ™‚æ©Ÿï¼šå»¶é² 450ms (é…åˆ CSS å‹•ç•«é€€åˆ°æœ€å·¦é‚Šæ™‚)ï¼Œç¬é–“åˆ‡æ›ç‚ºæ”»æ“Šåœ–
                if (imgFace && attackImg && attackImg.trim() !== '') {
                    setTimeout(() => {
                        imgFace.src = attackImg;
                    }, 450); 
                }

                // C. é‚„åŸï¼šé…åˆ CSS å‹•ç•«ç¸½æ™‚é•· (1.5s)ï¼ŒçµæŸå¾Œåˆ‡å›åŸåœ–ä¸¦ç§»é™¤ class
                setTimeout(() => {
                    if (imgFace) {
                        imgFace.src = idleImg;
                    }
                    card.classList.remove('monster-attacking');
                }, 1500);

            } else if (type === 'damage') {
                // --- å—å‚·ç‰¹æ•ˆé‚è¼¯ (ç¶­æŒä¸è®Š) ---
                card.classList.add('monster-damaged');
                
                // ç²’å­çˆ†ç‚¸ç‰¹æ•ˆ
                const rect = card.getBoundingClientRect();
                const centerX = rect.left + rect.width / 2;
                const centerY = rect.top + rect.height / 2;
                const explosion = document.createElement('div');
                explosion.style.cssText = `position:fixed;top:${centerY-50}px;left:${centerX-50}px;width:100px;height:100px;background:radial-gradient(circle, rgba(255,255,255,0.9) 0%, rgba(255,50,50,0) 70%);pointer-events:none;z-index:9999;animation:ping 0.3s ease-out forwards;`;
                document.body.appendChild(explosion);
                setTimeout(() => explosion.remove(), 300);
            }
        },
       // v3.3.1 æ›´æ–°ï¼šæ¸²æŸ“å­¸ç”ŸèƒŒåŒ… (æ”¯æ´å››ç¨®é“å…·ï¼Œæ¶ˆé™¤ç©ºç™½ç¯€é»)
       // v3.4.0 æ›´æ–°ï¼šæ¸²æŸ“å­¸ç”ŸèƒŒåŒ… (æ”¯æ´äº”ç¨®é“å…·ï¼Œæ¶ˆé™¤ç©ºç™½ç¯€é»)
        renderStudentInventory: (players) => {
            // [BUGä¿®å¾©] å„ªå…ˆæ›´æ–°ä»‹é¢ç‹€æ…‹èˆ‡ç‰¹æ®ŠæŒ‰éˆ•
            app.renderActiveItemStatus();
            app.renderHorusButtons(); 

            if (!app.state.myTeam || !app.state.myName || !players) return;
            
            const myData = players[app.state.myTeam]?.[app.state.myName];
            const items = myData?.items || {};
            const invEl = app.el('student-inventory');
            const listEl = app.el('inventory-list');
            
            // v3.7.0 ä¿®æ­£ï¼šåŠ å…¥ mummy æª¢æŸ¥
            const hasItems = (items.hint > 0) || (items.double > 0) || (items.horus > 0) || (items.nile > 0) || (items.time > 0) || (items.seal > 0) || (items.shard > 0) || (items.anubis > 0) || (items.mummy > 0);
            if (!hasItems) {
                invEl.classList.add('hidden');
                return;
            }
            invEl.classList.remove('hidden');

            let html = '';
            
            // è¼”åŠ©å‡½å¼ï¼šç”¢ç”Ÿå¸¶æœ‰ç‰¹å®šé¡è‰²çš„é“å…·æŒ‰éˆ• (æ¶ˆé™¤ç©ºç™½ç¯€é»)
            const renderItem = (type, icon, count, colorClass, title) => {
                if (count > 0) {
                    const isActive = app.state.activeItem === type;
                    // è‹¥è¢«æ¿€æ´»å‰‡é–ƒçˆï¼Œå¦å‰‡é¡¯ç¤ºè‡ªå®šç¾©åº•è‰²
                    const bgClass = isActive ? 'item-active' : (colorClass + ' opacity-90 hover:opacity-100 hover:scale-105');
                    const onclick = `app.useItem('${type}')`;
                    return `<div onclick="${onclick}" class="item-slot ${bgClass} rounded-lg p-1 border border-black/10 shadow-sm" title="${title}"><div class="item-icon">${icon}</div><div class="item-count">${count}</div></div>`;
                }
                return '';
            };

            // 1. æç¤ºé¡ (é»ƒ)
            html += renderItem('hint', 'ğŸ“œ', items.hint, 'bg-yellow-100', 'æç¤ºå¡');
            
            // 2. åˆ†æ•¸åŠ å€é¡ (ç´«)
            html += renderItem('double', 'ğŸ¦‚', items.double, 'bg-purple-100', 'è–ç”²èŸ²');
            html += renderItem('anubis', 'âš–ï¸', items.anubis, 'bg-purple-100', 'é˜¿åŠªæ¯”æ–¯');

            // 3. æ™‚é–“è¦å‰‡é¡ (è—)
            html += renderItem('time', 'â³', items.time, 'bg-blue-100', 'æ™‚ä¹‹æ²™');
            html += renderItem('shard', 'ğŸ•’', items.shard, 'bg-blue-100', 'æ™‚ä¹‹ç¢ç‰‡');

            // 4. è¨ˆç®—è¦å‰‡é¡ (ç¶ )
            html += renderItem('horus', 'ğŸ‘ï¸', items.horus, 'bg-emerald-100', 'è·é­¯æ–¯');
            html += renderItem('nile', 'ğŸŒŠ', items.nile, 'bg-emerald-100', 'å°¼ç¾…æ²³');

            // 5. å°å°é™·é˜±é¡ (ç°/é»‘)
            html += renderItem('seal', 'ğŸ”’', items.seal, 'bg-slate-200', 'æ³•è€å°å°');
            html += renderItem('mummy', 'ğŸ‘»', items.mummy, 'bg-stone-300', 'æœ¨ä¹ƒä¼Šçš„è©›å’’');

            listEl.innerHTML = html;
        },

        // v3.4.0 æ›´æ–°ï¼šä½¿ç”¨é“å…· (æ–°å¢æ™‚ä¹‹æ²™é‚è¼¯)
        useItem: (type) => {
            if (app.state.gameData.status !== 'playing') return app.toast('âœ‹ éŠæˆ²å°šæœªé–‹å§‹ï¼Œé‚„ä¸èƒ½ä½¿ç”¨é“å…·å–”');

            // --- é¡å‹ A: ç«‹å³æ¶ˆè€—å‹ ---
            
            // 1. æç¤ºå¡
            if (type === 'hint') {
                if (!confirm('ğŸ“œ ç¢ºå®šè¦æ¶ˆè€—ä¸€å¼µã€Œæç¤ºå¡ã€ä¾†ç²å¾—é‹ç®—æç¤ºå—ï¼Ÿ')) return;
                const { d8, d10, d12 } = app.state.gameData.dice;
                const solution = app.findSolution([d8, d10, d12]);
                if (solution) {
                    const ref = db.ref(`classes/${app.state.classId}/players/${app.state.myTeam}/${app.state.myName}/items/hint`);
                    ref.transaction(count => (count || 0) - 1);
                    const match = solution.match(/(\(\d+\s*[\+\-\*\/]\s*\d+\)|\d+\s*[\+\-\*\/]\s*\d+)/); 
                    let hint = match ? match[0] : solution;
                    app.speak("æç¤ºå¡å·²ä½¿ç”¨");
                    alert(`ğŸ’¡ æ³•è€ç‹çš„ä½èªï¼šè©¦è©¦çœ‹å…ˆç®— ${hint}`);
                } else {
                    app.toast('âš ï¸ ç•¶å‰ä¼¼ä¹ç„¡è§£');
                }
                return;
            }
            
            // 2. æ™‚ä¹‹æ²™
            if (type === 'time') {
                const currentFrozen = app.state.gameData.frozenState;
                const now = Date.now();
                if (currentFrozen && currentFrozen.endTime > now) {
                    return app.toast('â„ï¸ å ´ä¸Šæ™‚é–“å·²è¢«å‡çµï¼Œç„¡æ³•ç–ŠåŠ ä½¿ç”¨ï¼');
                }
                if (!confirm('â³ ç¢ºå®šè¦ä½¿ç”¨ã€Œæ™‚ä¹‹æ²™ã€å—ï¼Ÿ\n\næ¥ä¸‹ä¾† 30 ç§’å…§ï¼Œåªæœ‰ä½ å€‘å°çµ„å¯ä»¥ç­”é¡Œï¼Œå…¶ä»–éšŠä¼å°‡è¢«å‡çµï¼')) return;

                const refItem = db.ref(`classes/${app.state.classId}/players/${app.state.myTeam}/${app.state.myName}/items/time`);
                refItem.transaction(count => {
                    if ((count || 0) > 0) {
                        db.ref(`classes/${app.state.classId}/frozenState`).set({
                            active: true,
                            byTeam: app.state.myTeam,
                            byPlayer: app.state.myName,
                            endTime: Date.now() + 30000 
                        });
                        app.speak(`è­¦å‘Šï¼${app.state.myName}ä½¿ç”¨äº†æ™‚ä¹‹æ²™ï¼Œæ™‚é–“å‡çµ30ç§’ï¼`);
                        return count - 1;
                    }
                    return count;
                });
                return;
            }
// 3. æ™‚ä¹‹ç¢ç‰‡ (v3.6.2 æ–°å¢)
            if (type === 'shard') {
                // æª¢æŸ¥æ˜¯å¦è™•æ–¼ã€Œæ’¤é€€å€’æ•¸ä¸­ã€ä¸”ã€Œå°šæœªçµæŸã€
                const isTimerRunning = app.state.gameData.timerActive && app.state.gameData.timer > 0;
                
                if (!isTimerRunning) {
                     return app.toast('âš ï¸ æ™‚ä¹‹ç¢ç‰‡åªèƒ½åœ¨ã€Œæ’¤é€€å€’æ•¸ä¸­ã€ä½¿ç”¨ï¼');
                }
                
                if (!confirm('ğŸ•’ ç¢ºå®šè¦ä½¿ç”¨ã€Œæ™‚ä¹‹ç¢ç‰‡ã€å°‡å€’æ•¸æ™‚é–“å»¶é•· 60 ç§’å—ï¼Ÿ')) return;

                const itemRef = db.ref(`classes/${app.state.classId}/players/${app.state.myTeam}/${app.state.myName}/items/shard`);
                itemRef.transaction(count => {
                    if ((count || 0) > 0) {
                        // åŸ·è¡Œæ•ˆæœ: å¢åŠ  60 ç§’
                        // æ³¨æ„ï¼šé€™è£¡ç›´æ¥ä¿®æ”¹ Firebase ä¸Šçš„ timer
                        const currentTimer = app.state.gameData.timer || 0;
                        // é¿å…åœ¨äº¤æ˜“éç¨‹ä¸­ timer å‰›å¥½æ­¸é›¶ï¼ŒåšäºŒæ¬¡æª¢æŸ¥
                        if (currentTimer <= 0) return count; // å–æ¶ˆæ¶ˆè€—

                        const newTime = currentTimer + 60;
                        db.ref(`classes/${app.state.classId}/timer`).set(newTime);
                        
                        app.speak('æ™‚é–“ç¢ç‰‡å·²ä½¿ç”¨ï¼Œå»¶é•·å…­åç§’');
                        app.toast('ğŸ•’ æˆåŠŸï¼æˆ°é¬¥æ™‚é–“å·²å»¶é•· 60 ç§’ï¼');
                        return count - 1;
                    }
                    return count;
                });
                return;
            }
            // --- é¡å‹ B: ç‹€æ…‹åˆ‡æ›å‹ ---
            if (app.state.activeItem === type) {
                // ... (åŸæœ‰çš„é—œé–‰é‚è¼¯ä¿æŒä¸è®Šï¼Œç•¥) ...
                if (type === 'anubis') {
                     // ... (ç•¥) ...
                     const itemRef = db.ref(`classes/${app.state.classId}/players/${app.state.myTeam}/${app.state.myName}/items/anubis`);
                     itemRef.transaction(count => Math.max(0, (count || 0) - 1));
                     app.toast('âš–ï¸ é˜¿åŠªæ¯”æ–¯é“å…·å·²æ¶ˆè€—ä¸¦é—œé–‰');
                } else {
                    app.toast('å·²å–æ¶ˆé“å…·æ•ˆæœ');
                }
                app.state.activeItem = null;
                app.state.anubisBannedOp = null;
                
            } else {
                app.state.activeItem = type; // å•Ÿå‹•
                
                if (type === 'anubis') {
                    const ops = ['+', '-', 'Ã—', 'Ã·'];
                    const banned = ops[Math.floor(Math.random() * ops.length)];
                    app.state.anubisBannedOp = banned;
                    app.toast(`âš–ï¸ å¯©åˆ¤é™è‡¨ï¼æœ¬é¡Œç¦æ­¢ä½¿ç”¨ã€Œ${banned}ã€`);
                    app.speak(`é˜¿åŠªæ¯”æ–¯ç¦æ­¢ä½¿ç”¨${banned}`);
                }
                
                if (type === 'seal') {
                     app.toast('ğŸ”’ å°å°æ¨¡å¼å·²å•Ÿå‹•ï¼Œè«‹é»æ“Šé‡‘å­—å¡”ä¸Šçš„ç‰Œé€²è¡Œå°é–ï¼');
                     app.speak('å°å°å·²å•Ÿå‹•');
                }

                // v3.7.0 æ–°å¢
                if (type === 'mummy') {
                    app.toast('ğŸ‘» è©›å’’æ¨¡å¼å·²å•Ÿå‹•ï¼Œè«‹é¸æ“‡ä¸€å¼µå¡ç‰ŒåŸ‹ä¸‹é™·é˜±ï¼');
                    app.speak('è©›å’’å·²å•Ÿå‹•');
                }
            }
            
            // é‡æ–°æ¸²æŸ“ (é€™æœƒè§¸ç™¼ renderActiveItemStatus æ›´æ–°ä»‹é¢)
            app.renderStudentInventory(app.state.gameData.players);
        },

       renderActiveItemStatus: () => {
             // é‡ç½®æŒ‰éˆ•æ¨£å¼
             ['add', 'sub', 'mul', 'div'].forEach(op => {
                 const btn = app.el(`btn-op-${op}`);
                 if(btn) {
                     btn.style.backgroundColor = '';
                     btn.style.opacity = '1';
                     btn.style.cursor = 'pointer';
                 }
             });

             const statusEl = app.el('active-item-status');
             const type = app.state.activeItem;
             
             if (!type) {
                 statusEl.classList.add('hidden');
                 return;
             }
             
             // v3.7.0 æ–°å¢ mummy è¨­å®š
             const configs = {
                 seal: { icon: 'ğŸ”’', name: 'æ³•è€å°å°', desc: 'é»æ“Šé‡‘å­—å¡”ä¸Šçš„ç‰Œä»¥é–å®š60ç§’ (å†æ¬¡é»æ“Šå–æ¶ˆ)' },
                 double: { icon: 'ğŸ¦‚', name: 'è–ç”²èŸ²ç¥ç¦', desc: 'æœ¬é¡Œåˆ†æ•¸ x2 (å†æ¬¡é»æ“Šå¯é—œé–‰)' },
                 horus: { icon: 'ğŸ‘ï¸', name: 'è·é­¯æ–¯ä¹‹çœ¼', desc: 'å¯ä½¿ç”¨ä¸‹æ–¹ 1, 2, 3 æŒ‰éˆ• (å†æ¬¡é»æ“Šå¯é—œé–‰)' },
                 nile: { icon: 'ğŸŒŠ', name: 'å°¼ç¾…æ²³æ©è³œ', desc: 'æœ¬å›åˆåªéœ€ 2 é¡†éª°å­ (å†æ¬¡é»æ“Šå¯é—œé–‰)' },
                 anubis: { icon: 'âš–ï¸', name: 'é˜¿åŠªæ¯”æ–¯çš„å¯©åˆ¤', desc: `åˆ†æ•¸ x3ï¼Œä½†ç¦æ­¢ä½¿ç”¨ã€Œ${app.state.anubisBannedOp}ã€é‹ç®—ï¼` },
                 mummy: { icon: 'ğŸ‘»', name: 'æœ¨ä¹ƒä¼Šçš„è©›å’’', desc: 'é»æ“Šé‡‘å­—å¡”ä¸Šçš„ç‰ŒåŸ‹è¨­é™·é˜±ï¼Œæ•µäººè¸©åˆ°å°‡å€’æ‰£åˆ†æ•¸ï¼' }
             };
             
             const cfg = configs[type];
             
             // é˜¿åŠªæ¯”æ–¯æŒ‰éˆ•è®Šç°é‚è¼¯
             if (type === 'anubis' && app.state.anubisBannedOp) {
                 const opMap = { '+': 'add', '-': 'sub', 'Ã—': 'mul', 'Ã·': 'div' };
                 const targetId = `btn-op-${opMap[app.state.anubisBannedOp]}`;
                 const targetBtn = app.el(targetId);
                 if(targetBtn) {
                     targetBtn.style.backgroundColor = '#9ca3af'; 
                     targetBtn.style.opacity = '0.5';
                     targetBtn.style.cursor = 'not-allowed';
                 }
             }

             // ç„¡ç©ºç™½ innerHTML
             statusEl.innerHTML = `<div class="font-black text-amber-900 text-lg flex items-center justify-center gap-2"><span>${cfg.icon}</span><span>${cfg.name}å•Ÿç”¨ä¸­</span></div><div class="text-sm text-amber-700 font-bold mt-1">${cfg.desc}</div>`;
             statusEl.classList.remove('hidden');
        },

        // v3.3.1 æ–°å¢ï¼šæ¸²æŸ“è·é­¯æ–¯ä¹‹çœ¼æŒ‰éˆ• (1, 2, 3)
        // [v4.1.7 ä¿®æ”¹] æ¸²æŸ“è·é­¯æ–¯ä¹‹çœ¼æŒ‰éˆ• (ç·Šæ¹Šç‰ˆ 1, 2, 3)
        renderHorusButtons: () => {
            const area = app.el('horus-input-area');
            if (app.state.activeItem === 'horus') {
                // ç¶ è‰²åº•è‰²ï¼Œèª¿æ•´é«˜åº¦èˆ‡å­—é«”å¤§å°ä»¥ç¯€çœç©ºé–“
                const btnClass = "cursor-control-btn bg-green-400 hover:bg-green-500 text-black border-b-4 border-green-700 active:border-b-0 active:translate-y-1 rounded-lg font-black text-lg shadow h-10 flex items-center justify-center transition-all";
                // ä½¿ç”¨ç„¡ç©ºç™½ç¯€é»å¯«æ³•
                area.innerHTML = `<button onclick="app.inputChar('1')" class="${btnClass}">1</button><button onclick="app.inputChar('2')" class="${btnClass}">2</button><button onclick="app.inputChar('3')" class="${btnClass}">3</button>`;
                area.classList.remove('hidden');
            } else {
                area.innerHTML = '';
                area.classList.add('hidden');
            }
        },
        generateInitialGameData: () => {
            const decks = app.createFullDeck();
            const pyramid = new Array(10);
            
            pyramid[0] = decks.black.pop();
            pyramid[1] = decks.red.pop(); pyramid[2] = decks.red.pop();
            pyramid[3] = decks.blue.pop(); pyramid[4] = decks.blue.pop(); pyramid[5] = decks.blue.pop();
            pyramid[6] = decks.yellow.pop(); pyramid[7] = decks.yellow.pop(); pyramid[8] = decks.yellow.pop(); pyramid[9] = decks.yellow.pop();
            
            return { pyramid, decks };
        },

        // --- v3.5.0 è‡ªå‹•é“å…·ç™¼æ”¾ç³»çµ± ---
        openAutoGrantModal: () => {
            const cfg = app.state.autoGrant;
            app.el('ag-enable').checked = cfg.enabled;
            app.el('ag-interval').value = cfg.interval;
            app.el('ag-target-count').value = cfg.targetCount;
            app.el('ag-item-count').value = cfg.itemCount;
            
            // è¨­å®š Checkbox
            document.querySelectorAll('.ag-item-check').forEach(chk => {
                chk.checked = cfg.allowedTypes.includes(chk.value);
            });
            
            app.el('auto-grant-modal').classList.remove('hidden');
        },

        saveAutoGrantSettings: () => {
            const enabled = app.el('ag-enable').checked;
            const interval = parseInt(app.el('ag-interval').value) || 4;
            const targetCount = parseInt(app.el('ag-target-count').value) || 2;
            const itemCount = parseInt(app.el('ag-item-count').value) || 2;
            
            const allowedTypes = [];
            document.querySelectorAll('.ag-item-check:checked').forEach(chk => {
                allowedTypes.push(chk.value);
            });

            if (enabled && allowedTypes.length === 0) {
                return app.toast('âš ï¸ é–‹å•Ÿè‡ªå‹•ç™¼æ”¾æ™‚ï¼Œè‡³å°‘è¦é¸æ“‡ä¸€ç¨®é“å…·ï¼');
            }

            app.state.autoGrant = { enabled, interval, targetCount, itemCount, allowedTypes };
            
            // æ›´æ–°æŒ‰éˆ•ä¸Šçš„ç‹€æ…‹ç‡ˆ
            const indicator = app.el('ag-status-indicator');
            if (indicator) {
                indicator.className = `w-2 h-2 rounded-full ${enabled ? 'bg-green-400 shadow-[0_0_5px_#4ade80]' : 'bg-red-400'}`;
            }

            app.el('auto-grant-modal').classList.add('hidden');
            app.toast(enabled ? `âœ… è‡ªå‹•å¹³è¡¡æ©Ÿåˆ¶å·²å•Ÿå‹• (æ¯${interval}å±€)` : 'ğŸ›‘ è‡ªå‹•å¹³è¡¡æ©Ÿåˆ¶å·²é—œé–‰');
        },

       // v4.0.5: è‡ªå‹•é“å…·åˆ†é… (GMå…¨åŸŸè¨­å®šç‰ˆ)
        // v4.0.5: è‡ªå‹•é“å…·åˆ†é… (GMå…¨åŸŸè¨­å®šç‰ˆ)
        processAutoGrant: (round) => {
            // åªæœ‰æˆ¿ä¸»è² è²¬åŸ·è¡Œåˆ†é…ï¼Œé¿å…é‡è¤‡ç™¼é€
            if (!app.state.isHost) return;

            // è®€å–å…¨åŸŸè¨­å®š (è‹¥ç„¡å‰‡é è¨­ä¸å•Ÿç”¨ï¼Œé¿å…å¹²æ“¾)
            const globalCfg = app.state.globalSettings?.autoGrant;
            
            // 1. æª¢æŸ¥æ˜¯å¦å•Ÿç”¨
            if (!globalCfg || !globalCfg.enabled) return;

            // 2. æª¢æŸ¥å›åˆæ•¸ (æ’é™¤ç¬¬1å›åˆï¼Œç¬¦åˆé–“éš”æ‰ç™¼)
            // ä¾‹å¦‚ interval=3ï¼Œå‰‡åœ¨ round 4 (3+1), 7 (6+1), 10... ç™¼æ”¾
            if (round <= 1 || (round - 1) % globalCfg.interval !== 0) return;

            // é–‹å§‹è¨ˆç®—åˆ†æ•¸èˆ‡æ’å
            const players = app.state.gameData.players || {};
            
            // å°‡æ‰€æœ‰ç©å®¶è¦–ç‚ºåŒä¸€æ± å­é€²è¡Œæ¯”è¼ƒ
            let allPlayers = [];
            Object.keys(players).forEach(teamKey => {
                if(players[teamKey]) {
                    Object.values(players[teamKey]).forEach(p => {
                        allPlayers.push({...p, teamKey: teamKey}); // éœ€ç´€éŒ„ teamKey æ‰èƒ½ç™¼é“å…·
                    });
                }
            });

            if (allPlayers.length === 0) return;

            // åˆ†æ•¸ç”±ä½åˆ°é«˜æ’åº
            allPlayers.sort((a, b) => (a.score || 0) - (b.score || 0));

            // å–å‡ºå€’æ•¸ N å (åˆ†æ•¸æœ€ä½çš„å‰ N ä½)
            const targets = allPlayers.slice(0, globalCfg.targetCount);
            
            if (targets.length === 0) return;

            // å»¶é²åŸ·è¡Œ
            setTimeout(() => {
                let msg = `ğŸ è£œçµ¦ç‰©è³‡\n`;
                
                targets.forEach(p => {
                    msg += `${p.name} ç²å¾—æ”¯æ´\n`;
                    // åŸ·è¡Œç™¼æ”¾
                    for(let i=0; i<globalCfg.itemCount; i++) {
                        const randomType = globalCfg.allowedTypes[Math.floor(Math.random() * globalCfg.allowedTypes.length)];
                        app.grantItem(p.teamKey, randomType); 
                    }
                });
                
                // [v4.5.3 ä¿®æ”¹] å„ªåŒ–èªéŸ³é«”é©—ï¼š
                // 1. app.toast å‚³å…¥ç¬¬äºŒå€‹åƒæ•¸ '1' ä»£è¡¨éœéŸ³æ¨¡å¼ (åªé¡¯ç¤ºæ–‡å­—ï¼Œä¸è®€å‡ºå…§å®¹)
                app.toast(msg, 1);
                
                // 2. å¦å¤–æ’­æ”¾ä¸€å¥ç°¡çŸ­çš„ç¸½çµèªéŸ³ï¼Œé¿å…åå–®å¤ªé•·ä¸€ç›´å¿µ
                app.speak(`ç™¼æ”¾ç‰©è³‡`);
             
            }, 1500);
        },
    };

    // å•Ÿå‹•
    window.addEventListener('DOMContentLoaded', app.init);
</script>
</body>
</html>